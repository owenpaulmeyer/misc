Implemen 
ting 
the 
lazy 
Spineless 
functional 
languages 
V 
ersion 
T 
agless 
2.5 
G-mac 
on 
hine 
sto 
. 
c 
k 
hardw 
are: 


Departmen 
t 
of 
Computing 
simonp 
Simon 
Science, 
j@dcs.glasgo 
L 
P 
eyton 
Univ 
Jones 
w.ac.uk 
ersit 
y 
of 
Glasgo 
w 
G12 
8QQ 


strictThehigher-orderSpinelessTfunctionalaglessG-maclanguages.hineJuly 
isAbstract 
Thisan9, 
abstractpresen1992 
tationmachineofthedesignedmachinetofallssuppinorttothreenon


parts.non-strictFirstlyfunctional,wegivelanguages.ageneraldiscussionofthedesignissuesinvolvedinimplementing

STGhw
wwpresenisdenotational 
STG 
hinehasde"austerewtherecognisably-functionalop 
Tational 
G-mactics.


whicNext,languageaseellastheat\abstractlanguage 
macmeaning,coanaforell-denedbutSpinelesser 
aglesssemanhine.The

ofanLastlyabstract,wediscussmachinethe
thethemomappingdeldependsofthelargelySTGonlanguagehowecienontotstothisckhardwmappingare.canThebesuccessmade,

thoughofThisdesignthispaptopicerCisistoandappearasrelegatedcinpthetoJournalwaassemhaveofsection.FunctionalOurInstead,Programming.wgivtargetatheCdiscussionlanguage, 
language,language,

treatingthetheissuescompileroftentheahoicesortableeshortmade.bler. principaleedetailedis

designs(Sectionin 
V 
3);proling2.0 
:largematerialnewsectionon11);comparingindex.theSTGmachinewithother

tion5.1);separatingreformulationtheguards2.1 
ofCAF:prophupergovstatementhe(Section
(Section(Sectionapplicabilittofthe10.8);initialynewthestateformatrulesfor(\sucthestatemacthat")hinetransitionfrom

rules,whicdatesernofofh(Sec


lambindingbdaliftingformof(Sectiondefault4.5);alternativdiscussioneinalgebraicofcopy-vs-sharecase 
expressions.10.6;allowavariable


. 
Previouslythelanguagethisminorcoholes,deChanges 
ChangesChangesChangesChangesChangesChangesauxiliaryisgenerationsacessenhangesenying(Sectiontitledtiallyin 
inininininhodenitionsV 
to\ThewV 
VVVVproersion 
ersionersionersionersionersionersionthemainto4.1);cessaSpinelessv
vversion2.5 
oidpapsome2.2 
at(\where")2.4 
2.3 
::spacetheer:::appinpublishedre-orderingnew-formatTmoretro
xedstartaglessendixleaksduction|explicitbugofG-macaddedSectionwithoutSectionininof
ofofprolingthehine:Fig1givingsub-sectionsthediscussion5.
Journal9.blac5,
termaandgorysecondk-holingin\lamotherSectionofdetails.ofin
ininFattempt". theunctionalbSection
SectionSection(Sectionda-formtyptranslation11;Apartos.new4;"Programmi9.3.3).;fromannewsectionovinsubsectiontheerviewtoapptheonng.endix,ofblacSTGVtheeryonk 



Contents

1Introduction 5


2Ov2.12.2erviewI:I:abstractspacemachine::::
:::
:::
:::
::: 6 
6:: 66

32.4Exploring3.12.3SourceTheP
PPPart
artartartrepresenI
IIIthe
thethetheI:languagemappingdesign
designdesigntationandthespaceofcompilationclosuresabstractmacroutehine:
:::on:
:::to:
::::
:::real:
::::
:::hardw:
::::
::::
::::
:::are:
::::
::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
::::997 
77

3.2Functionapplicationandtheevaluationstack 14


43.3The4.13.44.2DataTSummaryClosuresSTGranslatingstructureslanguageand:in:upto:dates:
::the:
:::
::STG:
::::
::::
:::language:
::::
::::
:::::
:::::
:::::
:::::
:::::::
:::::::
:::::::
:::::::
:::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
:::::::
::1916211723


4.34.4StandardGeneratingconstructorsfewerupdatablelambda-forms 2625


54.54.75.1Op5.24.84.6erationalLamArithmeticTheApplicationsRelationshipFullblazinessinitialdaliftingsemanstateand::to::CPSuntics::
:::::
::b
:o:: 
:::xedofcon:::
:::thevv:
:::ersionalues:
:::STG:
::::
::::
::::
::::::
:::language:
::::
:::::::
:::::::
:::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
:::::::
:::3227283034 
343427


5.3let(rec) 
:
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
:::35


5.5expressions
expressionsexpressionserations data

5.4CaseBuiltinopandconstructors 3637


5.6Updating::::::
:::
:::
:::
:::
:::
:::
:::
:::
:::
::2::
::::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
:::38 



6T6.16.26.36.4argetMappingOptimisingCompilingDebugginglanguagethejumpstheSTGtinymacinterpreterhinetoC 414442 
4242

7The7.17.27.47.37.57.6HoAlloOtherTwTTheheapradingwo-spacecationstandard-enclosuresgarbagecodegarbage:
:::
::aresize:
::collectortry:
::represenfor:
:::collectionco:
:::sp:
:::de:
:::eedvarianfor:
:::ted:
:::a: 
::::tsclosure:
:::::::
::::::::
:::::::::::
:::::::::::
:::::::::: :
:::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::::
::::::::::: 45 
454545:::47 
474749 
4949

8Stac8.18.2ksOneTwostac
stacstack?ks:
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::50 
5050::5051


9Compiling9.19.29.39.4TheApplicationscase 
let(rec) 
initialexpressions 
expressionsexpressionsthestateSTG:::
::language:
:::
::: 
:::
::::
::::
:::to:
::::
:::C:
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
:::5253556057


109.5Adding10.1ArithmeticRepresenupdatesting::up:date::
:::
::frames:
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
:::
::6465 
6565

10.210.3PConstructorsartialapplications::::
:::
:::
:::
::::
::::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
::::
:::6668


10.4Vectoredreturns 68


10.5Returningvaluesinregisters 69


10.6Up
UpUpdate
datedateinframesplaceand::
::garbage:
:::
:::
:::
:::
:::
::::
::::
::::
::::
:::3: 
::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
:::::
::::7271
10.7collection 


AA.110.8StatusTheGlobalUpanddetailsupprolingagsdatableclosuresresults 73


11gorydate74


BA.2A.4A.3A.5StacB.1kBlacAddingPLamImplemenerformingstubbingkbda-formholesllerstationup: 
::infodates:
::::
::::: 
:::::
:::::::
:::::::
:::::::
:::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
::::::::
:::::::84838281 
8181818185 
4 



1Introduction

Thechallengesofcompilingnon-strictfunctionallanguageshavegivenrisetoawholestream


of
ofofaresearcso-calledhwork.\abstractGenerallymachine", thediscussionwhichdistilsofthisthewkorkeyhasaspectsbeenoffothecussedcompilationaroundthetechniquedesign


withoutsuchabstract-macbecominghineswampdesignsedinthehavedetailsbeenpresenofsourcetedlanguageinrecentoryears;codeexamplesgeneration.includeQuitetheafewG


macG-machinehine(Augustsson(Burn,Peyton[1987];JonesJohnsson&Robson[1987]),[1988]),TIM(FtheairbairnOregon&WG-macray[1987]),hinechipthe(KieburtzSpineless


&Burn;hineihinevieMcNally&the[1989]),mac(Kingdon,mac

[1987]),the[1991]),CASEthemachGmac(Da&(Augustsson[1989]),JohnssonHDGandhinetheABCLesterhine


(KoEarlyopmanimplemen[1990]).tations,especiallythosebasedongraphreduction,wereradicallydierent


fromcon(Ten[1979])compiler(say)hnology:acompilerthedierencesubstanetweenanSoSKwbinatorasthisimplemen-divergence


tationvurnertionalandtecLispisbtial.greatcom

thatnewelareStoye,hitecturese&NormanereelopedspAsunderstandingtoorthasexecutioneloped,though,model


(Scheevhardw[1986];arcClarkwdev[1984]).ecicallysuppthedev

ithasandeenpgenerateossibletorecognisetcodestoofkmorehitectures.convensystemsemergingfromthe


mist,btoecienfeaturesforcarctional

Inthispapaglesserehine,tnewabstractitthemactextforconenfunctionalcompilerhnologyandthe


SpinelessTwG-macpresenasetinconhineofnon-strictvtionalteclanguages,,

givuneadetailedfeatures: ofitsmappingtostochardwOurdesignexhibitsanb


ofusualdiscussiononkare.umer


programIngivWtionallanguageeenalltakaotherlanguage,epreciseaconsistsconstructdierentheopabstractwhicerationaloftapproachasahsequencehasamacdirectthesemanh:hinestheusualopofticsabstract
abstractabstracterationalmendenotationalusingtionedmac
macmacastateterpretation,abhine
hinehineosemanvtransitione,languageinstructions.thetics.abstractandisInsystem.itselfwaddition,emacgivEacaevhhineeryaninstructionthough,opsmallcoerationaldefunc-foreacisha


Obsemanuniformexaminejectsticsrepresenintagfortheeldstheheap,tationsameonheapblanguagewithothobunevajectscoaluatedusingdetopdecideoinaterstatesusphoin
ininensionswtransitiontheirtotreatrstandthem.system.eld.headWithMannormalyourimplemenrepresenforms,tationshatationvea


wAwhepynevervweerasivcalldoethethis;featuremacinstead,hineoffunctional\tagless". ajumpprogramsismadetoisthethecoconstructiondepointedtoofbdataythestructures,object.Thisandis
theirabpapThetationoutermactra(Phoofveytonhinewarithmetic,ersaltomanipulatesdousingJonesthisbutpattern-matc&ecienLauncitunbistlyhusuallyoxe,burybutdhing.values[1991]).whiddene5paManydirectlyaThisyinlotabstracttheof,isbasedcoessenattendemacgenerator.tialtiononhinethefortoandesignsit.ideasecieninsaatycompanionimplemen-verylittle 



.
ThereistheThetoLamnotimproabstractionbmacdacarriedisvscophinelifting,eexecutioneout.isforisaleftcommonexploitingInstead,spineed.place.thefeaturethewell-suitedfreefruitsofvariablesalmostofforbothparallelofallstrictnesslamfunctional-languagebdaimplemenabstractionsanalysistations,andareimplemensharingalthoughidentied,analysistations,spacebut


comAlmostbinationprevallenthetsprothisindividualducesaspectaparticularly
particularlyparticularlybideaseingdiscussedwedescribfastinimplemenethisarepappresentationer(PteytoninofotherlazyJones,functionalimplemenClacktations,&languages.Salkildbut[1989]).their


Anintroearlierductionversiontothisofone.thisThepapunderlyinger(PeytonmacJoneshine&beingSalkilddescrib[1989]),edishadmostlyasimilarunchanged,titleandbut


thepresentationhasbeencompletelyrewritten.

2Overview

macerationaltstotics,inwiderthreePtext.Iart
artartIexploreshotrothethemacmactowedandwtoesSTGc


Theophinepaperdividessemaninatoandconartparts.IIdiscussesP
PPI
IIinwducestheabstractdesignabstractspacehineisshomapphinehoonthegivstoitsk


hardware.

2.1PartI:thedesignspace

Theimplementationofnon-strictfunctionallanguageshastendedtobedoneinaseparate


wtheseorldttowothatcultures.of\realTothiscompilers". endweidenOnetifygoalsevoferalthiskeypapasperectsistoofahelpcompilerbridge(itstherepresengapbettationween


ofdata
datadatastructures,itsandtreatmenoftheapplication,heeanditsthatothers.of

onstructures),comparetfunctionapproacwtakwithcompilationofcase-analysis


thethatpapyorighellcon

Weresthopeofthethiser.exercisemabeusefulinitswnt,aswassettingthetextfor


2.2PartII:theabstractmachine

Theabstractusualmachinewayof,whicpresenhtingexecutesanevanaluationinstructionmodelstream.forafunctionalTheabstractlanguagemachineistoisdenean 
anan

operationalvaticsusingprogramatotrmacsystem,coandTheompilation ofarecompi-en
enenfor


conertingsemanfunctionalstateinabstractansitionhinede.capplicationrulesthesegiv
givgiv

lationrulesisinusuallyfavofsupercomblambdaliftingfunctions(JohnssonnofreevwhicheliminatesAoexamplebda


abstractionsourprecededybinators,with[1985]),ariables.godlam


ofmacthishineapproaccodeishcalledistheG-coG-macde.hine(Johnsson6[1987];PeytonJones[1987]),whoseabstract 



Thisapproachsuersanannoyingdisadvantage:theabstractmachineisgenerallynotabstract


vWhenFtoabstracttohineehinekholdmanstacytermediateop


enoughalues..orexample,G-codeisthebecompiledG-macnativusesmacthestactode,manyinkerations


cantosimbeulateeliminatedtheopberationyholdingofthe
thetheabstractintermediatestack,valueswhichinisregisters.used,inTheeect,codemainlygeneratortonamehas


intermediateharderalues.manipulateNotonlydoesoptimise.processcomplicatetheco
cocodegenerator,butitmakes


G-codevtoandthis

macToahine,voidwhicthishproblem,ishowoneT-coisdrivdeofenourtoearlierin
inintroducepapexplicitly-nerwasderivameded(PveytonaluesJonesinthe&abstractSalkild


[1989]).WetakeUnfortunatelyaslightlydieren,the
thethetapproacsimplicithyhere.oftheInsteadabstractofdeningmachineaisnewnowabstractlost.machine,weuse


ausualverydenotationalsmallfunctionalsemanlanguage,tics,soittheisSTGinprinciplelanguagepossible,asthetoabstractcheckthemactransformationhinecode.Ithasofthe 
thethe

originalprogramusingstatetothetransitionSTGsystem,iscorrect.hButwehowgivinititdirectbopexecuted.erational


semanticsainlanguagewhicexplainsalsoweetendatoe

ThetheG-macproblemhineof1 
,probecausevingtheonlyenthetireequivsystemalencecorrectoftheistherebdenotationalymadeeasieroperationalthan,forsemanexample,tics


ofhere.asinglelanguageisinvolved.Evenso,itisasubstantialtask,and
andandwedonotattemptit


2.3PartIII:mappingtheabstractmachineontorealhardware

Typicallyco,mandhiswrittenlittleoutoutthecompilationwmapofaabstractfunctionalprogramhinetototheabstractunderlyingma


chinede,ucratherababhotothemaconin

hardwthatare.etthetheabstractcoishinecant.onlybeconsideredasuccessifthismappingorks


well;is,Yresultingmacdeecienw

WconsiderableebelievethatspacethetoSpinelessdiscussingTtheaglessmappingG-macprohinecess.comesOneoutofthewellniceinthisaspectsregard,isthatandavdevarietotey


ofmappingsarepossible,ofincreasingcomplexityandeciency.

Ouritdotargetes,widemacportabilithinecodey.isWtheemaCylanguage.paysomeThisperformancehasbecomepenaltcommonyfornotoflate,generatingconferring,nativase


machinecode,andplantobuildothercodegeneratorswhichdoso.

2.4Sourcelanguageandcompilationroute

WguagesearesucinterestedhasLML,incompilingorHaskell.strWongly-typeexpected,heahigher-orvyuseofder,bothnon-strict,higher-orderpurelyfunctionsfunctionalandlan-the


Thisthefollopapwingerisonlysteps:aboutthebackendofacompiler.Ourcompletecompilationrouteinvolves


non-strict1 
Thetasksemanofprovingticsa(HughessimpleG-mac[1989]).hinecorrectis7carriedoutbyLesterinhisthesis(Lester[1989]). 


1.Thestrict,systematicprimarypurely-functionaloverloading.sourcelanguagelanguage.isHaskHaskellell's(Hudakmainetinnoal.v[1992]),ativefeatureastrongly-tisitssuppyped,ortnon-for


2.latedHasktranslatedmatcellhing.out,istcompiledinyptoecsimpleheckingtocase 
aissmallperformed,expressions,Corelanguageandeacovherloading.ofAllwhicHaskhispresolvell'serformssyned.tacticonlyPattern-matcasugarsingleislevhingtrans-elofis


3.ProgramanalysesandavarietyoftransformationsareappliedtotheCorelanguage.


4.ThisCoretransformationlanguageisistranslatedrathersimple.totheSTGlanguage,whichweintroduceinSection4.
Strictness5.The
TheTheasinternalananalysiscoinputdedatageneratortoplatypaysnativewhicantranslatese-coimphcanortandegenerator.simplythetroleSTGbineprinlanguagetedoutintoasnon-strictCAbstrcode,actbutClanguages,.Thewhichlattercanenablingalsoisjustservtheane


compilermoretot.caseswherethisfunctionhnologytscanfor
forforbepassedlanguagesevgenerateform,deh


isoftendetermineecienUsingtecargumencompilers
compilerscompilerslazyinaluatedcanwhicco


whichisthesometimesoffastasoranalysisthanCpassed(Smetserstheal.dewhicisthereby


Usuallyresultsasstrictnessfasteraretoetco[1991]).generator,h

madeandSTGsignicanlanguagestlymorewithcomplicated.full-edgedunbWoxeedtakvalueseadieren,whichtmakapproacesthemh.WexpressiveextendeenoughtheCoreto


incorporatetrotheresultstounbxedaluesanalysisSectionysimplebutprogramfullincludingWgivtrans-a


briefinductionofovinb4.7,thedetails,transformations.theee


formations&Launchburyrequired[1991]).toexploitstrictness
strictnessstrictnessanalysis,aregiveninaseparatepaper(PeytonJones


Thecodegenerator,whichisthesubjectofthispaper,isthereforenotdirectlyinvolvedin


strictnessanalysisoritsexploitation,sowedonotdiscussitfurther. 
8 



3ExploringP 
art 
theI: 
designExploring 
spacethe 
design 
space 


TheBeforeSTGintromacducinghinehastheitsSTGrootsmacinhinelazyingraphdetailreduction.wepauseIttoisexplorenowfolk-loredesignthat,spacewhileagraphlittle.


reductionongraphreductionlooksverygeneratedierentquitetoconsimilarventionalcodecompilertothosetecforhnology(say),the
thetheLisp.bestIncompilersthissectionbasedwe


attemptytotationsometheaspectsof
ofoftheraftSTGinhinewithmoredesignvtionaleacofh


Animplemencompareisresultaofmacter-related condecisions,encompilers.hwhic


startouryWpresencebaskingThatkquestions,eshndloplacethe


implementationtechniquesforanynon-stricthigher-orderlanguage:

ispartly.
tionw
wwjustieddescription.3.1)?isarefunction
functionfunctionbapplicationthevealues,proceeddataperformedofyvaluestheothers.(Sectionandthreeunevey3.2)?aluatedmakexpressionsitwhichardtohelprepresentoatedcate(Sec-to


ThissectionHo
HoHoHowiscasegivesanalysistheconptexterformedandmotivondataationstructuresformany(Sectionoftheimplemen3.3)?tationtechniques


describedinPartsIIandIII,andsuitableforwardreferencesaregiven.

3.1Therepresentationofclosures

TheensionsheaptainsthunkswkindsHeadofobformshenormalbfurtherforms(orvalues),intas-younevfunction


suspcon(orto).normaljects:adcaneclassiedandtowkinds:etaluated


valuesmighthaandvedataanunevvaluesaluated.Avheadaluemaand/orycontail.tainAthunksvalueinsidewhichit;confortainsexample,nothunksalistinsideCons 
itcellis


calledanormalform.

Itunksisorthvthat,willinaoutolymorphicbalanguage,fromitisnotunksapvistodataalue.


thwwhosenotingalueturnptoefunctionthalwwhoseysossiblealueadistinguishv


Forexample,compose 
considerf 
g 
thex 
. 
compf 
(g 
ositionx) 
function:

Is(g 
x) 
afunctionornot?Itdepends,ofcourse,onthetypeofg 
and,sincecompose 
is


polymorphic,orreasonswhicthishiswillnotbecomestaticallydetermined.teusethetermclosuretorefertobothvand


Fapparenalues

threpresenunks.ted,IntheconremaindertrastingtheofSTGthissectionmachinew
wwwitheconsiderothervdesigns.ariouswaysinwhichclosurescanbe


9 



3.1.1Representingfunctions
Anyimplementationofahigher-orderlanguagemustprovideawaytorepresentafunction


argumenalue.Sucts,htheavaluecomputationbehavesislikpeerformed.asuspendedcomputation:whenthevalueisappliedtoits


alldynamiccompactinstanceswayoftothevalue),ttogetherfunctionwithvalueisvasaluesbloofckitsoffreestaticvariables.code(shared(Suchbya


v
vvThe
TheThealuemost
mostmostiscommonlydirectphysicalcalledrepresen
represenrepresenaclosurtatione,thoughofsucwehuseaclosurethe
thethetermisa
aapinoinaterwidertoasensecontiguousinthisblopapcker.)of


heap-alloby(pointerscatedto)storage,thevaluesconsistingofthefreeofa
aavcariables,odepointerthus:whichpointstothestaticcode,followed


?
Thisistherepresentation-adoptedCodeb?ymanyFreecompiledvariablesLispsystems,bySMLofNewJersey,and


btheytheenvirSpinelessonmentTpointeragless,G-macismadehine.topToinotperformtotheclosure,thecomputation,andthecoadedistinguishedisexecuted.register,Wecall


thisenvironmenoperationtpoinenteringter,andaclosuritsargumene.Thetscobdeysomecanaccessstandarditsfreeargumenvariablest-passingbyosetsconvenfromtionthe(eg


inInsteadregisters,ofstoringonthethestacvk,aluesorinantheactivfreeationvariablesrecord).themselvesintheclosure,itispossible


torepresenstoretationsapointerattempttoablotocsakvof
ofofestorage,freevariables,atorcostevenoftoslowingachaindownofsucaccess.hblocks.TheTheseOrbit


compiler,catingforexample,onstacwratherhardtocinoseheapwhenevptationandclosures,includingblok


allothemtheorkskthanhothethe
thethebestrepresenerossible,forsharingonec


ofinvfreeolved,variablesconsiderable betweenextraseveralcareclosureshastob(Kranzetaken[1988]).inthegarbageApartfromcollectorthecompilertoavoidspacey


leakagerequires.hcanoccurwhenAppaclosuremeasuremenforalargersetofoffreeJerseyariablesthanthatthe
thetheer


itselfwhicIndeed,el'scapturestsSMLNewvsuggestclosureclev


closure-represensoherecommendstationasimpletechniquesatrepresengainlittle,tationand(Apppotenel[1992,tiallyloseChapteralot12]).(inspacecomplexit
complexitcomplexity),


senaInstructionbhineter,takrepresenterestingyp
ppairInsteadointerrepre-and


ThetingThreeclosureyasingleMacpoin(TIM)itesanothertsaclosureinbaosition.ofacodepof

apcoterointoaheap-allocatedoinpairs,ameairbairnesv&WofyfreeTheariablesframe,whicthehisavand


ofoinde-pter/frame-pterfr(Fgivthealuesra[1987]).thevofclosure,ector


maybeerybwinmanlazyclosures.bThesetheycode-poinbduplicatedoinpairsthetoofe


handledsharedvcarefullyeteenaysystem,ecausecannotter/frame-peterwithoutneedriskb


duplicatingtowmorePropvsharingtionalcanmenstillbe10abv(PbutitresultsJonesinLesterasystemremarkChapter


similartheork.conerenonetionedensured,oeeyton&[1992,ably 




4]).

3.1.2Representingthunks
Inanon-strictlanguage,valuesarepassedtofunctionsorstoredindatastructuresinuneval


uatedform,andonlyevaluatedwhentheirvalueisactuallyrequired.Likefunctionvalues,


theseunevaluatedformscaptureasuspendedcomputation,andcanberepresentedbyaclo


sureinthesamewayasafunctionvalue.FollowingtheterminologyofBloss,Hudak&Young


[1988],wecallthisparticularsortofclosureathunk,atermwhichgoesbacktotheearly


Algolimplementationsofcall-by-name(Ingerman[1961]).Whenthevalueofthethunk


required,thethunkisforced.

Athunkcan(inprinciple)berepresentedsimplybyparameter-lessfunctionvalue,but

inecienbyso-calledttolazydoso,implemenbecausetationsitmighastbefolloevaluatedws:whenrepa
aaeatedlythunk.isThisforcedduplicatedforthewrstorktime,isavoideditis 
isititisis

physicallyupdatedwithitsvalue.

ThereThena(ByItsfewfunctionarevmainoptimisations,ethree\reduction"reductiondisadvdenitionmainanstrategiestageismothisbmeanydeltheis
isisthatthetcorrespupforthedatesupadealingthdatereplacemenunkondingthestrategymawithgraphyinstancebtupeafterofuseddatesupandatedeacofbinstanceinyitshthelazywithreductionrighG-macimplement-handanotherofthehine(Pside.)eytonleft-handthtations:(Johnssonunk,JonesApartsosidethe[1987]).[1984]).fromsameofa 
aa

Thecellobwhethercresphecjectonsibilitksmothemadel.itystatusisbyeInevforupaluatedtheag.datedperformingcellIfreporthemonot.eatedlydel,closuretheeacTheup,hisanddatecoclosurealreadydewonetodotheisevforcenotaluated,prococonsidervided(thatdewhicitsis,withhvthisaluegetevaaluatesmotheisstatusextracted;delvaluefurther.agofto)unk.otherwiseaindicateclosureThe


Thetheinself-up
self-upself-uptosuspthedating
datingdatingendedcell,andmocomputationmodelthedel,insteadstatuswhicplacesisaghpiserformedisusedthisippbrespedy(bthe(Bloss,onsibilityenSTGteringHudakymaconthehine.the&closure),coYTheoungdeinsidecell[1988]).themothe
thethevaluedelth
ththplacesunkiswrittenitself.


Thecodetoforceaclosuresimplypushesacontinuationonthestackandentersthe 
thethe

closure;iftheclosureisaunk,itarrangesforanupdatetobeperformedwhen

evaluationiscomplete,otherwiseitjustreturnsitsvalue.Notestsneedbeerformed.

Theupdateoverwritestheth
ththunkwithavalue,whichthereforemustalsohaveacode

pointer,becausesubsequentforceswillre-enterthethunk-turned-value.Thisrepresen


simply2 
IntationatorolegetherSectionreturn.surprisefromofiswith3.3the
thethenaturalwforagethelistexploredataintcellwforcellovvalues.simplypfunctionarianoinmoterstsdel.Aofreturnscomprisinglistthisvalues,cell,scheme,immediatelyasfor11wintheeexample,whichaheadvhe2 
thealready.andIniscorepresendeeect,tailfordiscussed,ofathe
thethelisttedcellcolist.bdeybutdoaThepescooinisratherdesomethingtercop
ppdeoinplamorepteroinysthantedtheto-of 



TheuatedlatterBloss,ab(orovthee,twHudakoecauserevmoerse),dels&iteacYbisoungecausehbasedoer[1988]onscopatestcalletranslationforthisonoptimisation.themoagdelinto\closurecanLisp.Considerbeomittedmode", the(Bloss,butcellthemoHudakdel,implemenfor&example.Ytationoung


Forcingtheycansuggestb
bbeoptimisedisveryifmtheuchcompilerlesseciencantpro(inveboththattimethandunkspace)iscertainlythanthatalreadyoutlinedeval


[1988]).Furthermore,ifthecompilercanprovethattherecanbenosubsequentcodeforces


onthethunk,thenitcanomitcodewhichperforms

Asimilarsituationholdsforthe
thethetheself-updatingmodel.Ifthecompilercanprovethata


particularthunkcanonlybeevaluatedatmostonce(whichweexpecttobquitecommon),


itcancreatecodeforthethunkwhichdoesn'tperformthe
thethetheup
upupdate.
date.date.Unlike
eethecellmodel,


theself-updatingmodelcannottakeadvantageoforder-of-evaluationanalyses.

3.1.3Auniformrepresentationforclosures
Asindicatedabove,theself-updatingmodelstronglysuggeststhateveryheap-allocatedobject


(whetheraheadnormalformorathunk)isrepresenteduniformly,byacodepointertogether


withzeroormoreeldswhichgivethevaluesofthefreevariables thecode.TheSTG


machineadoptswherethisheapvaluesrepresenrepresenascanuniformlybeseenythecoerationaltogetherwithticsa


(Section5),alluniformaretation,tedbinsomeopdeseman


sequenceofvalues.Indeedthisiswhythemachineiscalled\tagless":sinceallobjectshave


thesameformthereisnoneedforatagtodistinguishonekindof
ofofobjectfromanother


(contrastthepresentationinPeytonJones[1987,Chapter10]).Weusetheterm\closure"


torefertobothvaluesandthunksbecauseoftheiruniformrepresentation.

Thedecisiontouseauniformrepresentationforallclosureshasotherinterestingramications,


whichweexploreinthissection.

Firstly,whenaunkisupdatedwithitsvalue,itispossiblethatthevaluewilltakemore


spacethantheth
ththunk.Inthiscase,thethunkmustbeupdatedwithanindirectiontothe


value(Figure1).Thiscausesnodicultyfortheself-updatingmodel,because

can
cancanbreadilyerepresenberemotedbvyedaclosureduringgarbagewhosecocollectiondesimply(Sectionentersthe7.3).targetclosure.Suchindirections 
indirectionsindirections

Inthecellmodel,eitherasecondtestmustbemadetocheckforindirections,oralternatively


everyupdatedthunkmustbeanindirection.(Figure2showsthelattercase.)Bothmethods


imposeoverhead.

SecondlyWhenponmessagehelpfuloin,itself.ter.theatothIfcanself-upItthe
thetheunkfollobeprogrammer.thisdatingdisplawsunkentered,thatisyed.moevtheerdelitsWithoutre-enprogramcoalsodeteredpalloointhishaswsterb12eforemecotherencanteredhanismitbeisexceptionaloanupverwrittenstacdated,innitekovthenerocaseslowithop,witstooandaccurs,v\blacaluebeataksuitablemk-hole"whicustenhdepcareiserrorcoendlessdeof


withoutextra
extraextratests.Forexample, 


Incanoverwrittenab---??-??Afterupdating(bigvalue)IndirectioncodeValue ConscodeHeadTailAfterupdating(smallvalue)CodeFreevarsBeforeupdatingFigure1:Upconcurrenarstdatingcocompleted,thintptheself-upter.datingexecution,unkisunkmoenthreadsuspupdelsystemwhichsupportsthreadsofeusedbofexactlyitstriesendedthetosynchronisethreads.Whenathtered,Ifthecodetowith\queue-me"deoinanothereforethreadhastheformerisandthreadsattachedtotheunk.Whenthethisdated,thesameevaluatepoinmethotertheisd
thqueuearep
ppInbforeoin
oinoinunkatreatedremote-nessre-enabled.terterssystemcanneeddierenbwithebewhenevrepresenpdistributederformed.tlytoertedlodereferencingcalasmemorypaoinspters.ecial,paoinHokindpointerswter!evofer,toindirection,Inremoteitthewouldself-upmemorybeanddatingverynounitsexptestsmoqueuedensivoftendel,addedforeathreadsharemote 
remoteremotetovtoetesttoa


0 
Beforeupdating??After1 
updating-Value


-CoFigureFdereevars2:Updating13inthecellmodel 


3.2Function andtheevaluationstack

Higher-orderlanguages,whichallowfunctionsas\rst-classcitizens", presentinteresting


cishallengestoaskhoforwfunctionthecompiler-writer.application
applicationapplicationisAnperformed.illuminatingwayofcomparingcompilationstrategies


3.2.1Currying
Thelanguagesinwhichweareinterestedmakeheavyuseofcurriedfunctions.Forexample,


considerthefollowingHaskell denition:

f 
isattributedf 
x 
y 
the. 
x 
typea 
-. 
(b 
-. 
a) 
.Thatis,f 
maybethoughtofasafunctionofone


argumensa(f 
t,2) 
hisreturnsforawhic2) 
AntakthesecondofargumentoargumenAnisperfectlyof


f 
,y1 
whic,shortfunction
functionfunction((f 
.happlicationesf 
onet.applicationt


acceptable;Instrictlanguagesf 
for(x,y) 
examplelik. 
ex 
Lisp,(map 
Hop(f 
e1) 
1)1)andxs) 
SML,.thedenitionoff 
wouldusuallybeoftheform


whereelementsf 
isofattributedtypea 
andtheb 
.)tTheypefunction(a,b) 
-. 
f 
cana 
.(Wonlyeusebeapplied(a,b) 
to
totodenoteasuitablethepair,typeandofpairscannotof


beappliedtojustoneargument.

Intheyallwofouldthesehardlylanguagesdeservitiseptheossibletitle(and,\higher-order"), inSML,easy)buttodenecompilerscurriedusuallyfunctionsimplemen(otherwiset


uncurriederseformtraditionucmorenon-stricttlyandprogrammerslanguages,respaccordinglytheThereexibilithe 
thethey


invculturalmhinecien,functionalwhereondadditional.ist


allotypicallywedbytreatthecurried
curriedcurriedformapplicationmeansasthatfundamenitisusuallytal.preferredbyprogrammers,andcompilers


3.2.2Compilingfunctionapplication
CompilersfromtheLisptraditionusuallycompile applicationasfollows:evaluate


theknownfunction,functionevaluateisbeingtheappliedargumen(ast,isandoftenapplythethecase,especiallyvaluetoLisp),theargumenthe\evt.aluateWhena


function"applymodelpart,isbinecomesvariablytrivial.usedbyThiscompilersmodelfor
forforstrictlanguagesapplication,(egLisp,whicHophwe,eSMLcalltheandeval-the 
thethe

SECDmac(HendersonexceptofLandinonly[1965])).Itisalsoisaluatedin
ininsomebeforeimplemenapplicationof


non-strictlanguages,hine[1980];thatcoursefunction
functionfunctionfunctionfunctionusedevthetations


(egtheABCmachine(Koopman[1990]), the
thetheh;Gi-machine(Augustsson&Johnsson


[1989])).

Inconthecompilerstanbasedaluationonlazygraphk,tail-calltreatentertheapplicationThereasfollono


pushtrast,argumenonevstacand
andandreduction(orfunction)function.isws:


\return"whenbthetheevhine,ofandfunctionSTG14iscomplete.hine.ethispush-enterdel;


itisusedyG-macaluationTIM,thethemacWcallthemo



Thedierencebetweenthetwomodelsseemsratherslight,butithasapervasiveeect.Itis


dicult sayingeneralwhichofthetwois\better". Inessentiallyrst-orderprogramsthey


generatemuchsamecode.Forprogramswhichmakeextensiveuseofcurriedfunctions


thepush-enapply3 
termof 
delx 
loy 
oksz 
. 
better.f 
x 
y 
Forz 
example,considerthe(curried)functiondenition


ALisp-likecompilerwouldbecompelledtoevaluate(f 
x) 
,thenevaluatethatfunction


appliedy 
to
totoz 
y 
,tonallyevapplystacresultbeforejumpingz 
.Agraph-reductionthecompilerfor.ouldjustpush


x 
,andonthe
thethealuationthektotoclosuref 
w

3.2.3Theevaluationstack
Themaincostofthepush-entermodeloffunctionapplicationisthatthelinkbetweena


functionbodyand
andandanactivationframeisbroken.Forexample,considerapply3 
again.Inthe


eval-applymodelthecompilercanallocateanactivationframeforapply3 
whichisdeallocated


whenthevalueof(f 
x 
y 
z) 
hasbeencomputed.Inthepush-entermodel,allthathappens


isthatthreemoreargumentsarepushedontheevaluationstackbeforejumpingtof 
.Toput


itanotherway,therearenoidentiablemomentsatwhichanewactivationframeshouldbe


allocatedorreclaimed.

Thispushesthepush-enterevaluationmodelinthedirectionofhavingacontiguousevaluation


stack,ratherthanalinkedlistofheap-allocatedactivationframes,asexempliedbytheNew


JerseySMLcompiler(Appel&Jim[1989]).Theideaofheap-allocatedactivationframesis


veryappealing,becauseitmakesiteasytoimplementcall/cc 
(Appel&Jim[1989]),parallel


threads(Cooper&Morrisett[1990]) certaindebuggingmechanisms(Tolmach&Appel


[1990]).Butallthesethingscanbedonebyallocatingacon stackinmedium-sized


chunksintheheap,atthepriceofalittleextracomplication(Hieb,Dybvig&Bruggeman


[1990];PeytonJones&Salkild[1989]).

Indeed,performancemaywellbebetterusingacontiguousstackbecauseoftheimproved


spatiallocality,whichreducespagingand
andandcachemisses.Contiguous 
tiguoustiguous cationoffreshactiva


tionrecordsispessimalforcaches,sincetheyhavetobothfetchuselessdata(sincetheyare


notcleverenoughtoknowthatitisfreespacewhichisabouttobeallo
alloallocated)andthenwrite


backanactivationframetomainmemorywhichisquitelikelytobegarbagealready.Unless


oneacheusesusinggenerationalcongarbagestaccollection,iselyandhaeyoungestbcacationptsentir(Appwithin[1992,


c,atiguouskliktothevfarettergenerheerformanceelyelthe


Chapter15];Wilson,Lam&Moher[1992]).Currentcachesizesarestilltoosmalltocontain


acompletegeneration,butthatmaychange.Itwouldbeveryinterestingtoquantifythese


eects.

Theh;Gi-machineisanotherinterestingdesigncompromise(Augustsson&Johnsson[1989]).


Hereeryagain,closurethere(whicishnotheconh;tiguousGi-machineevaluationcallsastacframe),k.Instead,andwclosuresorkingspaceunderisevaluationallocatedarein


linkedtogetheruchasheap-allocatedactivationframesare.Thepenaltiesare:spaceusage


isworse,becauseallclosurescontaintheextraspaceregardlessofwhethertheyarebeing


ev
evevaluatedornot(andmostarenot);whena15functionisevaluatedtoapartialapplication,


theargumentsm
mmustbecopiedfromthefunction'sframetothe
thetheapplication'sframe;anditis 



notalwayspossiblestaticallytoboundtheamountofworkingspace (unlessseparate


compilationcaseswheretoisoabandoned),littlehasbeensoanalloexception-ccated. heckingmechanismisrequired
requiredrequiredtodealwiththe


3.3Datastructures

Strongly-typedfunctionallanguagessuchasHaskellencouragetheprogrammertodenemany


algebraic(astees.seeentheSectionbuilt-inintesmaofthebregardedsucalgebraicaslists,boleans,tes.


tuplesandwypwillEvin4.7)datategers,ypyelanguage,ashdataoyp


Here,forexample,arerepresentativetypedeclarationsforsomeofthem:

(Specialsyndata 
datadatadatadatadatadatataxBoolean 
List 
Tuple3 
Int 
Tree 
forlists. 
a 
a 
MkInt 
. 
a 
. 
and. 
Nil 
Leaf 
b 
False 
c 
tuplesInt# 
| 
. 
a 
Cons 
MkTuple3 
| 
| 
isTrue 
Branch 
proa 
vided(List 
a 
(Tree 
b 
bya) 
c 
mosta) 
high-lev(Tree 
a) 
ellanguages,butnotbythe


STGBranch 
language.),andcase 
takent 
Dataof 
apLeaf 
Branch 
artvaluesusingn 
t1 
arecase 
t2 
built-. 
->->expressions.e1 
e2 
usingconstructors,Forexample:suchasFalse 
,Cons 
,MkTuple3 
,


(Inpattern-matcahigh-levhingelprogrammingconstructs,butlanguage,itsiswdataellknovalueswnhoarewusuallytotranslatetakensucaparthconstructsusingvariousinto


case 
translationexpressionshasbeenwithperformed.)simplesingle-levelpatterns(Wadler[1987]).Wehereassumethatthis


thattheyeconstructionattenpatternCompilershingervimplemenefunctionalt

Theseoperationsdeservofparticularandtion.matcsometimesaresopasivintthebuilt-inprogramsypes


(list,tuples,yumers)intypspes.eciale\magic"ewviewaandthe
thethemechanismspaausedperformanceforuser


penaltfornbWtaktheys,thatgeneralprogrammerys

denedhasnouser-de.ned
user-deneduser-denedtypesshouldtypbees,madesothisecienquestiontenoughdoestonotusearise.)forbuilt-intypestoo.(Lisp,ofcourse,


Wehavealreadydiscussedtherepresentationofdatavalues,asacodepointertogetherwith


zeroitorthatconcase 
andtselds.itWctsreallynoturnappropriateeswattenthings:toevaluatese.compilationofcase 
whosealue


Noticescrutinises,moreatenthenexpressionseleethewdoourtoalternativtionittheexpressionexpressions.v


Ifthecellmodelisused,thecase 
expressionmustrstforcethe
thethevaluetobescrutinised.


ThenalternativcontainFitrelevorceametagustofthetinspthedatavalue.ectcase 
ttheanaturale.expressionvaluethetondiscoshouldber)verwhic
whicwhicbofeh16executed.hdistinguishesenconstructoris:Itfollofromitwsisbuilteacthathwith,othereachanddatatheconstructorshencevaluewhicmusth


ofthean(usuallyypSoumsequenceevts


Extractitstag.

Inthe.
TExecuteBindcaseaketheofmthe
thetheulti-wnamescoself-updeayinforjumpthedatingpatternbasedalternativmodel,onofthe
thethethough,e.tagalternativ3 
thereetoarethemorecomppossibilitieonentsofs.theRecalldatathatvalue.in


thismoevassumedclosureisforcedthe
thetheydeteringait,rgarlessofwhetherareturnshasefore.bothere.So


farwhadelethatbcoenforedalwysitimmediatelybencdButefor

vsoarianthattsthearetagpossible.doesnotItneedcould,toforberepresenexample,tedloadexplicitlythetagatinallto(Sectionaregister9.4.3).beforeBetterreturning,still,


insteadmemberofofreturninga
aaavectoroftoreturnamulti-waddressesayjump,|theweconstructor
constructorconstructorcallthisavecoctordeecoulddreturnreturn(Sectiontothe9.4.3).appropriateThese


returnconventionscanbechosenonindependentlyforeachdatatype.

Inadataeect,valuetheisself-uponlydatingeverforcedmodelbusedyacase 
bytheexpression.STGmachineThistakpropesertadvyanistageuniqueofthetothefactSTGthat


macteshine.yimplemenlazybtheastationsarithmeticdatatreatypnerations.anddataforcedyptheasamacspcase 
case,n4.7).hdata


implicitlypareOtherforcedytedimplemenbuilt-inalgebraictopes,umericonlyIntesSTGusingecialhine,(Sectionumericwhicare


Theideacancase 
be(f 
takx) 
Nil 
enof 
onestepfurther.e1 
Considertheexpression

andinasuppheap-alloosethatcated(f 
Cons 
ConsConsx) 
eva 
cell,aluatesas 
the-. 
->->toe2 
compaCons 
onen.tsTheofcellwhicmohwdelouldwouldbeusedevaluateine2 
(f 
.Butx) 
,resultingsuppose


thatCons 
wcelleuseintheregistersself-upbdatingeforereturningmodel,and(asthatwelltheasloadingcodefortheCons 
tagputsintothearegister,headandifthetailreturnofthe


isfunctionsnotvectored).returndataThenvaluestheCons 
thisoptimisationcellneedneverseemsbealquitelocatevdaluable.intheheapatall!Sincemany


Inunpacsummarykingperformed,thecellbmoyadelcase 
separatesexpression.theTheforcingself-upofadatingthunkmofromdelallothewscasetheseanalysisoperationsand


tobthesewvtogether,dohseemstooerupinasoppeortunitiesseeforwrollourTbes


fair,eoenoptimisationswhiccomplicatedating,terestingwwillwhenoptimisations.eupsleevoe


inPartIII,sothebenetisnotentirelywithoutcost(Section10).

3.4Summary

ThesinglemostpervasivedesigndecisionintheSTGmachineisthateachclosure(including


data3 
Irelandvalues)[1992]isrepresencleverlyatedvoidsuniformlytheforcing,andstepscrutinisedwhenitisnotonlynecessarybyen,teringbyusingit.theThesamebenetseldtoincludeencode


the
thethetheevmcaseulti-waluationwhereayjump.statusanunevagaluatedandconstructorthunkorindirectiontag.Thecase 
is17encounexpression'stered:itmforcesulti-watheyjumpthunkhasandanthenextrare-executesbranchfor 



Cheapindirections available(andareusefulwhenperformingupdates).Theycost

What.
tion.OtherwAnothinganddataareavyariet.returningthevaluesexceptionalywhencosts?ofmareturntheytheyThenotconditionscompconare
arearebmainevnotenalloonentionsonepresencatedts(blacseemsforoft,inktheconstructorsandholes,toconstructorcanheapbeconcurrencythis:
beateliminatedareall.ininpossible,theregisters.,etc)commoneasilycanincludingbTheduringecasehandledlattervwhenectoredgarbagemeansinathepreturns,ossiblecollec-samethat


thunktheturnsoutandbealreadytoreturn,aluated,whilecellself-updatingdelesdelonees(conditional)wjumps,onejump.to


enterclosuretooneevthe
thethethemotakmoonlytakto

(AsWorse,wehatheverstseen,jumpthough,istoaanjumpunknocanwnoftendestination,besavedagainwhichbmeansyusingthatavectoredthecodereturn.)generator


cannotunkkthingsunevinregisters.Evso,ThecellcelldeldelmaincursyalwtheseysconIftherehingarecostswoorif


thetheepisaluated. enthemomoonlynotawin.text-switct

morerestoringforcestheinconarotext,wtherediscoisvtheeringnasttheypsecondossibilitthyunkofsaisvingunevthealuated,context,andevaluatingsavingonethunk,


forafortime.atInthisstartsortaofofitasyellself-upbejustasgoomotomvthe
thethedo.text 
texttext

onceandsecondalltheofstringsituationforces,mawthedatingddelsaustecon
concon

Therearealsosomeunderlyingarchitecturalissues.Firstly,indirectjumpsaremorelikely


tocauseoptimisedhemissestakingthanonditionalen)conditional(emploedjumps.ythecellmodel),,modernRISCsforare


wellcacforc(not-takjumpsybSecondlybutnottaking


addressindirinterpretsectjumpsisthefetchedindirect(whicahfewarejumpinstructionsneededdirectlybythe,bnoeforeself-uppipelinethedatingjumpbubblesmoitself,del).needandInbprinciple,ethecaused.instructionifMostthejumpfetcRISCshlogicare


nottobe(yprefetcet)optimisedhedintoforaregister,thissequence,andtherebbuttheysuppTeraortsarczero-delahitectureyis:indirectitallobrancwsabranches(Alvhtarget 
targettargeterson


etal.[1990]).

Inshort,tybutaenavaclosureywhenotherenetseneeditsnoalue,ecost.yasingle,themoenets


up-froncostbalwysgetteringwidearietofwbatvfurtherwpaWhetherfairlybdest,


outweighthecostsisatpresentanopenquestion.

18 



4The


functionalThe
TheTheCerydeabstractthe


co(Field


evFdistinguishing(eg


expressedisexactly


following

ThesalienAstrainaddingop(eitherItAaroundllllis


iseasilyofNoticePattern.


Therestriction,whosewTherrestrictedould
functional-languagecorrespasthis&language,STG\enricaHarrisonmacpropstateondencehinehedfeatureertlanguageP 
transitioncalledConstructFy[1988]),
art 
unctionlamcowhicbdecompilerbofetthedahwforI 
theeenKidI: 
system,justiescalculus"STGtheSTGtheThe 
(AriolausesSpinelesslanguage,STGlanguageasthea(Psmallwabstract 
&titleeytonelllanguageArvindasTpurely-functionalwhoseOpTis\abstractaglessailtheJonesthaterationalcall[1991])).usualandsynG-macit[1987]),hastaxopmac 
macdenotationalerationalreadingaishinehineformalFLICgivlanguagehine 
isencoade". matters(PinopvsemaneytonerFigureeryasationalInanaustereparticular,istics.Jonesin3.main
functionttcharacteristicsbcorrespyconstructingandondsLetCaseConstructorconstructortoofexpression 
expressionexpressionatheSTGclosureopapplication 
applicationapplicationcoarerationaldegumentsorarebyasevrealitfolloaraluatingHeapEvReturnealuationws:simpleythatallotothem)cationcontinvariablesfunctionprioruationorargumentotheconstants.call.tsare


expressionssaturatederational-reduction.ceveasyonstructorsaluebbisgeneralthat,newaneematchingatranslatedunnecessarilytoun-saturatedtoscrutinisedspareandlet 
seman(thatinsatisfyebcialformaesimplesomehigher-orderbindingsaandis,ticsformissimpleisthisingivpbuilt-intobperformeone-levofyerformanceconstructorbuiltesfofconditionthisafor
. 
STGtovbinding.case 
ariable{ 
andnon-triviallanguage,theformvelopd1 
;
copatterns.eronly
:
functionexpressionthen:
de.ationswhen
(W:orwor
;Thevouldbyadlern 
built-inconstanimmediatelyIt} 
w
19 
argumentranslatingecase 
arSTG\ 
isMoreexactlycannotb
e[1987]).ecaneasily{ 
saturlostxapplication,
t.exprlanguage1 
complex
;bts. :
ensureNothingtheebate
:
essions,arranged
:ecauseanev;
ind.
xnaluated.
tom 
umarbitrary} 
thatformshasThisthebth
-. 
waerouldusandabclosureSTGeveryeofyconstrainofsppaddingerformingargumenexpression,ecialpattern-matctheblanguage,functioneforgainedpatternsformtextrathetssimpliestheitofb


termediatesemanVirtuallyIndeed[1988]),purely-tics,it


tained:the

simplyThispreparedopplamositebcon-dastheby


applicationexphinginects).case 
can


expressionandybinding,sucishnota 



Program bindsprogvarbinds1 
. 
lf1 
; 
:::; 
varn 
. 
lfn1

Bindings n 


Lambda-forms lfvarsf 
\ 
varsa 
-. 
expr

UpExpressiondateagexpr!
!!!!!ju 
n 
let 
varcliterprimletrec 
case 
onstralbindsexpratoms 
atomsatomsatomsbindsin 
of 
expraltsin 
expr UpNotLo
LoLoApplicationSaturated
SaturatedSaturatedCasecal
calcaldatableupexpressiondenitionrecursiondatablebuilt-inconstructorop


Alternativesaltsj
jjjjjjjaaltpalt1 
11; 
;;:
:::
:::
::; 
;;paaltaltn 
nn; 
;;default 
defaultdefaultn
nn.
0
00(Algebraic)(Primitive)

AlgebraicDefaultalteaaltplitervaronstr-. 
-. 
exprexpr-. 
expr

Primitivalt 
altaltdefaultaltcalvars

Literals literal!
!!!!!jdefault 
0# 
j1# 
j-. 
:::expr eintegers

Primitiveopsprimj
jj:
::+# 
:
::: 
::j-# 
j*# 
j/# 
Primitiv
PrimitivPrimitiveintegerops


Variabletomlistslistsatomsatomvars!
!!!!Figure{ 
{{var
varvaratomj, 
liter3:, 
:::alSyn:, 
, 
taxn 
ofn 
the} 
STGn
nnlanguage.
0 
00

A1 
1 
::varatom} 


20 


Ithastworeadings.Fromadenotationalpointofview, freevariablesv1 
;::;vn 
and

upFromdateanagoperationalareignored,pointandofview,denitionfisboundbindstoaheap-alloftothe
thethefunctioncatedclosure,(x1 
:con::
::xtainingm 
:e).


cofunctiondepoin(terx1 
and:::x(pm 
:oine);terswhento)itsthe 
thethecodeisvariablesexecuted,v1 
;a::sp:;vecialn 
.Thisregisterclosurewillrepresenpointtotsthe 
thethe

lam
lamlamb
bbda
dadaabstraction.liftingneedbNotice,eperformedthough,(Sectionthatthe4.5).abstractioncanhavefreevariables,sono

AbindingsSTGvclosureitit)tionThe
TheTheThealueprogramreacisare4.7.ofSTGrighup
upuphesdatecalledantherebdatablet-handitsSTGlanguageisagnormaljustyglobifgivingprogramonsideitsalsaacollectionsupp,uplamformofwhileaccessdateabortsisda-form(Sectionbindingtheallagtounbofothervitsbindings.alueisoxeindicatesisu 
4.2).free
freefree,dcalledvofandariablesvalues.vtheWariables.non-upTheewhetherglobalasalambybThisvaariablesounddatablelammain 
da-formitsaspbinda-formclosure.ectotherwise.denedthe
,isandprogramdiscussedshould(orbisyathistheclosurebareeonlytop-levupbelocalleddatedbuiltwsiteelinlosetwhenforfromcSec-alsofa 
aa.


associatesconcretetosynthetaxleftwandeusebindsisconmoreventional:tightlyparenthanthesesanyotherareusedoperator;todisamthebiguate;bodyofapplicationalambda


abstractionclear,wealloextendswourselvasesfartotoomitthesemicolonsrightaspossible;betweenand,bindingswheretheandlacaseyoutalternativmakesthees.meaning


The
TheTheTheSTGinlanguageis4.8.insomewysto\continst(CPS),apte


returntoSectionsimilarauation-passingyle"oinw


4.1TranslatingintotheSTGlanguage

Ineginthissectionanexample,woutlinetheell-knototranslatewnfunctionafunctional.programdenition,totheconSTGenlanguage.notationW


bwithehow
wwmap 
Itsininvtionale


(egHaskmap 
mapmapell),f 
ff[] 
(y:ys) 
isasfollo. 
==ws:[] 
(f 
y) 
: 
(map 
f 
ys) 


Thecorrespmap 
. 
onding{} 
\n 
case 
Nil 
{f,xs} 
STGxs 
{} 
bindingof 
-. 
isthis:Nil 
{} 


NoticetheattenedCons 
structure,{y,ys} 
the-. 
->->explicitlet 
in 
Cons 
mfy 
fy 
argumen. 
. 
{fy,mfy} 
{f,y} 
{f,ys} 
tlists\u 
\u 
{} 
for{} 
ev-. 
ery-. 
f 
call,map 
{y} 
and{f,ys} 
thefree-variable


listsconsideredanduptodatebeaagsfreeonvariableeachlamofthebda-form.lambda-form21Sinceformap 
mfy 
itself.isaglobalconstantitisnot 



Inthisexample,everylambda-form eithernoargumentsornofreevariables.Toillustrate


thetwmap1 
oinf 
com. 
bination,mf 
where 
consider[] 
the. 
follo[] 
wingalternativedenitionformap 
:

Heremap1 
the. 
recursion{} 
letrec 
mf 
\n 
. 
{f} 
{f,mf} 
case 
isNil 
o-. 
verxs 
{} 
mf 
\n 
of 
,mf 
mfmf-. 
{xs} 
whic(y:ys) 
Nil 
h-. 
has
hashas{} 
free. 
(f 
variabley) 
: 
(mf 
f 
.Theys) 
correspondingSTGbindingis:


Here,ismf 
freein 
anariablemf 
exampleCons 
itsofa{y,ys} 
wnlamda-formt-hand-. 
let 
in 
Cons 
mfy 
fy 
b(see. 
. 
{fy,mfy} 
{f,y} 
{mf,ys} 
free\u 
ariables4.5).{} 
\u 
{} 
-. 
andf 
-. 
argumen{y} 
mf 
{ys} 
Notice

mf 
aisvoforighbwithsideothSectionvts.that


4.1.1Thegeneraltransformation
Ingeneral,ReplaceTheaSaturatefunctionsemantranslationbinaryallticstoconstructorsallisapplicationstillthein(to:a:
thatthev:((ailablefandSTGofeb1 
curriedy)built-inargumenemlanguage2 
ultiple)::application,:)optseapplication.n 
erations,inatvolvonce,=)esofthebrathercourse,fyffolloe-expansion1 
;thanewingbut2 
;::thedoing:transformations:;en 
ifSTGgnecessarysomaconehineby.Thatone.appliesis


.
Nameeverynon-atomiccwherefe1 
;:c::is;efunctionan 
gbuilt-in=)argumenorconstructory1 
:t,::andym 
:evcwithferye1 
;lam:arit::;byedan 
n;yabstraction,+1 
;m::):;ym 
gbyintroduc


4.1.2ingConvariableIdenavertlet 
tifyingandtheexpression:righupdate-agthet-handfreesideinformation.ariablesofeachlet 
bindingintoalambda-form,byaddingfreeThetransformationtoSTGcoderequiresthefreevariablesofeachlambda
-formtobeiden


tied.ifTheruleisasfollows:av
vvariablemustapp22earinthefreevariablelistofalambda-form 



1.2.mentionedinbyblamodybda,ofandlambdaabstraction,and
Th3.us,it
itititinis
isisisthenot
notnotrstb
bbound
oundoundversionatthe
thethetheoftopmap 
levinelthe
thetheofthepreviousprogram.section,map 
doesnotappearinthefree


vofariablemap 
,mf 
listisofafreemfy 
vbariableecauseitofisbothaglobalitselfconstanandmfy 
t..Ontheotherhand,inthesecondversion


Thefree-vf 
Haskx 
y 
. 
rulewhere 
fbody 
denitionhandlesmrecursionwithoutanfurthercomplications.Fex


ample,theariableellutualyor

wouldtransformf 
. 
{} 
to\n 
g1 
g2 
the{x,y} 
b 
a 
STG. 
. 
...b...g1...y... 
...a...g2...x... 
-. 
denition:letrec 
in 
g1 
g2 
. 
=={g2,x} 
{g1,y} 
\n 
\n\n{a} 
{b} 
-. 
->->...a...g2...x... 
...b...g1...y... 


The
TheThecourse,ruleletrec 
anabyoin-scopbuildsvesayseawhenvpairariableofavclosures,ariablemayfbody 
appmusteacearhapp(redundanofwhicearinhpatly);oinfree-vtssurprisinglytoariabletheother.list,thereofalamisboneda-form.situationOf


inwhichsuchredundantfreevariablesproveuseful|seeSection4.4.

4.2Closuresandupdates

IntheSTGlanguage,let(rec) 
expressionsbindvariablestolambda-forms.Twopiecesof


denotationallyalistofredundanfreevtariablesbutoperationallythelambsignicantandanupareagattac.Inhedthistosectionalambda-we


form:theofda-form,informationdate

foUpcusdatesontheareupandateexpensivag.efeatureoflazyevaluation,wherebytheclosurerepresentingan


unevaluatedTheexpressionisisaupoiddatedaluating(head)particularformmorewhenitonce.ev(Sec


tion3.1.2).aimtovevitsanormalclosurethanisaluated

InSpinelesscontrastTaglesstotheG-mac
G-macG-machinehine,isablewhichtopdecideerformsonanaclosurupdatee-by-closurafteralmostebasiseverywhetherreduction,updatingthe


isuprequired.datedecision(Itsharesisconthistrolledpropbyerttheywith
withwithupdateTIMagandonthealamSpinelessbda-form:G-macifhine.)theupdateTheupagdate/no-is\u 
", 


theitcorresp\n 
"noondingupdateclosurewillbewillperformed.beupdatedwithitsheadnormalformifitiseverevaluated;if


Itis
isisclearlysafetosettheupdateagofev23erylambda-formtou 
,therebyupdatingevery 



closure.Butwecandomuchbetterthanthis.Theobviousquestionis:towhichlambda


formsWeexplorecanwethissafelyquestionassignbanyclassifyingupdateaglamof\bn 
da-forms",withoutlosingtodistinctthesingle-evclasses:aluationproperty.


ManifestFManifestorexample,functions.functionsmap 
Aanddomanifestmf 
notarerequirefunctionupisdatingfunctionsalamb
bbecausein
ininthetheyexampleswithareanon-emptalreadyofthepreviousyinargumenheadsection.normaltlist.


manifestnotrequirefunctions,updating.partial
partialpartialBothapplicationsmanifest
manifestmanifestmanifestfunctionsarealreadyandinpartialheadnormalapplicationsform,andareofhencecoursedo

Partialform.wherefunctionPresultOnlyartialapplications.
lamoffapplicationsvpisbalues.erformingda-formsknownAtoinupsometimesbpreciselydateseaapplication
(Sectionvsappthe\n 
earfgformfunction5.6).-. 
directlylamgivfbfenda-form
da-formda-formx1 
taking;abin::o:
programs,;vxeism 
morearegoftheclassiedthanbutformmtheyasargumenpartialalsoarisets.applica-Likasae


Constructors.tions.isTherethenotclosureisFclassiedora{x,y} 
goexample,Aforoconstructordz 
reasonas\u 
wouldathe{} 
partialforb-. 
lameisthis:re-builtin 
let 
baapplication,da-formlamvsiff 
z 
a\n 
b{z} 
closureda-form. 
eacfg... 
h-. 
timebbuiltcecauseoffitxthe1 
fromw;:asits:form:;enthisxbm 
tered.ogdylamisbnotda-forminthewasrequirednotupdated,form.


Thunks.whereSTGspformsSincen 
(noecialThelanguage,thupmfy 
cformunksdate).isremainingandaofconstructor.arefy 
canotispartialareblamoundinexamplesbnormalapplicationda-forms,to(Sincehavform,ofeconstructoraritththoseunksoritymaappwith.)constructor,inearsThetheapplicationsatpreviousupemptrstdateareyagargumensection.calledareontheyalwathunksconstructorashouldtyslistsaturated.butallThenothaislamvalweinoftheirbda-athetheys


updateagoncsetthenu 
itisHowevtoiftheitscdatectoprove,that
thatthatythunkwingantheeupdatetod

atmosteto.safeer,setupompileragan
anann 
therebaallocbevaluate

Fomitted.

beorexample,considerthefollowingdenition:24 


f 
. 
{} 
\n 
{p,xs} 
-. 
let 
in 
case 
j 
xs 
. 
{p} 
of 
\n 
{} 
-. 
factorial 
p 


InsummarymaHereupydated.init,isupcleardatesthatsometimesarenevj 
willerrequiredb
bbe
eeevaluatedforforNil 
Cons 
atthmost{} 
unks.{y,ys} 
once,partial-. 
->->so+ 
++itsapplications{j,2} 
{j,1} 
closuredoandesnotconstructors;needtobe


andadditionomittedfunctions,

TheanalysisNotphaseucwhicwhseemsdetermineshavebeenhunksonneednottopic,eupdatedwarewcalledorkingupondatea


analysis.mhorktowhicthdonethisbbuteis

simpleupdateanalyser.

4.3Generatingfewerupdatablelambda-forms

ThetranslationfromtheCoretoSTGlanguageislargelystraightforward(apartfromthe


upandandatepartialortanlet 
applications.xs 
oppwhic. 
y1 
can: 
Consider(y2 
yofcourse: 
reduce(y3 
: 
eHaskomitted[]))) 
incidenceexpressionbaggingupallthwhicconcernsasupdatable).

isimpanalysis,tortunithtothebtheellyofdates,unkshconstructorsThere


Astraightforwin 
let 
... 
xs 
ard. 
translation{y1,y2,y3} 
let 
t1 
. 
in{y2,y3} 
let 
to\u 
thet2 
{} 
STG. 
-. 
\u 
{y3} 
let 
in 
language{} 
Cons 
t3 
-. 
\u 
. 
{} 
{y3,t3} 
{} 
giv-. 
\n 
es{} 
-. 
Nil 
{} 


Threeupdatablein 
... 
thunksin 
Cons 
have{y1,t1} 
bin 
eenCons 
built{y2,t2} 
whichwillsubsequentlybeupdatedwhen(andif)


xs 
istraversed.let 
Ant2 
t3 
alternativ{y3,t3} 
{} 
\n 
e,{} 
and-. 
usuallyNil 
{} 
superior,{y3,t3} 
translationisthis:

Noupdatablein 
inininin... 
let 
letletletthunkst1 
xs 
. 
===. 
are{y1,t1} 
{y2,t2} 
builtat\n 
\n\n\nall.{} 
{}{}{}The-. 
->->->onlyCons 
ConsConsConsbad{y2,t2} 
{y1,t1} 
thingaboutthistranslationisthatifxs 


wclosuresastobewdiscardedouldhavewithoutbeenwasted.beingtra(Thisversedisathenstrictly25thebwoundedorkofconstructingamountofwallork,fourhoconstructorwever.) 



Justthesamealternativetranslationispossiblewhenaknownfunctionisappliedtotoofew


arguments;thelet 
lambda-formfortheargumenwhicexpressionsdonotcantobeliftededated.aelsothat


partial-application bindingsremains,thesneedbupupleva


Ingeneral,Upform.datescaneomittedforparameterlesslambda-formsifthebodyisaheadnormal


4.4.
OppfromcomputationheadStandardortunitiesnormalthelamconstructorsform,b
bbmada-formforybthisandemoimprototherebveditsvfromenclosingyemenavoidatlammaanconybupda-formbtext.date.eenhancedMoretoitsgenerallybenclosingymoving,anconlet(rec) 
ytextsmall,tobexpbindingsounded,osea


Thenalformoftheexample{ 
inx, 
thexs} 
previous\n 
{} 
-. 
sectionCons 
had{ 
x, 
threexs} 
lambda-formsoftheform


fordevpoinxandInxs.Becauseafx1 
b;:::all;xm 
gvof\n 
fgsame-. 
formcfshapx1 
;:e,::they;xm 
gcanclearlyallsharea

coariouster.general,lamtheyda-formhaethe
thethesingle


whereacisaconstructor
constructorconstructoraritcanmshare,iscalledcommonastandarde.donstructor.Allhbda-forms


forparticularofcycocsuclam

Thefree-variablelistofaglobaldenitionisusuallyempty,sincetheglobalcanonlymention


otherglobals,theandwing[thing] 
isHasktedydenition:closureconsistingonlyofacodepoinHoev


considerfollo... 
represenglobalellbater.wer,


Astraightforwnil 
. 
ard{} 
. 
===translation{} 
\n 
\n 
Nil 
Cons 
{} 
to{thing,nil} 
theSTGlanguagegives

Thisreferencesinisperfectlything 
thingthingtolistould. 
... 
andvabutwireditmeanstocosequence!vingIfspecial-purpwalternativawithcotranslation,foreral,inheac


cellthething 
wcorrect,haenil 
separateindeit.haaList 
AnaslistoseedesevaList 
itemsiswhicit,hash


TheylamisaList 
aListaListaListnil 
da-formthe. 
{} 
. 
==for{thing,nil} 
... 
\n 
baList 
Nil 
{} 
wis\n 
wCons 
freestandard{thing,nil} 
ariables26hareandnotusenecessarystandardbutde


paobthatthing 
lamda-formnonohasavconstructor,whicstrictlycanthe,cothe 



for.Insteadofbeingrepresentedbyacodepointeralone,aList 
isnowrepresentedby


theWeCons 
ConsConsapplycothisdetogetherideathroughout,withpoinnottersjusttotheattopglobalslevel,thing 
tomakandenil 
sure.thateverylambda-form


whosebodyisasimpleconstructorapplicationisastandardconstructor.

Fshareornullaryitsclosurconstructors,e.Thus,insucthehabasovNil 
eexample,,itisnottheonlynil 
globalpossiblecantobshareeshareditsbcyodeall,obutccurrencesalsoto


ofNil 
intheprogram.

4.5Lambdalifting

makingLambdatheirliftingfreeisvaariablesprocessinwherebtoextrayallargumenfunctionts(Johnssondenitions[1985];areliftedPeytontotheJonestop&levLesterel,by


[1991]).InInalamcontrastda-liftedmostabstracteaclamda-formhines,hasSTGeitherhinefreevariablesesrequireno


arguments.btoprogramotherhmacbthemacnodonotor


theTheprogramoperationaltobedierencelambdalifted;betwaeenrighthet-handtwosideisfairlycanhaslighvebt.othConsiderfreevariablestheandfolloargumenwingSTGts.


languagedenition:

liftinginwhicishpthef 
erformed,. 
lam{} 
b\n 
da-formanewforglobalz 
hasfunction-. 
thein 
let 
freefbody 
(orz 
variables. 
supercomx1 
binator)and\n 
{y} 
x3 
,$z 
and-. 
iszbody 
argumenintroduced,ty 
.giving:Iflambda


ontothe
thetheevf 
directly. 
=={} 
{}{}\n 
\n\nstacthe{x1,x2,x3} 
{x1,x2,x3}{x1,x2,x3}andvjumps-. 
->->tocanlet 
in 
.fbody 
z 
e. 
the{x1,x3} 
{x1,x3}{x1,x3}directly\n 
v{} 
the-. 
whic$z 
{x1,x3} 
itself.STGhine


Notionallyw,what$z 
programhapphasens{x1,x3,y} 
onlyisthatthunkswhen(likz 
isezbody 
enz 
)tered,andsupitpushesercombinatorsitstwofree(likevariables,f 
and$z 
x1 
).andOpera-x3 
,


canexecutealuation,kfreeariables$z 
bInusedoriginalfromersion,closurehmac

Inshort,thelocalenvironmentinwhichtheSTGmachineexecutesconsistsoftwoparts


(Sectionthestack5.2):(itsargumenvaluesheldts).inThisthetclosurewo-leveljustenvironmenentered(itstreducesfreevariables),somewhatandthe
thethevaluesmovemenheldtonof


voraluesonlyfromamarginaltheheapone.tothestack,butitisnotyetclearwhetherthisisabigimprovement


4.6Fulllaziness

Considerthef 
. 
binding{x} 
\n 
{y} 
-. 
let 
in 
ef 
z 
. 
{x} 
27\u 
{} 
-. 
ez 



whereandef 
arearbitraryexpressions.Supposex 
andy 
arebothfreeinef 
,butonlyx 
is


freeinpair.Sincebindingsthebda-formforz 
doesnotvy 
asafreevthisisequivt


totheez 
ezezoflamhaeariable,alen


Furthermore,z 
f 
. 
==the{x} 
{x,z} 
latter\u 
\n 
{} 
form{y} 
-. 
ez 
-. 
mayef 
saveworkiff 
isappliedmanytimes,becausez 
will


instanvariablesedtiatedwtheunonceitsratherThisthanenclosingforishcallbtheoff 
.abstractionInlgeneral,transformation,honethecanise 
ee

movoutofardsonlybinding.tilimmediatelytransformationonceeaccalledlamdafullazinessbindseacbindingofandfreeb
bb

describedindetailbyPeytonJones&Lester[1991].

4.7Arithmeticandunboxedvalues

Inanon-strictfunctionallanguageimplementation,whenavariablebound,itisgenerally


brequired,oundtotheanunevclosurealuatedtowhicclosurehitpalloointscatedisevinaluated,theheap.andtheWhenclosureis
isisoverwrittenofthevariablewiththeis


resultingaluationvFdelevthatofnbsameareclosurewilltedndythe
thethepoinalue
aluealueteracated.


Thisevalue.mourthermeansaluationsallumtheersrepresenbav
vvtoimmediatelyheap-allo

closure,puted,oror(if\btheox", closurewhichhascontainsbeeneitherevaluated)informationtheactualwhicvhalueenablesofnumnumber.berWtoebcallecom


\actualmachine.value"anunboxedvalue;itcanbemanipulateddirectlybythe
thethetheinstructionsetofthe 
thethe

Theuniformboxedrepresentationmakesarithmetichorriblyexpensive.Asimpleaddition,


whicaluateheswinstructionopfetcinacontheirvtionalalues,system,them,requirescateasequencenewofoinstructionsforresult,


evtakonetoerands,henvaddalloabxtheto:


andOneplaceofthethe
thetheinnoresultvativeinfeaturesit.ofourcompileristhatunboxedvaluesareexplicitlypartofthe


takandovlanguagestsvmaasbun
ununo
oov
vvfunctionsystoredy


CoreeunbxedSTGaluesasargumen.Thatis,andariablesreturnthemybeoundresults,tob
bbxed
xedxedalues,aluesmabema


inexplicitdatastructures,aboutthestepsandsoinon.volvTheedinmain(say)motivaddition.ationforTothisbeginapproacwith,hweisdeclarethatwethecanfollothenwingbe


datatype:

Thisdeclaresdata 
theInt 
data. 
MkInt 
typeofInt# 
(boxed)integers,Int 
,asanalgebraicdatatypewithasingle


constructor,integers.SotheMkInt 
value.The(MkInt 
latter3#) 
hasrepresenasingletstheargumenboxedtinoftegertype3Int# 
(3# 
stands,thetforypetheofununbbooxexedd


constanNow,givten3,case 
MkInt 
ofthetype1 
expressionx# 
eof 
Int# 
-. 
MkInt 
case 
).(e1 
e2 
y# 
+ 
of 
e2) 
-. 
,case 
say,w(x# 
e28can+# 
rewritey#) 
of 
itlikethis: 


Thefactouterthattwox# 
case 
andexpressionsy# 
areadded,evaluateandt# 
thene1 
-. 
andtheirMkInt 
e2 
resultrespt# 
ectivt# 
iselyb,oxedwhilewiththeainnerMkInt 
case 
constructor.expresses


(Byconvention,weuseatrailing# 
foridentierswhosevaluesorresultsareprimitive.This


isjustforhumanreadability:theidentiers+ 
and+# 
aredistinct,butthe# 
isnototherwise


recognisedspeciallybythecompiler.)

Itturnscogeneratorthatthisbsimplereformalloassevoptimisationstransformations.hurthermore,hithertowburiedideacan


the
thethedeouttoeideaulatedwsprogrameralwhicFerethein


begeneralisedinanumberofdirections,suchasallowinggeneralalgebraicdatatypeswith


unboxedcomponents(ratherthanjustInt 
).AllofthisisdiscussedindetailinPeytonJones


&Launchbury[1991].

For
theDatadata 
Ftionsgivingaspaptivorpurpewer,literalexample,tell.ypdeclarations,discussedtypanosesiteessucescanexplicitconstanofarebInt 
thiseindividedmanipulatedtoapplicationistsPwhilepapideneytonanareer,algebraictifyinprimitiveoftoitJonesprimitiv
primitivprimitivsucestdirectlywofoa&kinds:typdataconstructor.Launceetoe,bttypestablishypywhiletypalgebrmacese;hesburywithliteralshineareInt# 
aic[1991]thebuiltuninstructions,dataisboffollooprimitivxedinalgebraicptyptoermitwingesttheyparee.es,facts:unsystem.andFtthoughinborypotroarexedetheducedarealwValgebraicpurpthealuesexpressedaysbgeneralisa-oseyunofexplicitbofprimi-toypxed.thisbesy


All
AllAllarithmeticbuilt-inoperationsoperateoverprimitivevalues(forexample+# 
above).

.
DenitionsVtheallytyppressedalueset,oypbccupecauseofedirectlyofunyfordouble-precision32boargumenbits.xedfunctionsinttheypAsetsSTGaneedmresult,opusteratinglanguage,oating-pnotbpeolymorphicbpassedeotheveroinandsamenon-primitivtotnhencesucumfunctionssizehbers,functionsdoasnotoeaccupc(iepanoinneedytakealgebraic)inter.64atoonlybitsuniformFborewhilebuiltarexample,vgumentsaluesrepresenin.pcanDouble# 
tersoftation.bbeoxeusu-ex-d,


(EvAdicultinsteaddiately;unlet 
benoxediforymadetheuntforletrec 
ypbwholeeothexedusingisbgarbageexpressionound,vpaluesaoincase 
tthewabcollectorereoutexpression.cannotexpressionalwunabinysobindxeddistinguishingthetoThevasamealueswhicvariablereasonhsizeisitthatisofaasforpbunaoinoundtheythisbpoteroinxediscannotmterfromthatusttyptheree.bawhenebnon-pSuceevwrepresenaluatedouldhaoin
oinoinavbindingariableter.)stilltedimme-bebofisya


as-yet-unevaluated

Inotherwords,intheSTGlanguage,case 
expressionsperformevaluation,whilelet 


andletrec 
buildclosures.
closures.closures.Thisuniformsemanticsgivesrisetouniformtransformation

laws;forexample,alet 
expressionwhoseboundvariableisnotusedcanalwaysbe

elided.

Forthesamereason,theglobal(top-lev29el)bindingsofanSTGprogramcannotbind

valuesofunboxedtype. 


takavalueesapartofprimitivavalueeoftypane.algebraicdatatype,whiletheotherperformscaseanalysison

4.8ransformationTherearetwoformsofcaseexpression,asthethesyntaxofFigure3describes.One |Forcingofdatavalues |SelectionofalternativeSWITCH caseonalgebraictypescomponentsSELECTPRIMOP caseonprimitivetypesweenAppel'sCPSandtheSTGlanguage.Firstly,bundlecaseexpressionsintoforcing,multi-waydataTheseareallbundleduptogetherwusingExtractionofrecordPrimitiveoperationsareafewminordierencesbetimplementationsusuallyunextractionofthecomponentsofthevalue.expressionswhich,asehaveseen,canbeusedtoadvantagebytheSTGmac,theSTGlanguageusesasingleconstruct,let(rec),toallocatefunction-vdata-valuedclosures,thusallowingarbitrarymutualrecursionbetweenthetwo.IthowtoachievethisAppel'sformofCPS.isamuchmoreimportantdierencethough:theSTGlanguageisnotacontinstyle!InCPS,everyuser-denedfunctionisgivenanextraparameter,namelyuationtoapplytoitsresult.Forexample,assumingacontinuationk,theexpression(fx)+yRelationshiptocontintouation-passingCPSconversionstyle(CPS)isatechniquewhichhasbeenusedto


goMetaodyeecter[1991];insevKelseyeralcompilers[1989];Kranzforstrict[1988];(call-bSteeley-v[1978]).alue)languagesThoughthe(AppSTGel[1992];languageFradetislazy&,


itofhassimplemucopherations,thesamesoathatvourtheasCPS:owofnestedcontrolconstructsismanifest,areandattenedtheretoisaandirectexplicitrelationshipsequence


T
TTb
bbet
etetoeen
eeneenOpethe
thethetheerationremainingconstructsconnectionlanguageexplicit,theCPSconstructslanguagefolloAppandeltableindividualCPSbAppformwsmacthe(AppSTGhineapproform[1992]),operations.correspthosethe


STGw
wwmaklanguage.ApplicationLocalfunctiondenitionofthewingAPPFIXusedyshoelApplicationelximateandondenceof


RecordThunkconstruction 
constructionconstruction RECORD let(rec) 


Therebasedselection,CPS-


and

case 


Secondlyisaluedhine.notin


and

soclear

Therepassinguation-the


contin

wouldbeconvertedtotheCPSform

The(\fx. 
call+ 
tof 
fx 
x 
f 
y 
(\fx. 
is(\r. 
made+ 
k 
fx 
inr)) 
toy 
.aThis(\r. 
tailcontincall,k 
r)) 
passinguationsatoysf 
whatanextratodoargumenafter(f 
t,x) 
thehascontinbeenuationcom


puted,sameexpressionnamelyaddis:theresulttoy 
andpassthat30valuetok 
.Incontrast,theSTGformofthe 



Thecontincase 
uation(f 
tox) 
theof 
calltof 
ispassedr# 
-. 
implicitlyMkInt 
r# 
;whenevaluationoff 
x 
iscomplete,


connottrolreturnstointhesecondel'sorldexpression.SMLstrict.secondlazycase 
ersionevaluatesCPSy 
,ouldhofcoursethe


isnecessaryMkInt 
x# 
App-. 
MkInt 
case 
wcase 
y 
y# 
of 
since-. 
case 
is(x# 
The+# 
y#) 
Aof 
vofwwhicrequire

suspendedCPSf 
computationx 
(\fx. 
wforce 
insidereallyy 
a(\yr. 
eth+ 
tofx 
beayr 
function(\r. 
k 
takingr))) 
auationasitst.


Sotheformouldbunkcontinargumen


secondfunctionconuation).forcesthcoisargumensimilarbapplyingformv's


whereforce 
argumenisthet(thetinhThisaunkde(itsstrikinglyrstt)toytheSTGittoforce 
aboe.


thewitywhic
whicwhiccontoalldistinguishesthe

ThisSTGdierencelanguage,inthebutaisinquitehdiculttinuationspindoarewnhandledtheclearlyimplicationsofdierence.CPSfrom


Forexample,thethehand,vitmahastherebnaturalincurk-lesscostofheap-allotation,sincetheeveryclosureisforatail


call.OnotherCPSersionyaystacthecatingcall

implemenuation,tation,andsincepassingitcurrenasantargumenactivationttoframef 
.ThecontainsSTGvtheersionenvironmensuggeststainstacwhick-basedh


contin
contincontinstyles.uationshouldbeexecuted.Butofcourse,eitherimplemen
implemenimplementationispossiblefromboth


TheSTGstylealsoseemstobemorenaturalforcurriedfunctionapplication.Considerthe 
thethethe

calltoCPS(f 
(assumingx 
f 
y) 
x 
,whic(\w. 
thathw 
isk 
leftthe
thethey) 
unccallhangeditselfhasbycontintheconuationversionk 
),tothisthewouldSTGgeneratelanguage.somethingIfconvertedlike:


Thisitive.ectisaratherfunctionensivandclumsytocompilationeerve,fortheanSTGlanguagefunctionvidesapplication!itasprim-We


expcurriedexpapplicationebpasivsoordinarypro

Ofcourse,thisimposesanextrarequirementonthecodegeneratorfortheSTGlanguage:


it(Formustexamplecopewithf 
mighfunctionsttakeoneappliedtot,morex 
,doorafewloterofargumencomputation,tsthanandtheynallyarereduceexpecting.toa


functiongivesanaturalwhichtakwayestotheprosecondvidethisargumen
argumenargumenfunctionalitty 
.)Asy.Section5willshow,though,graphreduction


InsummarywhaediscolanguageeredyhasaortunitiesaouroptimisationCPS,butishlittleexplessextreme.bCPS


Sofare,vnotvanoppsimilarforvtowhicaareosedy

buthiddenCPSythe
thetheSTG
STGSTGyvethe(Consel&ofDanvyanalyses;[1991]ewthatvnottransformingvwhethersource


programtobmaimprolanguage.accuracysomeshowhaeinestigatedthe

ornottheSTGlanguagehasasimilarproperty.)

31 



5Op semanticsoftheSTGlanguage

TheSTGlanguageistheabstractmachinecodefortheSTGmachine.Inthissectionwegive


aAdirectstateoperational 
erationalerationalseman
semansemanticsticsspforecies(a)STGanlanguageinitialstateusingforathestatemactransitionhine,andsystem.(b)aseriesof


statesstatetransition
transitiontransitionafterthetransitionrules.Eachashruletakenspeciesplace.aThesetsetofofsource
sourcesourcestates
statesstatesandissptheeciedcorrespimplicitlyonding,targetusing


pattern-matcrulewesaythathingtheandguardmatchesconditions;state.ifastateAtmostisinonethetransitionsourcesetruleforshouldagivenmatctransitionhany


givenstate,andifnorule
rulerulematches,the
thethethemachinehalts.

The1.2.3.4.statethethe
thethethearcruphaseturnogumentdedate,vwhicestack
stackstackcomphstacktak,
,,rsusonen,es,,aswhic
whicwhicone,ts:which
hhofcon
conconhsevcontains
tainstainseraltainsforms,cupontinuationsdatevaluesgivfr;amesenb;
elo;w;

istheir6.the
thetheconcatenation;globofalenvirsequenceonmentanda,.:as,whicdenoteslengthhgivestheaaddressesobtainedasofalldenotedclosuresyaddingdenedthe().attopatolevtheel.


Sefaquenc1 
5.;:::;esahen 
aregap.The,usedh,whicemptextensivhyconsequenceelytainsin(only)whatisdenotedfolloclosurws.fges;They;ifasandaredenotedbsaretwusingosequencescurlybracthenkets,as+
++thbsus


beginningtheasThetheofsequence
sequencesequenceisblengthasitem

AvaluetakesoneofthefolloAIntwingddrnforms:aA
AAheapprimitivaddresseintegervalue

Inthesethedierenoperationaltkindssemanofvtics,alue.valuesWediscussaretaggedlaterwithwaysAddrtoaandvoidIntactuallyandsoimplemenontodistinguishtingthis


taggingeinarealtes,htationoating-pt8).umers,ecouldtheyaddhandledformsofvanalogouslyfor


primitivdataypimplemensucas(SectionoinnWbbutfurtherareexactlyalueother


tointegers,soweomitthemtoreduceclutter.

WTheeuseargumentw;w1 
;:stack::,to,asrange,isjustoveravalues,sequenceandofwsvalues.torangeTheov\top"ersequencesofthestacofvkalues.isthebeginning


5.6ofistherespsequence.ectively).Thereturnstackand(vsup\ 
datexs32stac-. 
ke)willwsbedealtwithlater(Sections5.4and


Theofhetheapform,h,isamappingfromaddresses,rangedoverbya;a1 
;:::,toclosures.Everyclosure 



Intuitively,thelambda-form(vs\ 
xs-. 
e)denotes codeoftheclosure,whilethesequence


ofags,valueswhicwshcangivesbetheeithervalueu 
oforeacn 
.)hThisisfreeexactlyvariablesthe
thetheuniformvs.(Werepresenusetotationrangediscussedoverupdatein


Section3.1.3.alonmentcomponenof
ofofthe
thethestate,,mapsnameofeacvboundat


Theglobenvirthariable

thetopandelofalltheeforetothebaddress(Indeed,itsclosure.eThesecompcanallts,ballodonot


oncelevforbprogramexecutionegins.ofunlikotherclosuresoneneescated


cthanhangetoduringcodesequences.execution.)ItisTheimpSTGortanmacthinedoso,isunhowusualever,inbecausebindingaglobalsglobalmatoyclosurbeupesdatable,rather


soAstherewediscussedmustbeaearlier,closureittoisuppossibledate!to
totosharethecodeforstandard-constructorclosures


(Sectionto4.4).Innotthespecialcoofforclosure,withthe
thethethenoargumenitself.(sucoras)allis


possiblesharejustcasedeconstructorsthebutclosuretsFhexample,Nil 
it


referencesniladicconstructorstoNil 
canasuseapthe
thetheossibleaddressformofofaatomsingle(Figureglobalclosure.3),andextendingThisiseasilywithdonethebyaddressadding


ofasuitableoptimisationclosuretheeacerationalniladicconstructor.ticsFhsakws.ofywdonotp

thisinforophsemanwhicorfolloesimplicit,eerform


Finally,thecodecomponentofthestatetakesoneofthe
thethefollowingfourforms,eachofwhich


isaccompaniedEvalEnterbyitseaintuitivemeaning:EvandargumentrarilymenApplyaluatetsapplyoncomplextthethestacitsclosureargumenexpressionk.valueSTG-languageTheattoexpressionaddresstthestaceargumenink.aenexpression.vironmeneisthetsanonargu-arbi-tthe

TheloalaRRonmenteturnConeturnInt,of,kmapscwsvvtoReturn 
ReturnReturnationtheontocontinnamesthe
thethethe
thethealueprimitivconstructoruationreturnvalues.estaconin.tegerthecnotationk.appliedreturnktoto
totothestacvaluescontinextendsk.[v7!wsu-w]extendsthevious


mapcwithenvirmappingtheariable 
ariableariable vtowThisThenotationalsoinobthe


waytosequencesofvariablesandvalues;forexample[vs7!ws].

Thevalfunctiontakesanatom(Figurek3)andIntdelivkersavalue:

Iftheatomisaliteralk,val
valvalvalreturns.
.v 
vvaprimitiv.
===.
v
vveintegerifotherwisev2vdomalue.(If)itisavariable,vallooks


itvalupinvsisortheassequenceappropriate.ofvaluesvaltoextendswhich33valintheobmapsviousthewvaariablesytosequencesvs.ofvariables: 



5.1WebeginThe


program


Oneis:ofthe
denitionsNoticeys


Wsaglobaltheedate


upfact


5.2We

(1)b
Thea=only


therule\succlosurestatesuchtop)that"


isbgasyi 
initialwillspfolloecifying:Cog
ggEval1 
:n 
b:
ws:deestatemain 
. 
==(main 
vs
vsvsthe1 
n 
.\ 
\\Givfg.
initial1 
n 
)enxs
xsxsfg1 
n 
thisstate-. 
->->Astackfgprogram,re
eeg1 
n 
oftheRstackfgeturnSTGthecorrespstackUpfg3 
macdatehine.ondingHehinit 
TheapinitialgeneralGlobstatealsformoftheofan

writethateginApplicationsenstacthat
thatthatvironmenmain 
athe
(asksmactheglobalmainhere)
Evalareisvwherehinealuestot,emptop(vinbfariablesstatee,troerationalxsinbindsy;evhinit 
)
ducedthe
thethealuated

aseacrangeare
.
==ainitialbsemanhorizonhyalw2 
226 
664 
44inglobalaofg
gga:
::a\where"thean 
:1 
1::1n 
heap,ystics: 
::
the7!
7!7!7!7!talemptbto(
(((o(withglobalA
AAvsrovsxed.hitsddr
ddrddrinit 
1 
wn 
clause.y\ 
\ 
closure.theoflo,a
aaencon1 
caln 
1 
n 
its)
))
vironmenrulexsxstainsInen5 
7 
1 
n 
compvironmen-. 
->->thisforaeeonenapplications.
1 
n 
initialclosuret
))are
((ts,t;vsvsallstate,thesometimes1 
n 
for))addr3 
5 
7 
argumeneactheesseshcoglobal;withde.t,This
hlinethat(andafterwmatcclauseofvalEnterhesnotards.theiftofurthertheruleaaWfprimitive=cogivuseAdeconstrainsddres(valacomptheepattern-matcavalue).onenstatexsthe)trulebis+
++eforeanas
asashing34toEvalrs
rsrsthe
thethenotationus
ususoftransition,caseh
hhan. 
whereexpressionforthewhilefistopbofoundtheline.thebtoottomgivIntheenthis


STG


machine


compreturnauxiliaryandreectsonenandthet 
form.addresslinecase,givThetheesof 



stack,rulecase,andsatheysthatalueftopnoterformfunctionaddressatailcall,isentherathervaluesTheaoftheargumeneisaluetsareput


otherwhenvisofanbuttered.isfunctionprimitivvexp

Section5.5.tNoticehasthatvlo
lololifetime.vironmenisdiscardedatthispt;


environmenonlyaerycal
calcalentoin

The
TheThenon-upnextdatablethingclosures;todiscussthe
thethetheisruletheruleforupfordatableenteringclosuresaclosure.isgivWenegivineSectiononly


(2)=wheresuc)hthatEvalEnterlengthwsa 
e+
++(
aasas)as
asas0 
0 
lengthrs
rsrsasus
usus(h 
hhxs[a)7!(vs\n 
xs-. 
e)wsf 
]. 

Whenariablesanon-uplengthdatablethe(alues,wsclosurea 
).
===length[f 
vsisfound7!tered,(wsxsf 
);xsthe
thethe7!localwsa 
]vironmenandargumenis

freevtovws,eninclosure,enitst

ruleak.clausethegivvclosuretoevthis


foundweonusethe\where"stacThentobodyeofaluesthevariablesisaluatedusedintheinresult


5.3let(rec) 
expressions

AsmentionedEvalearlier,0 
B 
BBB@ 
let 
in 
ealet 
:x
xx1 
n 
::. 
==expressionvs
vsvs1 
n 
\ 
\\.
1 
n 
xs
xsxsconstructs1 
n 
-. 
->->e
ee1 
n 
1 
A 
C 
CCConeasorrsmoreushclosures.


(3)=where)Eval0 
0 
=e0 
[6 
2 
x1 
a7!1 
Addr(1 
a\ 
1 
;1 
:::;1 
xn 
7!eA1 
)ddr(aasn 
]rs1 
)us3 
7 
h0 

Theruleforhletrec 
rhs 
.
==his4 
a:almost:n 
:7!
7!7!(vs
vsvsidenn 
\ 
tical,n 
xs
xsxsn 
except-. 
->->en 
)that(rhs 
rhsrhsrhs 
vs
vsvsn 
is)5 
dened

35 

ectedinstead,theinto5.6.general,bonruleiseathedealtforclosure;argumentheenwithteringlothecalint 
constructedtsenvironmentostatethebofyvalues,bindingthet.Inrule.wsthisitsa 
,


intheheap.


tobe0 
insteadof. 


eTheecompletes,alternative.Weisperformedlater,Theothersideofallyevaluatestoeitherpoppedfromthereturnanintermediatestate,ReturnConapplicationusesEnter.Primitiveforconstructorsaregivennext.Evaluatingaconstructorapplication(5)Eval(cxs)=)ReturnConc(valxs)TherulesforReturnConreturnto(6)ReturnConcwsas(:::;=)Evale[vs7!ws]asProvidedthatthecontinuationoncisthesameasthatbeingevaluated,inthesavedenvironmentaugmenactualargumentstoc.Ifthereisnosuchalternative,thenovariableisboundinthedefault(7) ReturnConcwsas0BBB@suchthatc6=ci(1in)=)Evaledas 
textexpensive-loconstructorsandliterals.literal,atwhichpointtheexecuted.TherulesforconstructorsandReturnIntrespectively,justasvaluesaredealtwithinthenextsection,simplymovesintotheReturnConstate:asrsushasrsushtheappropriatecontinuationtakenfromthecvs->e;:::;):rsushrsushthereturnstackcontainsapatterncvswhosewejustevaluatetheright-handsideofthattedwithbindingsforthevariablesvstothevaluesdefaultalternativeistaken.Theruleforthisiseasycase:c1vs1->e1;:::;cnvsn->en;default->ed;1CCCA:rsushrsush36 

Hower,ifwhicaRhariableeturnContovviscthwsbound0 
B 
BBB@ 
y:c
ccv:n 
the-. 
:vs
vsvs; 
1 
n 
edefault,d 
-. 
->->e
een 
; 
;;;e1 
C 
CCCA 
:toheap-allocateconstructor


closureevtovbind,us:b1 
1 
wneeda

(8)=suc)hthatEvalc=6ci 
ed 
[v(17!ai]as 
asasn)rs
rsrsus
usush
hh0 
. 

Thiswhereruleisangvshlengthlittle0 
=ishacomplicated,([avsofsequence7!)=(vslength\n 
offrom(arbitrary{} 
ws)-. 
aclanguagevsdistinct)wsprogram]variablesalgebraicexpressions,canywthey):


variable-bindiformdefaultandthesimple(fortransformationcase 
eliminateana


Inalloimplemenandtationthencase 
uptermseof 
this:::whereas; 
vversion-. 
busingis=a)littleRulelet 
in 
case 
less8vsimplyv. 
ecienof 
xs:\u 
::t,; 
{} 
catesbdefault 
ecause-. 
theeaconstructor-. 
closurebforvitswillnalbe


form.cateddated,alloin

Lastlyasfailure.,ifthereisnomatchandnodefaultalternative,norulematches,whichisinterpreted


Insectioneerations whicealues.

5.5thisBuiltinwopgivetheextraruleshhandleprimitivvTheruleforevaluating


a(9)primitiv=)EvalReeturnIntliteral,kkk,enas
asastersrs
rsrstheus
usush
hhReturnInt. 
state:

A(10)similar=)ruleREvaldeals(ffgwith)k[f7!Intcasek]whereas
asasrs
rsrsaus
ususvariableh
hh. 
boundtoaprimitivevalueis

stacNextk.comeFirst,the
thetherulescasewhereforthe
thethethereReturnIntisanalternativstate,whicewhichlohokmatcforhesacontintheliteral:uationonenthetered:return


(11)
Next,=the)REvalcaseseturnInt
eturnInteturnIntewherektheas 
asasdefault(:::; 
k-. 
alternative; 
:::;e)37is:rs
rsrstakus
ususen:h
hh. 
 


(12)=)EvalR
RReturnInt
eturnInteturnInte[xk
kk
7!asInt0 
B 
BBB@ 
k:k
kk]1 
:n 
:as 
asas-. 
->->; 
0 
B 
BBB@ 
e
ee1 
n 
:xk
kk; 
;;
1 
n 
:-. 
->->->:; 
ee
ee;
1 
n 
; 
;;1 
C 
CCCA 
;:
CCCA 
rs:usrs
rsrshus
usush
hh. 

(13)suc
sucsuch
hhthat
thatthatk
kk6
66
.
==
k
kki 
ii(
((
1
11
.

i
ii
.

default 
n
nn) 
))-. 
e
Finallybuilt-in=),opweerationneedEvalafamilyhaevetheofasrulesform:forbuilt-inarithmeticrsopuserationshwhic


(14)=)EvalReturnInt(fx(1 
i;1 
x2 
gi)2 
)[x1 
7!Inti1 
;x2 
7!Inti2 
]as
asasrs
rsrsus
usush
hh. 

5.6Updating

Inthissectionwecovertheupdatingtechnologynecessaryforagraph

Up1.datesWhenstac(asu 
happk,;asrs
rsrsandan,
,,;enathe
thetheu 
upmakin),datableprevious
previouspreviousconsistingtwesothestages:closurereturnargumen
argumenargumenof:stacisttenandstack;tered,k;returnitstacpushesksemptanupy.dateAnupframedate


2.Whenone.
ofaIfIftostactheincanwhicu 
evtu 
uuuthe,wthe
thethepaluationakupoaophpv
vviswvdateoiduparealueoinaluea
aaemptys:datetercontinmakingnotofinof
ofoftoytotheframe)..the
thethepresenuationatheThisclosurespclosure
closureclosureclosuretheecialtfailuretestThisonfromissorttheisisbafailurebaycompletethefunction,
eingtriggersargumendatamergingofcontinreturnen
38toconstructortered,ndanthe
thethetanuationstacstacupupenoughfunctionandreturndate.kk,date|(bwhicwhicorecauseSectionisliteral,(Inargumenandwillhhtriggered.shouldthewillupattemptthey10.1.)andaterealfailtslaterb


h,foreachbinary


reductiononframetotheismacauptriplehine.date


attemptThisecausebcanewillupthehappdated.bereturnmadeenin


wtriggersstacereimplementosquirreledbindks,anandargumentationupmakingdate.awwatsye 



Thesesituationsaremadepreciseinthefollowingrules.First,weneedtoaddanextra


whicrulehisappliessimilarwhentotheenusualteringclosure-enanupdatabletryruleclosure(Rule(that2):is,onewhoseupdateag


(15)=)EnterEvaleaasfgfgrs(as;rs;a):us
usush 
hh[a7!(vs\u 
{} 
-. 
e)wsf 
]. 

Thetoandierencewhereupdate=isframe,[thatvs7!thewhicwsf 
argumen]hispushedtstaconk,toreturntheupstacdatek,andk.closure(Naturallybeing,theenteredreal

tationwithamanipulatesnon-emptyargumenpointerstratherlistarethannevercopupyingdatableentire(Sectionstac
stacstacks4.2),|Sectionweonly10.3.)dealSincewith

in
inintherulegiven.

Next,theyupwedateneednewclosurerulesforpoinconstructorstedtobythewhicuphseedateanframe,emptyrestorereturnstacthek.argumenWhenthistand


stacksuation,upitframe,oytryeyinItyheatheupreturnisstack

thecontinfrom butdatetomaandbemptagain.,whicmabcasethatsecondrestoreddatep

soonuntilthe
thethethecontinuationisfgexposed.fg(asu 
;rsu 
;au 
):

(16)=where)R
RRvslengtheturnCon
eturnConeturnConisa(vssequence)=c
cclengthws
wswsofasu 
(arbitrarywsrs)u 
distinctvariablesus
usush
hhu 
. 

Theclosuretohu 
b=ehup[adatedu 
7!(vs(address\n 
fg-. 
au 
)cisvsjust)wsup]datedwithastandard-constructor


OnlyaruleyforstaceturnConbneedthatbegivouldItisnotthatpossibleclosuretheReturnIntbeupdated


anemptreturnRk,ecausewen.implyaforshouldstate


primitiv,ewalue;needbutrulenotohandlehasacaseprimitivttheree(Sectionnot4.7).argumenon


Finallysuchvethathaa=a(
(asvsclosure)\n 
<xsas-. 
the(fgexs))ws(asf 
whereu 
;rseu 
;ypau 
):usarehenoughts

tobeboundbyalambdaabstraction,whichtriggersanupdate.Therelevantrule


(17)=where)Enter
EnterEnterxslength
lengthlengthhu 
1 
=+
++ha([xs
xsxsaasu 
2 
1 
)7!==+
++xs((length
lengthlengthasvsu 
+
+rs(u 
xsas1 
))\n 
xs392 
-. 
e)us(wshu 
f 
+
+as)] 
isu 
).Therule


areimplemen-thisclosuresformedcase


erformed,happconreturntainsens,and


is:theclosure.withtostacseeak


(
++

(Therulewillonlyapplyifthenumbofarguments#xsisgreaterthanzero,sothe

beingetereddatedwillbenon-upa)ashencevthe
thethe\n 
alueinthetherstlineofbeingrule.)enThe(addressclosure 
closureclosure

tobupen(addressu 
hasdatable;itsaluevofclosurethetered

aco)deappliedis((vsto+
++xs1 
argumen)\n 
xs2 
ts-. 
one);thethestacbokdyase.isIttheisthereforesameasthatupdatedofa,withbutitaclosurehasmorewhosefree


variablesretried.(xsasellasvs)ander
ererts(xsinsteadofxs).Aftertheupdatethe


Enteris1 
wfewargumen2 


Thisconcludesisthebasicitrulesformanufacturedating.compiledwer,onedeofthetheconstrainsotsearealtoim-be


plementationthatcannotupHoco\ony", winneed

carefulaboutthe
thethevscodefgcof)isOK,whicarewcreatedcanbupdating.itTheeachdeconstructorrequiredforc.


constructors,(\n 
part-. 
vsclosuresecauseheprecompileyforco

Thecoeforpartialtoapplications,the((vstireb
bbxso1 
)\n 
exsev
evev-. 
e),functionmoreforevsincepossibleitsuggestspartial


thatwdeneedprecompile en+
++dyof2 
eryistiresome,ery

application.Analternativeruleforpartial-applicationupdatesavoidsthisproblem:

(17a)suc=where)hthatEnterEnterhxs1 
a=+
++a(
((aasvsas2 
)\n 
.
<=+
++xsxsasas-. 
u 
rs(fgexsu 
))ws(asf 
u 
;rsu 
;au 
):usushhu 


Heretheclosureblength
lengthlengthfheingu 
is=anhen([xs
xsxsaarbitrarytered,u 
1 
)7!=((length
lengthlengthaf,:vxsariableused1 
(as)\n 
)infgthe-. 
newfxsclosure.1 
)(a:asThe)]newcoderequired,namely


((f:xs1 
)\n 
fgAll-. 
thatfxsis1 
),requiredcanbesharedis
isisafamilybetwofeensucallhcopartialde-blocapplicationsks,oneforeactohthepossiblesamen
nnum
umumb
bber 
erer

of
ofofargumen
argumenarguments. 
ts.ts. 

40 



WitehashaP 
vsomeart 
enowinI 
completedterestingI 
I: 
Mapping 
features,theabstractitsthe 
realdescriptionhardw 
justicationabstract 
are 
oftheisSpinelessthatmac 
itmapsThine 
aglessveryG-macto 
nicelysto 
hine.ontoc 
Whilstk 
stock


hardwtherestare,ofwiththepaparicerhwsetedescribofdesignethealternativmappinges,insomedetail.ofwhicwehavealreadyindicated.In


6Targetlanguage

Ourgoalis,toofiswritetogenerategoodcogeneratorsecodeforaeacarietarcofstocarcandisOneely


approachthiscourse,toindividualnativdeforvh
hhyhitecture,khitectures.thislik


languages,givethewhosebestresultscodegeneratorsintheend.haUnfortunatelyveevolvedand,toimprocompvedeteovwithermanmoreyyears,maturewewimpoulderativhave 
ee

to
totodoacomparablygoodjobofcodegeneration,whichisalotofwork.

thangeneratingbewgenerateIndewyelanguageinstanourytarget,C


Motivatedythisnativconcern,codeedirect. cothisinathewCgainastportabilitprimary,becauseratheris


implemeninCcodetedgeneration.onawideThisvarietapproacyofarchitectures,h,ofusingandCasw4 
eab\high-levenetdirectlyelassemfrombler"improhasvemengainedts


palopularitoncompilingyrecentlySML(BartletttoC,dev[1989];elopedMirandaindependen[1991]).tlyandInconcurrenparticular,tlythewithworkours,ofTaddressesarditiet


essentiallythanthesameC(T,weAcviaharyainLee[1991]).datate\AbstractThis


alloeciencywstheandfollodecreasingwingspectrumportabilitofalternativy:esforthenalcodegeneration,withincreasing


RatherWecangeneratingproblemsANSI-standardCwhicdirectlyhexploitsarditi,goC,vwhicariousanhshould&non-standardternalbewidelyypextensionspcalledortable.toCsuppC". ortedby


Compilingwhaviaeiserytratedeprstwyalternativbutedes

Socomefar.
theW
WWfordee
eeeGncan
cancanevugenerate
generategenerategenerateInCCconcengeneratecompilerthevrestnativattractivof(Stallmanethisonlymacthishineonfor[1992]).thecoortabilitwdeusuallydescribdirectlytoreasons,e.ayfewtrices.likwhicnon-standardallgosubstanothings,itdoimpronottoe


thecofree.wcanusingsectionroute,ebexploitingkshtiallyextensionsv


Cpro4 
Here,vided\Miranda"byGnuisC.notthetrademark.ItisthelastnameofaresearcheratQueenMaryandWesteld


College,London. 

41 



6.1MappingtheSTGmachinetoC

Atrstitappearssensibletotrytomapfunctionsfromtheoriginalfunctionalprogram


ontoCfunctions,higher-orderwsoonabandonedlanguagethistoapproacgreat.h.Themis-matchbeteenCanda


non-strictbutfunctionaleisow

Instead,theusualtheCparameter-passingargumentstacksandmecconhanism.trolstacAllkare\registers", mappedonsuctohexplicitasthestacCarrakpys,ointers,bypassingheap


pointer,heaplimit,andotherregistersintroducedlater,areheldglobalvariables.

Thisvariablesereducedapproacduringwithouthresultstheexecutionlosinginapgreatortabilitofasingledealy,bcoyglobal-vde-blocachingck,ariablesucbasedhglobalsmanipulation.onasimplein
inin(register-allousageTheanalysisoverheadscated)(Tarditi,locancal


Acb
bbyharytellinga&theLeeC[1991]).compilerAtotthekeepexpparticularenseof
ofofportabilitglobalsiny,sptheeciedoverheadsregisterscanpbermaneneeliminatedtly,aen(highlytirely,


non-standard,architecture-specic)facilityprovidedbytheGnuCcompiler.

6.2Compilingjumps

ThemaindicultywithgeneratingCconcernslabels.Weusethetermcodelabel(orjust


labareel)that:tomeananusedidentotiernameforanacoarbitrarydesequence.blockTheofcoimpde.ortantcharacteristicsofacodelabel


We.
usuallyorIt
ItItItcan
cancancanplacedthinkb
bbbe
eeemanipulated;usedinofatable.labaselstheasdestinationforbeingexample,represenofaitjump.tedcanbybecopusheddeaddresses.ontoastacThek,troublestoredisinthataclosure,Chas


nothinghewhicdirectlyincorrespfolloondssubsections.codelabels.Therearetoaoutofthis

whicwoutlinehthewingtowwysdilemma,


6.2.1Usingagiantswitch 
Thewithrstthefollosolutionint 
while 
wingcont 
(TRUE) 
isform:to. 
1; 
mapdo 
labelsontointegertags,andembedtheentireprograminaloop


switch 
1: 
2: 
... 
(cont) 
and 
{ 
so 
...code 
...code...codeon 
... 
for 
forforlabel 
labellabel1...; 
2...; 


} 
42 


Nowajumpcanbetedbyassigningtocont 
followedbyabreak 
statement.The


switch 
Theshortcomingsstatementofwillthethentechniquere-executeareclear.withtheFirstlynew,labalael.yerofindirectionhasbeenimposed,


becauselabelsarenotimplemen
implemenimplementeddirectlyascodepointers.

Secondlythe,andtiremoreincluding,separaterun-timecompilationismadehasucbmoregatheredTheincoa


forenprogram,seriouslythesystem,mtohedicult.togetherCtode


substansinglethatagiansptiallyecialtC,andprolinkcedureimperhasoseandheatobvythenewrittenrecompilationcompiled.topasteNotcoststogetheronlyondoevenesthethislocalCstressccohanges,dethegeneratedbutCcompileritalsofrommeansquiteeach


separately-compiledsource-languagemodule.

6.2.2Usingatinyinterpreter
Becauseoftheseproblemsweuseanalternativemethod,basedonanicetrick.Theidea


isrequiredtocompilelabel.eacNohw,labCelleddoesblotreatckoffunctionscodetoasastorableparameter-lessvalues,Crepresenfunctiontingwhoseeachbnameyapoinistheter


toproitsvidescode.istoThecallonlytheproblemfunction,isbuthowthentojumpeverytosuchwacodemakblocek.C'sThereturnonlystacmeckhanismgrowbCy


onemorecompilerord,causinghcertaintedatailkvcallasw.jump
jumpjumpould
ouldouldnotsuerfromthisproblem,but


ACwwhicimplemenstacoeroaw

itFurthermore,wouldhardlyCbisecomplicatedaportablesolutionenoughto
totoremakquire
eethesuchtail-callanoptimisation 
optimisationoptimisationforcorrectquitehardoperation.toget


righso.t(inthepresenceofvariadicfunctions,forexample)andnoCcompilerknowntousdoes


Sohereisthetrick:eachparameterlessfunction,representingacodeblock,returns code


pointoiswhile 
trolledh(TRUE) 
itwy{ 
likcont 
folloto. 
(*cont)(); 
one-lineratherthan} 
terpreter":clingit.Theexecutionofthe
thetheen


programterwhicconouldbtheewingjump,\inaltire


Thatfunctionis,cont 
towhicishtheitaddresspointsisofcalled,thecoanddebloreturnsck(thattheis,addressCfunction)ofthetonextbeone,executedandsonext.on.The 
TheThe

loalueopisnallyforenfairlyyalong-jump,cost.thoughonecouldequallyelltestcont 
fora

vinstead,brokabminorwparticular


Here,forexample,CodeLabel 
isCodeLabel 
return( 
af() 
code{ 
blolbl 
lbl 
ck); 
whic. 
*RetSp--; 
hjumpstoalabelfoundontopofthereturnstack:


Theusualresultway} 
,withisaafully-pstandardortablelinkimplemener.Labelstationarerepresenwhichtedsuppdirectlyortsseparatebycodecompilationaddresses.in

Coraryariables,thec43cearelimited,ariablesgo

Tempfunctiongeneratedvusedforwithincodeablosinglek.Theircodebloscopk,istherebdeclaredyaslocalsovthataofodthe 
thetheC 



compilerwillputtheminregisterswherepossible.

Itturnsclevoutideas,thatthisideaseemsactuallyhaeeryeenandinenthatwheonlyitvted\UUOLiksevin


othererSteeleistovvbold,itsvtor;ecalledreintheenit.handler"eeral


hisRabbit[1991],compileruseforashemetarget(Steeletheir[1978]).compiler.sameideaisusedbTAca


LeewhoCScaforSMLTheyarditi,hary&


Intheportabletinyinterpreterdescribedabove,a\jump"hasthefollowingoverheads:

6.3thereturnOptimisingjumpepilogueinstruction,toimplemengeneratedthewhictintthebyhypinintheopsterpreter'sterpreterCthecompilerreturnloop;foraddressthecurrentoreturntCfunction,tothe\inconcludingterpreter";witha


Asationstthe.
a
aatheexpsubroutinetoprologuethisenseregisterjumpofpcallgeneratedortabilitsequence:instruction,saves.y,bwyFetheorcanwhicarcCmakhitecturescompilerhpushesesomeforthewitharcthehitecture-inaterpreter'snewxedCregisterfunction.andreturncompiler-spset,address;mosteciCcompilerscoptimi-


Eliminating 
EliminatingEliminatingimplemenregisters.InregisteratGntheuconjunctionCend.prosathetTherevvideseainstructions.framecallee-sawithaiscompilerapsathevoinvesedirect-jumpter.sequenceconagvenMostwhictionathCfortheoptimisationmakcompilersallstartestheregistersofcompilergenerateeacdescribhexceptfunctionuseinstructionsedabaelocaller-sasmallandwathisnatrestoreumvestheeliminatesbconerbsequenceeginningvofenwtion.orkall


GeneratingbutofJUMP( 
toGnandcompilerexpandvcompilersassemariables.confusingauitendCreturn 
blyislbl 
protodirectofvitalcancoproMirandavidesanfunctionsde) 
the,statemenalwvidein-lineforinwherejumps.a
aadebugger.thisdebuggers.ysancompilergiv
guretoassem
assemassemJUMP 
wt,esasetyInsteadbutdetailshasbly-cooutbly-languageisaguptheaitstheatomacro.ofdeframeofpitfalls,implemensuppressosetstheinstructiongeneratingtricpFtrapoinespoforkytationterframe-ploaeciallydothingscalpregister.
or,whicortablereturn( 
vcanariableswhicoinifhonewreallybterheeimplemenThissimhaswmadelbl 
manipulation,efromdoultaneouslyexploittoises) 
redundandofasterthetakwtation,e(Mirandahere.)
staceactuallyabykjump.tryatt,JUMP 
pmakingUsingointhebtoecause
[1991]).
terusegenerate(Mostexpandsexpin-lineitself,JUMP 
loensethecalC


44 



6.4useDebuggingofatinyinterpreterturnedouttohaveaveryusefulpropertywhichwehadnot


The
TheThemacfrequentremendoustakaid. y

anticipated:STGithineistlydebuggingesanindirectjump,tothecodepointedtobaclosure.If


faultbugorhasillegalcausedinstruction.a
aaclosuretoThebedicultcorrupted,yisthisthatindirectthereusuallyjumpusuallynowaycausesofbacakingsegmenuptotationthe


codewhichperformedthejump,whichistherststepinidentifying sourceoferror.


Usinga
aatheof(unoptimised)mostthettininjumps.ofcoprobloevkanjumptainingeasysolution,throughfatalecausetincaninrecordit


faithfullytrailtherecordsrecenaddressfewyterpretertheSincedevidesceryconpassesthebjump.the
thetheityeasilyterpreter,


Furthermore,itiseasytoaddtothetinyinterpreter'sloopacalltoahygiene-checking


routine,considerablywhic,hwcehechaksvethatfoundthethismachineygiene-cstateheclookskingplausible.aninaluableWhileaiditsloforwstrappingdownthethe
thetheprogrampoint


atwhicathewhichineisstatebecomesmh
hhcorrupt,uclater. thantheptatwhicthe

causeshcrash,machoftenucmhratheroinhcorruption


ItishardandtovcotheitusefulnessofOnlytriceopleesphaesinceenitallhasimpactttoallthe 
thethe

compilerotheerstatedegenerates. thispk,whoeciallyv
vvsptnighnotryingatndon

causeofthecorruptionwhichsubsequentlyledtoasystemcrashcantrulyappreciate


it!

7Theheap 
heapheap

Theusetheheaptermisapointercollectiontoreferofclosurtotheesaddressofvariableofasize,closure.eachidentiedbyauniqueaddress.We


7.1Hoclosuresarerepresented

EacshownhclosureinFigureoccupies4.acontiguoussequenceofmachinewords,whichisalwayslaidoutas


therstpw
wwoinordterofisaaclosureblockofiswcalledordseacitshinfoofwhicpointerhcon,andtainspoinaptsointoter,itsfolloinfowedby.aFolloblocwingkof


wordsustfollotainingwformernopbutters.not(Thedistinctionlatter.)Therebetiseensingle,toisthatgarbagecated,collectortable


mcontheointhewathewstatically-allotheinfo

assobindingciatedisawithheap-alloeachcatedbindinclosuretheprogramwhoseinfo-ptextoin(Figureterrefers3).toEacitshstaticdynamicinfoinstancetable
tabletable(Ruleofthis3).


The
TheTheinfo
infoinfoloadingtablethecontainsaddressanumoftheberclosureofeldsinwhictothe
thetheh45willNode 
bedescribregister,edandlater,butthemostimportant


ofistheenteringrsteld,aclosurewhichisconperformedtainstheby:labelofclosure'sstandard-entrycode.Theoperation 



.-
Infopt 
ointer-P.
.Infooin.
...
..ter.t 
tt..table.
..w.
..ords.
...
... -
--...
.Non-p.
..Standard.
..
..oin.
...
..ter.
...
..
enw. 
..tryordscode


Evacuationcode

Scavengecode

Otherinfo...


Thestandard-enjumpingtheinfotabletotrythebcoystandard-endeindirectingcanFigureaccesstryfromco4:thedeTheNode 
vforariousla.theyoutclosure,eldsofaclosure ofwhosetheclosurelabelisbyusuallyindexingfetchedfromfromthe


Node 
register.thisEnoughDebuggingTheinformation
informationinformationinformationrestasoftwthetooenableforcoinfodeinsptablelabtheectionels,garbage-collectorconwhictains:byhaaredebuggerdescribtooreddotracefurtheritsjob.generator.inInSectionfactwe7.3.implement


Itwhicis.
husualFinofortoourtheirglobalforparallelheap-alloeldsmemoryimplemenconcated.tainThis,obptation,oinjectstoters.o,istoenoughactuallyconIntainconinformationtrast,implemenlayoutourinformation,tedclosurestoenableasacodothetodenotsplabclosureecifyel.containtheirtobanesizeushedysucandh


information.IndirectionclosurRather,esareasgeneratedweshallsee,byupsizedateandoplaerations,youtinformationand-Ptheyointerishatoencoveanotheradedparticularlyinclosuretheinfoecientable.t


representation: IndInfo


Theindirectionstandard-enpointertryfromcodetheforclosureInd_Info 
intoconsistsNode 
andofaonlysecondtwtooinstructions:enternewoneclosure.toloadthe


IntheirretrospG-macect,hinethisimplemenrepresentation
tationtation(Johnssonisquitesimilar[1987]).tothatIntheirchosensystem,bythe
thetheevChalmerseryheapcellgrouphasfora


one-wbeperformedord\tag"onwhicthehcell.pointsOurtosystematablediersofentry46frompointheirstsforinthetwvariousorespects.operationsFirst,thatandcouldmost 




important,ratherthanhavingaxedcollectionof\tags", wegenerateanewinfotablefor


eachbindterpretivintheprogramunusedtogetheryG-macitsassoSecond,ciatedcode.opThisessenofteringeliminatesclosure


the\inewind"text,bthewithhine.theerationentiallya

invanindirectionedetondthe,Sectiondelabeltodiscusses.jumpto;thisindirectioncanbevwhen


generatingolvnativcodirectlyasco7.6aoided

7.2Allocation

Theclosuresfortop-levelglobalsareallocatedstaticallyatxedaddresses;wecallthemstatic


closurwhiches
esesis.upAdatedstaticduringclosureexecution.isnotnecessarily(Thealertimmreaderutable,willhowspevoter,thatbecausethispitolicymaygivbeesarisethunkto


agarbage-collectionproblem,whichwereturntoinSection10.8.)

godaelisalloFdynamicallyallospaceconywspbloiswfreeellratherHp 
ofor


Allfromootherperformancefreeclosureslist(Appitare[1987]).essencatedtialtoreecateisfrom
fromfromdelimitedathetiguousbheap.toAsecialcknoofregisters:wspace,understotheregisterd,than


pbasic-bloointstoconekbasis,endofsoit,thatwhileonlytheoneHLimit 
free-spaceregisterexhaustionpointstochecthekother.ismadeAlloforcationeachbasicisdonebloonck.a


7.3Two-spacegarbagecollection

Garbagememorycollectiondividedisptowbsemi-spaces.awstop-and-copgarbagecollectoriser[1978]).allAve


ableiserformedintoyto-spaceWhenycollection(Bakinitiated,livail


closuresThis.
copAsEacwhicto-space
to-spaceto-spaceareyinghhlivitcopiedproep
ppclosureoin
oinoincessistertsfromscannedinmsubstitutedmvustolvoneustbeselinearlybsemi-spaceteevwevacuateacuated,obasicfor,eactheoptodhunlessoldfromclosureerations(onefrom-space
from-spacefrom-spaceenditmhasonustofclosures:)alreadybtheepoinsctoother.avengeter.to-space.beend;evthatacuated,is,eacandhclosurethenewto


Theunusualfeatureofoursystemisthatthesetwooperations,evacuationandscavenging,


are\knoimplemenw"theexacttedbystructurecodepoinoftedthetofromclosure,theandinfothereforetableofeaccanhclosure.operateThesewithoutcodeinterpretivsequencese


loops,andwithoutanyfurtherlayoutinformation.

TheevItnewly-alloacuationcopiesoverwritesthecatedcode,closurethewhiccopclosureyhinoftoisthecalledinto-space.from-spaceclosureasainCto-space.function,withaforwardoesdingthefollopointerwing:,whichpointstothe


.
It
ItItreturnsthenewto-spaceaddressofthe47closuretothecaller. 

poin.
terscait
ititthisvincallsreplacesevtheacuationtheclosure,cotheevdeacuationpcall.ofoinaterclosure,coindetheforalsooriginalcalledclosureclosureastoaCwhicwithfunction,hitpto-spaceoindots;esthepoinfolloterwing.returnedForfromeach


The 
TheTheustbeenging
engingengingacuated),codewswhicarehofthe
thethe(andteldsmconnoteclosureacuated). (and

mevandknowhichnotargumenhenceusttainbevaddresseshence


ACfunctiondoestheonce-per-collectionworkofswitchingspacesandaccumulatingstatis


andticalsca
scascainformation,v
vvengeroutinesbutalmostoftheclosuresallthewinorktheofheap.garbage-collectionAsinthe
thethecaseiscarriedofthestandard-enoutbytheevtryacuatecode


oppdealinfo-tablesphhanismfree"evvanpro

ofaortunitclosure,ytothewithsevdispatceralecialmeccases\forforacuation(thatis,andwithoutscaengingyfurthervidestests):the


Forwardingisothedistinguishbclosure:veforeerwrittenmadeforwevpardingittoacuating.oinhasaevwithters.forwacuateanpoinaardinginfoAforw
forwforwter.Instead,theparding
ardingardingoinpThereclosure;ointerterweandpispoin
oinoinmakbyanateronesometerniceeattemptasimplyeldhandlesoptimisationsortwhicoftoreturnsthetaghevpacuatesituationbit,theatsvterailablewhictoto-spacealoclosurewherethehokhashere.to-spacejustaaddresstowhicsecondlikbMosteehtestedcopanhasfoundattemptsystemsy
yy.otherbTheeenin


inforeturnstabletheforto-spaceaforwaddressardingpfoundointerinhastheratherforw
forwforwarding
ardingardingsimplep
ppoin
oinoinoin\evter!acuation"Soevcoacuatede,whicaclosurehjust 
justjust

Indirections.oneforwAllforaheap-alloardingsimplyforwardingAllpjumpsoincatedindirectionsterpointoclosuresorter.itsnot.evcanNoacuationareeasilyforwatleastarding-pbcoede,tremoworegardlessoinwvordsedterduringtestlong,ofisingarbagepwhethererformed.orderto
totocollection,theleaclosureveenoughbyisanothernospacewa


StaticnicetoatmoThisthereb\jumpsclosures.xed,thevingtricisyevto"easilythek.nevacuationstaticAllerratherclosure.Somemoarrangedthatlocations.vedroutinethanclosures,isinrequiredto\calls"byTheseto-space,ofmakingnotablytheisisclosuresdelibclosurethattheytheirthoseeratethedon'ttomevforustevacuation|whicglobalacuationhathisnothvethebisclosuresaecoascamoroutineindirectiondetailvvengingreturnedcall!)(Sectionbyoftheroutine.Sinceimmediatelyanpoin5.1),indirectiongarbagets!indirectionsare(Thecollector.allowithoutjumpsusecatedareof


SmallConstructorfacttorstandard-enintegers.appliedweneedtrytoAclosurestthexed-precisionwcoodeinfoprimitivforcantablestheexisteconstructorininforteger
tegertegerineacbothvh(ofalueconstructor,48tstaticcanyp(SectionestillInt 
and)bise4.7).dynamicshared,onerepresenforThisofeactedspaceincourse.)hbturnyof(SectionthetheseisMkInt 
represencases.4.4),construc-tedso(Thebiny 



atwo-wordclosureconsistingoftheMkInt 
infopointerandtheprimitiveintegervalue.

rangeevand,acuationifso,cousesdefortheMkInt 
integerseestoifindexthevaaluetableoftheofstatically-allointegerliesincatedpre-determinedInt 
closures,

returningtheaddressbtheofthisstaticcollector,madeThepistthatonealla
aaincollectionare

\commonedup"ygarbageclosure.andeecttoointoofsmallxedtegers


oftheinclosures.notintherangeofthetable,theclosureisevacuatedtoto-spaceas

Ifteger 
tegerteger

usual.won'tpThereerformis
isistheantesteasyagainrenemennexttimet:giv(beecausethenewitwillcopycertainlyadierenfailtinfoagain).pointerwhich

7.4The
TheThethatcollectorclosuresOthersmall-in
small-insmall-inmeansandgarbagerequiresgeneratingtegerallotherjustccollectorhecconstructorsonekextracouldchunkcovofariandeofcourseisomorphicinextratslotsbcoeofde.madeplaces,toTheInt 
atsamethewhereasorChar 
timeoptimisation.andoingInt 
itisappliesinallothecated,garbagetoChar 
but


Twtheo-spacerealmemorygarbageavailable,collectionatwwhicorkshwpellointunthetilthevirtualresidencymemoryofsystemtheprogrambeginsapproactothrash.heshalfWe


hacompactingvimplemenresultsadual-moand[1991]).tdeo-spaceewhicdevswitctoatodynamicallyextensionpaging,beteenasingle-spaceencourag


ingeearlycollectorted(Sansomawcollector,Wcollectorarehelopingtryhesfurtherminimisewtowithagenerational


collector,basedonAppel'ssimpletwo-generationscheme(Appel[1989]).

7.5Tradingcodesizeforspeed

Theinfo-tabledispatchmechanismoutlinedaboveallowssomeinterestingspace-timetradeos


toSobfaremade.wehaveassumedthateachkindofclosurehasitsownev v

code,whictohb\knoecompiledwsabout"foritseacsizehclosureandlayinout.theThisprogram.requiresButnewsinceevacuation
acuationacuationthegarbageand
andandsca
scascacollectionvenging 
engingenging

routines
routinesroutinesexample,forallaclosuresclosurewhicdephendconsistonlyofonexactlyitsstructuroneep,oinitterisofteneld(apartpossiblefromtosharetheinfothem.pointer)For


canstandardsharegarbage-collectionthesameevacuationroutinesandscaforvenginganumbroutines.erofcommonIndeedlaouryouts.runtimesystemcontains


Whatifaclosuremustbeconstructedwhichdoesnotmatchoneofthesestandardlayouts.


promisepwhicallousgarbage-collectionalevandactuallyeas

Itispossibleositiontocompilehspecialwstoprovidelacuationcodeforit,butscavengingwadoptacom-part


ofstandard"theruntimeclosure,system.weproInsteadvide\generic"ofgeneratingevacuationcodeforandgarbage-collectionscavengingroutinesroutines
routinesroutinesintheforruna\non-time


system.Thesenbroutinesofoinlookinwtheandclosure'sointablewtoinndclosure.laoutistained


namely umerpterordsnon-pinfoterordsthecertain(Thisyinformation,con


haopeldasFigureoseeacdo.lothattheirlaork,outof


invingthe\Otherthe
thetheloinfo"unrolledofthespecial-purp4.)Theythen49routineshuseaNoticeoptodothewyinsteadinforma



tionisstoredinthe(static)infotable,sothereisnoextracostinallocatingtheclosure.The


onlyisextratheenetcostis\generic"inexecutingthethatopsintheareoutcollectionointerspreceding


Itforexecutionbtheseroutinesloclosuresgarbagelaidproutines.

non-pinformation.ointers.ItThisalsoconmakvenestionitmoremeanslikthatelythatonlytawclosure'sonumberslayareoutrequiredwill\t"toaencostandarddethela
lalay
yyout 
outout

directlypointerssuppandortedtwoof
ofofbypointhetersruntimecanusesystem.thesameForexample,routines;alliftheclosureslayoutwith
withwithcontvwenotionwordswasofmorenon


libcarrieseral,nothererunwtimeouldcost,beaofnumcourse.berofdierentpossiblelayoutsofsuchclosures.Theconvention


7.6ThereTheisonestandard-enparticularplacetrywherecodewforehaavefoundthattheuseofCpreventsanobvious


co
cocode
dedelabimproels.vemenOneoft.theseTheinfoisusedpoinmteruchofmoreaclosure
closureclosurethanthepoinothers,tstoanamelytableconthetainingoneusedanwhenumbertheof


closureisentered.

Itthewrestouldofbethebetterinfototablearrangejustbthateforethe
thetheinfocode.poinThen,terpenointeringteddirtheectlyclosuretothistakcoesde,oneplacingfewer


indirections,theinfopointer.buttheotherinfo-tableentriesarestillavailablebyusingnegativeosetfrom


Thisdoesn'tisusuallyallowthequiteprogrammereasytoarrangetospwhenecifygeneratingthatanarranativye(thecode,infobuttable)eventhemustGnuimmediatelyCcompiler


precedetherstwordofthecodeforafunction!

Waddresseabstractoftheawclosureayfromtothisbeenissuetered.byTheusingusualaCdenitionmacroENTER( 
ofENTER 
c 
is:) 
,wherec 
containsthe


8Stac#define 
ksENTER(c) 
JUMP(**c) 


The.
abstractThe
TheTheTheargumenreturnupdatemachinestac
stacstactstack,
k,k,conk,whic
whicwhictainswhichhcon
conconhthreecontains
tainstainstainsstaccontinupks:adatemixtureuationsframes.offorclosurecase 
addressesexpressions.andprimitivevalues.


8.1questionOnestacis:hok?warethesestackstobemappedontoaconcretemachine?

The
TheTheasinglethreeconcretestacksstacallopk.erateTheinmasyncjorreasonhrony,wsoe50itchowoseouldnotbetopossibledosoistotorepresenavoidtconfusingthemalltheby 



garbagecollector.Thegarbagecollectormustuseallthepointersinthestackasasourceof


roots,wandhmstacupkcationsthemtoclosurepointtothenewloandhofcoclosures.addressesus,itprimitivneedse


knowhicustlodateareaddressescationswhicarethedeThorto


vTherealues.areacoupleofwaysaroundthisproblem,whileretainingasinglestack.Onepossibilit


isThistodistinguishisanuisance,poinbecausetersfromitmaknon-pesarithmeticointerswithsloawtager,andbit(usuallybecauseitmakleast-signicanesstandardt32-bitbit).


oating-pointenbersimpisItrequiringalsoratherrunagainsttesting.spiritofourtation,
whereallyptinformationumossible.static,isnotimetheimplemen

AnotherJonespSalkildydescribusesinanearlierbit-masksersionoftheciatedTthe
thethedeG-macointo(Py 
yy

tonossibilit&,[1989])edstaticvassoSpinelesswithaglesscophinetedey-b


returnhaveintroaddressesducedtheonideathestacoffully-edgedktogivetheunbstacoxedklavalues,yout.whicThishwfatallyorksne,woundsbutthissincetecthenhnique.we


Consider,forexample,theprogram

argumenHere,whentpick 
h 
stacb 
pick 
n 
k.b 
. 
f 
isThepick 
g 
called,. 
lastif 
b 
(+# 
theofb 
then 
thesefour1#) 
argumen(-# 
f 
willelse 
1#) 
presumablyg 
tsn 
b 
,(+# 
b1#) 
eprimitiv,(-# 
1#) 
e,since,andlatern 
will(+# 
be1#) 
ontheor


(-# 
during1#) 
thewillevaluationbappliedofb 
to,therthem.eisNonowcontexthereisinformationthepoint:ifavailablegarbagetocoltellelctionthatistheinitiatebottomd


argumentonthestackisprimitive.

Tthisoconclude,cannotcopusinge
eewithasinglefully-edgedstackseemsunbotoxedrequirevalues.runtimetagging;previouswaysofavoiding


8.2Twostacks

Theobvioussolution,whichweuse,istoprovidetwoconcretestacks,A-stackforpointers


thenon-ptheB-stacointerkstacfornon-pkwasoincalledters.theThisV-stacwask,theandsolutionanumadoptedberofsubsequenbythe
thetheG-mactsystems.hine,whereThe


nomenclaturet"wuseistakforfromvtheABCHoevhineour(KoopmantiswherebeenstandsA


for\argumene\B"enbasicalue.wmacer,argumen[1990]),ksplitet\A"the


and
andandBapparenks,and
andandThethestacconmappingothereacthingsofbabstractnon-pkstertheseargumenw
wwts,concretewill


becomestact.Bdetailedktainsofhtheesidesstac
stacstacointotoas

stacTheksstaciskgivpenoininterssubsequenareheldtinsections.specialregistersSpA 
andSpB 
.Likeothertwin-stackimple


menvtations,wetheethehastotksofwwleft;eacthisother,er,aoidA-stacriskgroonetoards


oerowhilewmakotherwplenstacygrospacetoardsinhpaptothevthekthatwswwill


lowaddresses.fromInourheap.tialtation,thisstacspaceisallocatedinaxed-size


area,erseparatethesequenimplemenk

51 



9areCompilingnowatlastreadythetoSTGdiscusslanguagethecodewhictohCisgeneratedforeachoftheconstructs


inecause,theSTGasremarklanguage.edearlier,Thissectionanabstractisrathermaclonghineandcandetailed.onlybeconsideredWemakeanosuccessapologyifitformapsthis


wW
WWelle
eebonegintoconcretewithanoarcverviewhitectures,thewithcodeplengenerationtyofoppproortunitiescessforforanoptimisations.arbitrarySTGexpression,


b
bbyconsideringCalastacf
ff.viasequenceAslsks,itstowadjustsenon-built-ininfothediscussofvtable,statemenariousthelater,Aorfunctionssynandof
ofofthiststacticjumpingwhicB\enstach(Sectionformster"kpushespdirectoinmaantersy9.2).theexpressiontaktototheeargumenThethetheirappropriateformexpressionnalcantsofatakv1 
alues,en;:eteringco:(Figuref:;dea
aaand1 
n 
;for:onthe::entof3):;.aclosuretersn 
theisthecompiledappropriatebfunctionoundto 
toto

let(rec) 
islamcyclic.thecompiledbsameda-formwexpratolfy,1 
essionsa;the:sequence::;onlylfn 
(Section,follodierenceoflet 
wstatemened9.3).x1 
by. 
btheThelfeing1 
ts; 
cowhiclet 
:that:de:; 
hexpressionforxallothen 
e. 
.cateslfclosuresletrec 
n 
in 
aeclosurealloexpressionscatedinthetherebareheaptreatedyformayeacbinhe


Ifthe{
{{A(SeeThelamseparatebSectiondeclarationda-formblo9.2.1lfci 
kisforoffornotcoawhdestatically-initialiaystandardlabitelledmaybxconstructor,i 
e_entry 
usefulsed,arratoobtainedgivytheexthis_info 
cobdeycocompilinggeneratorde,whicanextrahisalsothe
thetheenbtryprooinfodyduces:poinoftablelft.)i 
.


BothatteningconstructorLitertoIfstractbadjuststopopThiseddedtheerationstatemenofalsforxmakofi 
lamC)the
thethe
_entry 
inandthesexi 
espbis
.proBtheermittingda-formtsAThecanitpstacccesserformedal.
whicdeclarationsandsoundmiddlelsbk.rsteofishBisAused,loadpbuilt-innestedstacelemenasacallerformedof
rst.standardifk
kkandthetoevarepintdeclarations.oinaeryoptocothereofhoistedertersafterdeathebuilt-in
built-inbuilt-inconstructor,atorsregisterforistoinfoconooptheirtheout(Sectiondetableneedop(exactlygeneration,let 
toeration
erationerationnalthe
thethetoisexpression.9.5).w
(thegeneratevtopsharedorksalues,whicislabassoAlevtheinhi 
primitivelel,
andinforegistertheciatedxinofi 
Inrathertermediate_info 
)
returnssametabletheourewithdepliteralstandard-enandthanwcoforaendstodeyaxexceptdatathe
thethereturn,
appi 
generator_entry 
konappropriateisearingaddresstkypcompiledtry
'sthatbute.
typ(Ab-coem-thisthee),onande


easyoptimisationallowssequencesofbuilt-in52operationstobecompiled(Section9.5). 



case 
ispushescompiledexprareturnessionstocoaddressde(Sectionwhichon9.4).savesTheBanstacycase 
primitivvolatilek,efolloof 
evwariablescase 
pedaltsbyexpressiontheusedcodebyforpaltse.onAnthearbitrarystacks,andbut
uniqueanvTtoinitialisedtheThe
TheTheofectoropyconestednon-defaultco
cococoleveldede
dededeislabpushedfor
forforbindingsones.compiled
compiledcompiledelarralamisalgebraicyinEacbalternativginsteadvfromda-forms,en
_closure 
(Sectionforhteddeclarationcase 
p
ppalts
altsaltsforofes)a.
this9.1).the
thethe
,expressionspreturnfollowhicerformsreturnenwTheghtirei 
edaddressrepresen. 
bcaselftop-levcoaddress,yi 
isdeisthesimilar,analysiscompiledblo(Sectiontselcocthedewhicbindingskisexceptforstaticonhoistedh9.4.3).toeacisthetheusedarehthatclosurealternativvtodeclarationaluetreatedto(thethelabreturnedfortopaddresseleagaexpression.lev.littleofseparateAnel.(ifaofdierenstatically-info)thereareturnblotableLikaretlycke


Tofollomap 
gStandarbindings.lamconstructoreni 
_info 
etryb. 
(seeda-formsco{} 
ddeandideasc\n 
onstructorsforbstandard-eneingcase 
{f,xs} 
whiceacconcrete,4.1):
i 
husedhxs 
constructorare-. 
(Sectionof 
instead.standardtryFigurecode-blo9.4.2).declaredIt5givisconstructors,thereforeckAsthegini 
_entry 
alreadythecodenecessarymothecompiledaremendule.sharedalsotioned,toforprogenerateinfoducednotableco,whosedethisjustandi 
isinfogeneratedasSTGcofordetablecofornesteddeandthefor


asmakwstheseSectionesmap 
is


ThiscodeiswrittenassumingNil 
Cons 
{} 
{y,ys} 
that-. 
->->listslet 
Nil 
in 
useCons 
{} 
fy 
mfy 
avectored. 
{fy,mfy} 
. 
{f,y} 
{f,ys} 
return\u 
\u 
{} 
con{} 
-. 
v-. 
enf 
tion,{y} 
map 
and{f,ys} 
Cons 
returns


itsTheargumenrestofthistsinsectionregisters,exploresmatterscodewhicgenerationhareexplainedinmoremoredetail.fullyEacinhSectionsubsection9.4.corresponds


tothelanguage.umeredsubsectionofSection5hes!theoperationalsemanof


theSTGsimilarly-nbwhicgivtics


9.1Theinitialstate

Themachineisinitialisedtoevaluatetheglobalmain 
,withemptyargument,returnand


upcondatetainsstacaclosureks(Sectionforeac5.1).hglobally-denedTheabstractvariable.machine'sWeinitialimplemenheaptisthisnotbyemptallocatingy,butaratherstatic


closureyCforel,hushariableely(Sectionthe7.2).er53tohofimplementhesethecanbenereferredtotdirectly.


bitslabeacthsuceectivvusinglinkEacclosurestglobalvironmen


SmSm}tatagpgpW_W_.J.Soeod.UprnriMBdtdraPs[remmr(t1ycaaga](tmppuc)(a=__mk){picero{_nlnevdfotteioss_rruavfe]rtelce=icot[s1w]{)f;m=;caaShc{ppetmBciaekop=n._tScirphnyBef,+co.1k}.;.;..r.est/o*fPiunsfhorteatbulren.vec}tor*/ }Sr}etgtW_SJSNnopUpoirBMAddlPe1==r((e=)SRStpe{pS_BtApv-V+Ae1e2[c;c;11R][Re;]egt=[V0e{]crER)eNe;tTg_EnR=i(lSN1po,Bdu[ep1d)]_;;nil,///*r**eGtEPr_noactpboeanrrrsexg1tss,ur*u*n/p/dv_eccotnosr};*/ retHH/./HRcpp*.*peo[[.tnR=A--hDsel25ea1Htl]]at(puopa)==rc1+o{namf=vt6fyt/ee;y_&h*r_fiHefHiynplcenf[ooaafo-wnndo;5scd;]Hah;cmHpneRefp[dcely[-kttl-4.aD1].**ia]./=/lt=aSi2Spnp=ArA[e&[0gH0]sp];[;HR-peH2[tp]-D[;3a0]t]==1RRaeenttdDDRaaetttaaD12a;;ta2*/ fS}yt_geW.SJSnopUptrBMArdpsP[yfut(-(ysa1)SR_hc]{peikBut=n-opVfN1vdeoo;eac[drtR]Refeee=[lgtf2o[{Vr]w2fea;]cycmS)h_Repeee.Acngkt.==.rySS.,ppBA.[-.11.];r;esS/tp*oAfT=PhuiiSsnsphfAoiy+st2*aa;/bnluep.dat}ablethunk*/ }mS}ftyg_WSJ.NeopUonrAMdtd[Pserm-(tyf1a(my]c)aN[k{=po]o_dN=vdeoei[drr1{efem[lc;f2otEy]w)N_;;cTeShEnpeRtAc(r[kyN-,.o2..d]..e=.)rN;eosdteo[/f1*]i;EnSnfptoAetr=afbSlp*eA/.-.2.;}/*Pushf,ys*/ Figure5:Thecod5e4generatedformap

9.2Aplications 

ThecodegeneratedforapplicationsfollowsdirectlyfromRule1intheoperationalsemantics,


and.
consistspushenterthe
thetheofargumenclosuretwosteps:whictsonhtherepresenstacktsandtheadjustfunction.thestackpointer,

Wtheebindingdiscussthesestepsseparatelybelow.Beforedoingso,hereisasmallexample.Consider


Thefollowingapply3 
code. 
is{} 
generated\n 
{f,x} 
for-. 
thef 
application{x,x,x} 
f 
{x,x,x} 
.Whenthiscodeisexecuted,


apointertof 
isontopoftheAstack,andunderitisapointertox 
.

9.2.1EnNode 
SpA 
ENTER( 
t 
SpA[0] 
SpA[-1] 
tering. 
. 
SpA[1]; 
. 
SpA 
SpA[0]; 
Node 
. 
a. 
t; 
closure-t; 
); 
1; 
/* 
/*/*/*/*/*Grab 
GrabGrabEnter 
Adjust 
Push 
f 
x 
extra 
f 
into 
intointostack 
*/ 
args 
Node 
a 
pointer 
local 
*/ 
register 
variable 
*/ 
*/ 
*/ 
Whatdoesitmeanto\enter"aclosure?Afterall,theoperationalsemanticshasquitea


fewrulesthesewiththeEntertostate.closureTheeingtered,Tthatmaccodevtoesrespteronsibiliclosurey


foralldealingcomplications thebSpinelessenaglesssothehinedeolvenat


issimpleaandeuniform.enterdepthergister,wingNode 
erysimpleeenpcontoenforeThe


whenclosuriseWaestablisharticularefollothevrgister,tryointsvtionclosurclosures:.


coAlldefor\caller"theclosurehastocandoaccessistoloaditsfreeapvoinariablestertothebyindexingclosureindirectlytoNode 
fromregister,the
thetheNode 
andregister.jump


tothe
thethecanvetrycodeoneforthetoviaitsdepinfopoinon(Asparticulardiscussed,tation


jumpstandard-eninolveitherorwclosureindirections, endingter.the
thethepreviouslyrepresenthis


chosenforclosuresandinfotables|Section7.6.)

Itclosure.map 
isp,ossibleforManymaksomeEnareusefultooptimisationshatfunctionstopcanthiselproethecess,program,mhenmoreorteringecienstandardathandatable


(example).tofunctionsetrydenedsucthetolevbofmadewhenucinnon-uptlibrariesthe


standard.
SucTheclosure.one,henrathercoatrydefunctionmeclabthanelhanismforhasindirectingthenojustfunctionfreedescribvviaariables,theised:staticallyinfoso55pthereointer.determined,isnopointsointhemakingjumpNode 
canpboineatdirecttoits 



Oforthese.
atSectiondardThe
TheThectoThisfrequenonhecaleastthef 
ksargumenpcoshouldones.oin
. 
decanstactlyconsider
9.3.2this
{} 
tvgenerator(calledbkoftenInbegin\n 
nant-passingebumparticular,beloywts,{x,y} 
enecial,b
bbbw).theaereyallybkno
.evexpressionofypasseddirWIndeed,
butaluatingcon
-. 
wseeargumen
argumenargumenbutct-entryhavthelet 
hoenvepwtionaswith
rsterhapsnotoneg 
mantsw
. 
tspatell.isyointcanaofy
{x} 
etcanthebbitlessargumeneingtheirimplemen)
bbdirect-enjust
\n 
emoresoeappliedsuppliedpassedargumenthan{z} 
aftertsclevted
(iftryin-. 
theerness,intoabanthists,+ 
pystrictregisters.looinargumeny)the
{x,z} 
cally-denedsoidea.tthe
thethethecancall,language,closurestacotherstbtheesatisfactiondierenkjumpandisfunctionsbhaecauseexpvheapetcanecting,to
totocfunctionshecthebboaseeveroksamadestan-wso(seevedwif


Fexample,improementheell.


Thetog 
canbemadebypushingin 
g 
{y} 
itsargumenty 
ontostack,loadingapointerto


thecall
callthethecallclosureistoforafunctiong 
intoNode 
whose,anddenitionthenjumpingisstaticallydirectlyvisible,tothethe
thetheappropriatecodegeneratorcodeforcang 
compile.Since


directjumps,includingbypassingtheargumensatisfactioncheckwhereappropriate.

Weneedtotoviaeainfobitpoincareandwhenenerantodatablestandard-enclosure.Incode,casebwean


jumpittakitsmoreter,nevteringdirectlyupitstrythisecausemust


upNode 
datepoinmighttothaveclosure,changedsincetheinfothepstandard-enointer!At
tttryrstcoitdeseemsanthatupwdatableemustclosurealsoalwbaeginsysmakbye


pushingcodetopushanupdateupframedateframerecordingiscompiledtheaddressindividualloftheyclosureeactohclosure,beupdated.wecanButarrangesincethefor


itNotooptimisationsincludethe
thethethestaticatalladdressapplywhenoftheenclosureteringinthetheclosureupdatefor
forforforframe,alambratherda-boundthanvNode 
ariable,.asin


thecaseofapply3 
above.

9.2.2Pushingthearguments
\Pushing tsontothestack"isnotquiteassimpleasitsounds.

Firstlyonthe,appropriateargumen
argumenargumenstactsmak.yThebeaargumenmixturetofstacpoinktersoftheandopnon-pointerssoeacticshmisusttherebbepushedysplit


betweenthe
thethetheAandBstacks.

partlybloimplemeninstacthestacquitembvtionalerational
erationalerationalthemanlanguageticsvironmen


Secondlytions.Ity,means,incationsourthough,thetationthatks.theThisenvironmenksisusttconeofclearedentheopofinaccumyseman
semansemanulatedisimplemenenrepresentedta-t


Of(orcourse,perhapswejustneedparttooftakite|alittleseeSectioncarehere:9.4.1)webmeforeustnotpushingoverwritetheargumenastacklotscationtothewhiccall.h


containsavaluewhichisrequiredforanother56argumentposition.Thereareseveralwaysto 



solvethis,thesimplestbeingtomoveallthethreatenedlivestacklocationsintoregisters


Here(whenisgeneratinganexample:C,localvariables)beforestartingtooverwritethem.

Onentobut,x 
andthewillbeorder,ontheatk.Itimmediatelyonemcallsg 
beusedhrequiresthe
thethesamek


argumentryts,f 
. 
f 
{} 
in\n 
{x,y} 
y 
other-. 
g 
{y,x} 
sostacleastregisterustwhicduringstac


rearrangement.

Suctheapphargumenearforinrecursivthet-shsameuingeposition,isratherwhicunwhichusual.passhcaseItismargumencoucdehneedmoretsalongcommonegeneratedunchanged.forattheall.sameThisargumenisoftent


tocasefunctionsinsomenob

9.3let(rec) 
expressions

Asclosurementionedintheheapearlier,forlet 
eachanddenition,letrec 
folloexpressionswedbycoalwdeystocompileevaluatetothecodebodywhicofhtheallolet(rec).catesa


Eachofthesetheclosuresexpressionconsistsofaninfopointer,anda
aaeldforeachofitsfreevariables.


compilestocodewhichallocatesaclosurelet 
in 
ef. 
forfsf\ 
,andxs-. 
thenbcontinueswithcodetoevaluatee.


F
FFor
ororexample,
example,example,compose 
consider. 
{} 
the\n 
denition{f,g,x} 
of-. 
compose 
let 
in 
f 
gx 
:{gx} 
. 
{g,x} 
\u 
{} 
-. 
g 
{x} 


Thecode/* 
Hp 
if 
forAllocate 
. 
(Hp 
theHp 
b. 
o-dyHLimit) 
3; 
ofheap 
compose 
block 
runs*/ 
asfollows:Allocate 
Heap 
exhaustion 
some 
heap 
check 
*/ 
*/ 


/* 
Hp[0] 
Fill 
{ 
&gx_info; 
in 
...trigger 
closure 
for 
GC... 
gx 
*/ 
}; 
info 
pointer 
*/ 


Hp[1] 
Hp[2] 
. 
===SpA[2]; 
SpA[1]; 
g 
x 
*/ 
*/*/

Here,gx_info 
/* 
Node 
SpA[2] 
SpA 
ENTER( 
Call 
. 
is. 
SpA 
the. 
SpA[0]; 
Node 
f 
&Hp[0]; 
statically-allo*/ 
+ 
2; 
); 
catedinfo57table/* 
/*/*/*/*/*/*/* 
/*/*forPush 
Grab 
Adjust 
gx 
:f 
gx 
into 
SpA 
*/ 
*/ 
Node 
*/ 



static 
int 
{ 
gx_info[] 
&gx_entry, 
&scavenge_2, 
&evacuate_2, 
. 


Inthisinfotable,gx_entry 
} 
... 
isthenameoftheCfunctionwhichimplementsthestandard


enperformingtrycodeforgarbagetheclosurecollectiongx 
.onscavenge_2 
closuresconandtainingevacuate_2 
twopoinaretersrun(Sectiontimesystem7.3).routinesfor


9.3.1ThealloAllocationcationoftheseclosuresisstraightforward,andwasdiscussedinSection7.2.
Referencestodynamically-allocatedclosureswithinasingleinstructionsequencearemade


bofytheosettingheappfromointer,thesoheapthatpoincorrectter.(Theosetscocandegeneratorbemadekeveepseniftracitkisofmothevedphbysicalyinstructionsposition


withinNoticethe
thethebasicusehereblocofk.)theterm\singleinstructionsequence". Inparticular, methodof


addressinganevaluationcannotmaysurvivtakeaneounverboundedevaluationamounttriggeredofcomputation.byacase 
Notexpression,onlythis
thisthisbecausemovesuch


heaprelativpeoinpositionsterunpredictablyoftheclosures.,butitInmashort,ytriggeratthegarbagetscollection,intheoperationalwhichma
mamasemany
yyrearrangeticswherethe 
thethe

theontheenvironmenpointerstactkis(Sectionsavedon9.4.1).the
thethereturnstack,ap
ppoin
oinointertoeachliveclosuremustbesaved


9.3.2Thecodeforaclosure
Mucwhichhmorewillgetinteresting,executedofifcourse,theclosureistheisstandard-eneverentered.trycoThedeforstandard-entheclosure.tryThiscodeisfortheevcoeryde


closurebeginswiththefollowingsequence:

ArgumenItisonlytsatisfactiongeneratedifchectherek.areThisoneconcernsormoreupargumendating,ts.andisdiscussedinSection10.2.


Stack(ifaovoparalleleroverowstaccwmacheckscheckarehine,cank.organised\lowhicIftheokhahead"wexecutiontoorksgrowithwinto
totoofwmanallardstheyclosureeacstacbranchks,other)canhesdierenofcausecollide,antyactioneithercase 
executionisexpressionsstactakken.)toishalted.ovThiseroinvolvstacw,(Onedork


Heapincated.course,brancofovthe
thethecomputation.erohes,evThisifaluationwtherebecausecwhecasisk.discussedofnotheAthenetsimilarevclosure,aluationstacinkSectionchecgrotakingimpliedkwth,is7.2.pthe
thetheno58erformedbThecywhecorst-caseacase 
kheapisforpcancerformed.heaphecpathpkerformcannotoasverotheanw,olovunokeroifbanaheadoundedwycriterion.heapintoamouniscase 
allo-Oft 



Infop
ppovoin
oinoinerwrittenter.terThisupdate.withisdiscussedaIn\blacthekcasehole"inmoreofinfoandetailpupoindatableterbeloor,w(Sectioninclosure,aparallel9.3.3).itssystem,infopoinater\queuemayme"nowinfobe


Updatetheitsstacheadframek,uparedatenormaldiscussedconstruction.stack.form.ThisinThedetailactionFimplemenorincausesupSectiondatabletationalater10.closuresofupupdate,dates,onlywhic,andanhupothedateerwritesmappingframetheisofclosurepushedupwithondateto


Codeisnowgeneratedforthebodyofclosure,withthefreev
vvariablesboundtoappro


priateoinosets(LikmantheotherNode 
register,andoursthe
thetheeepsktswhereosetsfromstacthepterspstact


pters.fromeycompilers,kargumentracoftothekappropriateoinareoink


ingwithinfromcurren
currencurrenstacationpter.)record,sothatatytitcangeneratethe
thethe

osetthe
thethet
ttactivkoinanmomencorrect


9.3.3Blackholes
Whentheanupdatableinfoclosureoiniswithtered,standardstandard-entrykcodeinfotheointerortunitprotobvtheer


writeclosure'spterenaits\blachole"poppvidedyyo


runtime
anIfIftheretheasystem.error.closureisclosureaThisletrec 
ns 
l 
seriousWhilst
. 
is. 
is
{} 
situationleftev{} 
riskera 
\u 
thisundisturb\u 
re-en. 
{ns} 
of1+a 
{x} 
opoateredccurserationsp-. 
->->acin 
edebin..x.. 
last 
eforeuna 
leprogramscostsaktil.{ns} 
ititFanorisisupexample,instruction,nallywheredated,auptheconsidervdatedalueitblachas
hashasdepwithkthetholeendswoSTGitsadvenontryheadanitself;denitionstages:conormaldeforcanexamplerepform,ort


whereunk..x.. 
prol 
ducesleftsomevedlongtilisandlast 
upreturnswiththelastlastelementofatlist.theIf

thethforisundisturberyunlist.itnallydatedtheelemenof


Itisalsolist(Thisholepoinpns 
ters.ossibleimmediately,niceitwillexampletoretainobtainitais
isisbpdueothenointeredtertotheseJonestosolvtheadves[1991].)anenthistagestirespacelist,inOvarathererwritingslighleak,tlythanbecausemoretheconsumingthsubtleaunkblacforwkitaholeyl 
incremen,withwithoutretainsablactallyper-nok.


formingbyblacktheholesblacalwk-holeaysoresultsverwritinginstacoperation.koveroFirstlyw.The,non-terminationcauseofstacofkoveroformwdetectablecanthen


easilysamebedeterminedclosure.Thisbycannoticingonlyhappthatenthereifitsisvmorealuedepthanendsoneonpoinitself.teronItisthe
thethealsoupdatepossiblestacthatkto


the
thetheerrore,ecauseobtainableenfromcollectionapost-mortemclosures59oftheveddatethe
thethekendenbratherlocan


informativmessagebthetireofinolvupinstacself-depcouldetopmore 



loSecondlyecationidentied,informationweand,addresssincethecouldtheyspace-leakballshostillwnquestion.hatovo.theiroriginaltheaboinfoveexample,tablesattacthehed,pointertheirtosourcens 
retainedcode


b
bbydatedl 
onlybmattersetweengarbageatgarbage-collectioncollections,sotime.thatnoIn
InInalmostspaceimproallcasesvemenathtisunkgainedwillb
bbeyenovterederwritingand


withunderaevaluationblackhole.atWhatgarbagewe
eecolwleouldctionliktimee
eeto.doHappilyisto,black-holeareexactlyonlythosethethunksthunkswhichtowhicarhe


thethatupinsteaddatestacwekbpeginoints!garbageSowecancollectionsafelyomitbyblacthek-holingblack-holeallupthedatethunksonthpunkointedentryto,profromvided


up
upupSincebothstack.thesetechniquesrelyontheupdatestack,they
theytheyonlyapplytoupdatablethunks


(upstandard-enagu 
).IfcoaunkFthisnon-upin(upimplemenagn 
)itmwhastillewevk-holedtsthe 
thethe

itstryde.thorisreasondatableourdatetationustevtboblacarianofy


n 
upk-holed),date
datedatedateag:andr 
fors 
forreentrsingle-entryant(the(theclosureclosuremaywillbeenbeteredenteredmanatymosttimes,once,andandshouldshouldnotb
bbbe 
ee

blac
blacblacwhilek-holed).thes 
agTheisonlyr 
agusedisusedforthforunksmanifestwherefunctions,updateanalysisconstructorshasdeterminedandpartialthatapplications,anupdate


isnotrequired.

Inunkaparallelwithsystem,\queueme"thestandard-eninfoointer(SectioncodeforanupUnlikethethunkk-holingshouldvaerwritesequenthe


thaptry3.1.3).datableblacofotial


system,thisoperationcannotbepostponeduntilgarbagecollection.

9.4case 
expressions

Ptheatternmorematcsoinhing,theviacase 
expressions,TaglessG-macishineutterlybecausepervasivtheebinoxinglazyandfunctionalunboxingprograms,operationsall


of
ofofthearithmeticstrengthsareofdonetheSpineless
SpinelessSpinelessusingcase 
TaglessexpressionsG-Macratherhineisthanthattherebysomeisaadratherhocmecrichhanism.designspaceOne


forhowpattern-matchingcanbeimplemented,includingsomeratherecientoptions.

case 
expressionsseman(andthisonlyexpressedexpressions)ycauseaevuationtototakeInstacandop


erationalticsiscase 
bpushingcontinaluationontheplace. k,

evaluatingfortheexpressionexpressions.bescrutinised(Rule4).Thisismirroredpreciselyythe
thethecode


generatedcase 
tob

Inisimmediatelycodegenerationfolloforwedmostbyalanguagesfunctionthecall.actItofispushingworthnoticingacontininuationpassing(orthatreturn
returnreturnthisaddress)isnot


thewhiccasehpushforthe
thethecontinSTGuationlanguage;andthethereinstructionmaybea(ifsignicanany)whicthgapactuallybetweentransferstheinstruction(s)control.For


example,case 
considerof 
... 
(case 
theexpressionf 
x 
of 
...) 


ThecontinthetoforistheouterFprogrammersispushed,60thenthiscontinofde,foritinnerascase 
result,


thencalluationf 
made.ewcase 
writethesortuationcobutthearisesaand 



ofprogramtransformationswithinthecompiler.Theorderofthetwocase 
expressionscan


beinterchanged,butonlyattheriskcodeduplication.

inthe1.mainoperationalalternativpointofsemaninesterestofticstheisconsistscase 
howcontinexpression.of
ofoftuationswoparts:arerepresented.Recallthatacontinuation


itivvandtationalternativsoetimatelydiscussion thewithtopictilfolloprim


The
TheThesections.2.erepresenThe
TheThealuesEnenvironmen
vironmenvironmenconstructors,oft-satvinginwhicisesindephwistheyinendendefershouldtofbconnectedconstructors,eexecuted.ofsorstthewecodiscussdegeneratedunitrst.theforwing


9.4.1Savingthelocalenvironment
livis,itvironmenisthevbsainwywhicaluesariableariablesedh

Theonewhere(thatlocalencurrenfree)intlyantresides:yofsaedalternativyvinges.Thethestacainksthehvaliveofvallvissavwhicdependsare


pItossibilitiemaybes:insaveclosurevariablecurrenitself,tlyorpoinsatedveNode 
tob.yNode 
.Inthiscasetherearetwo
.
NocaseIt
ItItTheofsevma
mamacolatterity
yyeraldemalreadybeneedustvinreducesariablesbaebregister,besaegenerated.vinthe
thetheedataonce.innstacorumtheitk,bOnerappropriatemaforoftheyexamplesabeothervesboundbecausestachand,ifittok.wanansaasvingosetextraanargumenNode 
memoryfromeectivthettoaccessheaptheelysacurrenpisoinvsubsequenester.thetclosure.Invaluesthistly


requiredAnothertoproblemgetwithvaluesavingoftheNode 
variable.isthattheentiretentsoftheclosuremustthen

beitsretainedbThegarbageavoidanceevenhanismsthoughthecon
conconeduationSectiony9.3.3cannotusesomee

ofelds.yspace-leakcollector,mecdescribtininmaonlyb

applied.whichelds(Itisofpthe
thethethetheossibleclosuretorescuearelivthee,butspaceitisbehacomplicated.)viourbycompilingabitmasktoindicate

WhenbelongingOursavingtocurrenvaariablesvtariablepolicywhicinishatostacareavoidnok,w
wwtheseedead.candicultieseconomiseThereisbalsoyonsastacavingusefulkallusagesidevariablesbbyenet:re-usingindividuallythestacstructurek.slots


oesuclivwithstactoespacetothedeaderimen


p(thoughvoinerwritingtedwtobhayvdeadehpoinypetointersdoneterswithso)intheeonesgeneratingkhelpscannotextrabavoidreclaimedinstructionsleaks.byoOnevgarbageerwritecouldcollector,exppointerssot


whoseslots\stacarestubbing". not
notnottobereused,specically61inordertomaktheirspacereclaimable. e


callthiskeW



9.4.2expressionConstructorscrutinisedapplicationbyacase 
sexpressionmusteventuallyevaluateeithertoaprimitive
vprimitivalueoreacaseconstructortoSectionapplication.9.5. Wedealwiththelattercasethissection,deferring

The
TheThecodeegeneratedofthecase 
forexpression,aconstructormakingapplicationtheargumenmusttreturnoftheapplicationcontroltotheavailableappropriatetothe 
thethe

alternativ
alternativalternativ5,let 
e.6Thishd 
7).is. 
just{} 
what\n 
{xs} 
isdone-. 
bcase 
Cons 
Nil 
ythe{} 
xs 
{y,ys} 
rulesof 
for-. 
-. 
constructorsy 
error 
{} 
{} 
in
inintheoperationalsemantics


(Rulesand

Forexample,considertheexpression:

wherew 
andin 
hd 
{single} 
ws 
single 
arebound. 
{w,ws} 
bysome\n 
enclosing{} 
-. 
Cons 
scop{w, 
e.Thews} 
codegeneratedforthecase 
ex


pressioninthiscase.inhd 
ThepushescodeaforcontintheuationconstructorandenapplicationterstheclosureCons 
for{w,ws} 
xs 
,whic,inhtheisbboundodyoftosingle 
singlesingle,


shouldreturnerconstructortroltotheappropriatealternativinSTGreturningareandws 
ainsaturated.)agreeda.


(Remembthatconapplicationsthee,languagew 
alwyssomewy


There.
ThereisTheneedareselected.tconstructortowmaobmaineycommbeaspsevforunicatederalectsaalternativparticulartoconsider:tothees,coalternativsodetherefortheeismaalternativtheyhaquestionveargumene.ofhots,wtheinwhicappropriatehcasetheseone


Thesetwoissuesarenowdiscussedinturn.

9.4.3Selectingthealternative
Thesimplestpossiblerepresentationforalternativesisasinglecodelabel,whichwecall


arthelabaddrelled,depushedonevtheBofk.the
thethescrutinisedtrolisreturnedjectycompleted.constructorapplication


toeturnesscowhenaluationstacConobbisthe

Ifoftherethe(single)isonlyalternativonememebcanerofprotheceedalgebraicimmediatelydatat.ypIfethere(tuples,ismoreforexample),thanonememtheevberaluationofthe


typswitch 
(lists,forexample),tgeneratedthetagofthepobjecttheputanalysistoaparticularRTag 
.(InRTag 
nativ,de


Cestatemenistoerformiscaseinonregisterae-coanda


generator,thismulti-wayjumpcanbecompiled62usingatreeofconditionalsorusingajump 



BstackReturnvector

--
-Co
CoCode
dedefor
forforNilConsalternativ
alternativalternativee

table,dependingonthesparsityFigureofthealternativ6:Vectoredes,butreturns usingCasourtargetcodeallows


delegatethischoicetotheCcompiler.) 

Thisisnottthealternativpbarepresenafortheofalternativdeels,Anotheroneptryossibilittableis


representheonlyossibleesyptationtablecolabes.witheninyto 
toto

whiceachhisscrutinising inalist.thedataApoin
oinointypter
tertere.Figureto
totothis6table,illustrateswhichwesituationcallareturnforavecase 
ctor,expressionispushed


onBconstructor
constructorconstructorkythecodeforcancase 
conThen,directlyinsteadtheofloadingRTag 
destination,the
thethede


for
forforthe
thethestacbapplicationthetransferexpression.troltoappropriate,co


thvectorussaedvingreturnajump.addressW.ecallthisavectoredreturn,andthe
thethepointertothereturnvectora


Theimportantpointtonoteisthatthereturnconventioncanbechosenindependentlyon


adatatypbyype.Inebasis.wA(somewhatcase 
expressionusewillectoredonlyscrutiniseforobjectstesa


particularetdatatyppractice,eparticulararbitrarily) vreturnsdataypof


withuptoeightconstructors,becausethiscatchesthevastmajorityofdatatypeswithout


riskingwasting(code)spaceonlargesparsely-usedreturnvectors.

9.4.4Returningtheconstructorarguments
Thereisacorrespondinglysimpleconventionavailableforcommunicatingtheconstructor


theargumenappropriatetstovalternativalues.Thee:makcodeetheforNode 
thealternativregisterpeoincanttothenaconstructoraddressitsclosurecompcononentainingtsby


indexingfromthe
thetheNode 
registerasusual.

Thistherewareorkssucienne,andtlyfewissimpleargumenenough,ts,returnbutthemamucinhregisters!betteralternativIftheclosureeisreadilybeingascrutinisedvailable:if


isalreadyaconstructorthennotmuchisgained;indeedsomethingmaybelost,becauseall


itsofthem.componenButtstheremaybisealoadedterricintogainregisterswhenawhenthunkperhapsisscrutinised,thealternativbecauseeonlyitmarequiresythereboney


avtegerevbuildingConsidertheconstructorfollotheexample:63Themostcriticalexampleofis

inoidarithmetic.ertheinwingheap.thisordinary 



neg 
itsprimitivisneg 
functionevalue. 
{} 
x# 
whic\n 
,negatingh{x} 
negates-. 
itcase 
MkInt 
toangivinteger.x 
e{x#} 
y# 
of 
,andIt-. 
opthencase 
y# 
erates-. 
returning(neg# 
bMkInt 
yevaluating{x#}) 
{y#} 
integerof 
theinMkInt 
tegerx 
{y#} 
toextract.Now,


underNode 
the
thethesimpleouldreturnemadetovointion,tothebandxedconaluetrolMkInt 
{y#} 
toouldbeuation.instead,inthe


heap,wbconenptit,ovreturnedwcontinconstructedIf,

thecompheap,toftheasresultofupy# 
dateisreturned(Sectioninaregister,Itturnsthe
thethetheoutaluethishasnevabeeectbuilt


intheonenexceptconstructor,an10).vthatneederbig

onAspberformanceefore, imp.ortantpointisthatthereturnconventioncanbechosenonadatatypeby


datatypbyputtingebasisthe
thethe.headIntegersandaretailnotvaluesaspinecialtospcase.ecicFregisters.orexample,(Indeplist\cons"endentlycells,avcanectoredbereturnedornon


vreturnectoredvaluesreturnconalsovenbtionemadecanbindepechosen.)endentlyEvforeneacthehchoicedatatypwhice.Forhregistersexample,aoating-usedto


pointnumbercan
cancanbereturnedinaoating-pointregister.

Forthereasontstirelyenbefore,registers.isprobablyenotamakgoodavirtuetoreturnof
ofofconstructorsywithare
arearemana


argumenengivinitWthereforeeideanecessit(thereonlyy


limitedmakingnumbNode 
erofpregisters)ttothem.andreturnlargerconstructorsbyallocatingthemintheheap


andoin

Itturnsoutbutthatgainreturn-in-registerswwit.vtionesupdatestiallyharder,ase


shallsee,thetheisellorthconenmaksubstanw


9.5Arithmetic

Supposeeitherthattheprimitivliteralscrutinised9),ycase 
vturnswhosetoaluealuateprimitivtoae(Ruleealue;or


thatis,aexpressione(Ruleba
aaariableoutvevisprimitiv10),v


anReturnIntarithmeticstate,operationwhichtakwhoseesactionresultdepisendingprimitivone(Rulethealternativ14).Allesthreestoredoftheserulesenterthe


Thek.returnconventionforprimitivevaluesissimple.The on
onontop
toptopof
ofofthe
thethereturn 
returnreturn

stac
stacstacaluekitselfisalwisaysreturnedareturninaddress,astandardpointingdirectlyregister,tochosenthecontin
contincontinindepuation
uationuationendentlycode.eacThehprimitiv
primitivprimitive 
ee

datav
vvalues.typThee.Forcodeexample,oneforregisteraprimitivcanbeeliteralusedforsimplyintegersloadsandtheanotherspeciedfor
forforvoatingaluepoint


appropriatelarly,thecodereturngenerated
generatedgeneratedregister,forpaopsprimitivthereturn
returnreturnevariableaddressjustfromloadsthetheBvstacaluekofandthejumpsvariabletoit.in
ininto
totoSimi-the 
thethe

returnThecoderegistergeneratedandreturns;atthereturnandarithmeticaddressimplemenfollowsintsthe
thethesamecaseanalysisway.impliedbythealter


nativhes(ifanaariableusingasuitablethealueswitch 
Thist.easilytherebisbindingonlyonealternativvto


whicbindsy),vtovCreturned.statemenisOftendoneytheariablee,


theappropriatereturnregister. 64 


Thereaveryimportantspecialcase,whencompilingexpressionsoftheform:


forbuilt-in2 
andarithmetictoopreturn.case 
Itouldv1 
Theseve2 
pof 
oinaltserationstoaeasilyeaddress,


v1 
v,returntheerationsaddress!wboptlesspushcanreturnb

andtransformationsitis
isispracticallyon0 
theessencase 
rulestialto
totofxdogiv;xe2 
so.gtheof 
Wderive1 
caned" 
expressrules:thisequiv# 
alencebydoing

(18)=where)kj 
6=ie1 
@ 
B 
BBBBB0 
B 
BBB@ 
case 
[xi2 
7!k
kkx::kn 
1 
::Int-. 
-. 
->->->::(1fee(xe
eei
; 
1 
1 
11n 
1 
;; 
;;jx2 
ig2 
)]nof 
)A 
C 
CCCCC1 
A 
C 
CCC
" 
x
xxxx2 
1 
1 
2 
7!
7!7!7!Int
IntInt7!7!Inti
iiIntIntii1 
2 
1 
2 
# 
as
asasrs
rsrsus
usush
hhh. 

(19)=)Eval
EvalEvalEvalEvale::: as
asasrs
rsrsus
usush. 

Inparticular,wherekonce=i1 
.
thisi2 
optimisationisimplemented,theexpression

compilesx 
. 
tothesimpleCstatemencase 
t:fx1 
;x2 
gof 
x-. 
e

wherex 
,x1 
x1x1andx2 
x2x2aretheClocalvariablesusedtoholdthevaluesofx,x1 


10Addingupdates

Sofareverythinghasbeentidy:treereductionisniceandeasy.Sadly,


isTaglessharder,G-macanduphine.datesStill,arewquite
quitequiteebegincomplicated.bravelyenough.Thisismuchthetrickiestpart


10.1RecallupRepresenstacwhenAnclosuredateupenframesconsistsithasthe65opportunitytopushan
thedatethatk.atingupisdateframeteredofup


short-circuited,someevsimplealuate 
andx2 
.


graphofthereductionSpineless


dateframeonto 



Afterstac.
ATheanInstead,pupoinsadatewtervedtoframeargumenetheisclosurepushed,tandtcoptoreturnexecutionbeupstacdated.ks.calledcontinueswithstackreturnemptyrtotoseparateoinjustelodateks.


Ofcourse,k!edon'twdedicateactuallyworegisters,ytheargumenttheandasestacegisterskson,aptupbw


thebnoottom-mostb\saed"wandofthenABemptksmerelyrespectivyely.vingargumen
argumenargumenstacbaset
ttand
andandreturn
returnreturnstac
stacstacinthe


canwevordthe\madeandstacy"bsaThethekregistersks


upWheredateisframe,theupanddatemakingstackthemkept?pItoincouldttothebecurrenrepresenttoptedofb
bbytheaseparateAandBstac
stacstackks.allofitsown,


butanotherwehastacvek.chosenThematojormergereasonitwithisthattheitBmakstacesk.avTheailableminoranimpreasonortanfortoptimisationthisistoavoidwhicyeth


wediscussbelow(Section10.3).

Toconclude,.
SettingPushinganopstacuperationdatekbaseframeofregisterspushingontothetoanpBoinupstacdatettok.theframetop(Ruleoftheir15)respisdoneectivbey:stacks.

(Thealertupreaderthe
thethethewillstacvWspdiscussthatainpter10.7.)theclosuretobeupdated)hasthereb


endedonBhak.eeottedthisoinSection(toy


Anstacupk,dateoraisconstructortriggeredinapplicationoneoftwondsways:aneitheremptayfunctionreturnstacndsk.toTheseofewtargumenwosituationstsontheare


discussedinthefollowingsections.

10.2Partialapplications
WhenThisisadescribclosureedisbenyRulesteredwhic17andhnds17a.toTheofewchecargumenkfortootsfewontheargumenstack,tsanisupcalleddatetheistriggered.argument


satisfactionmoreargumenchetsck(cf,andSectionoccurs9.3.2).atthestartofthecodeforeveryclosurewhichtakesoneor


Aminorcomplicationisthatthe tsaresplitbetweenAandBstacks,butthis


presensothetscheclittlekisdicultperformedy.Ifonlythelastontheargumen
argumenargumenstacktwhicisavhailablecontainsthenthecertainlylastargumenallthet.otherswillbe,


appropriateTheargumenstactsatisfactionkfromtheccorrespheckisondingperformedstackbypoinsubtractingter,givingthe
thetheadierencestackbaseinpoinwords.terofThisthe


iscomparedhpassedwiththethatk.calculated)tofewordsumerofpresenwrequiredaisallentheargumenaruntime


whicareon(staticallystacIfownbareordst,jumpfortaktots


systemUpdatePAP 
routine,concludesUpdatePAP 
byre-en,whicteringhperformstheclosure,theupwhicdate.hNode 
Onceshouldtheupbdateepoinhastingbeento.done,The


argumenupdateistneeded.satisfactioncheckistherebyperformed66again,asRule17requires,incaseafurther 



Aspecialcaseisrequiredfortop-levelclosures,becausethecodeenteringtheclosuremaynot


havmadeNode 
t-satisfaction-cptitkde9.2.1).aInointhiscase,tojustclosurebeforetoto.that,


theeargumenointohec(SectioncoloadsptertheinjumpingNode 
(RecallUpdatePAP 


top-levWhat1.2.3.First,isanNext,Itframe.doelgivrestoresesindirectionclosuresenUpdatePAP 
it
ititbuildsboeloverwritesarew.toinvstaticallyaluesdo?the
thethetheheapnewly-constructedItofclosurefollothealloaclosurewsstaccated,toRulek-basebrepreseneso17a:uptheirregistersclosure.datedtingaddress(obtainedthefrompartialistheir
xed.)fromapplication,valuesthesaupvdateedwhoseinframe)structureupwithdate


What4.5..
ItanFinallyThe
TheThebPAP_Info 
doyy)remoestheinfoptotalwhictheoin
,vstorageitesterphpartial-applicationsize(seere-enointhe
thetheistoterabofbuptersmanager,elooPAP_Info 
thedatevew).functiontheit.closure,frameclosurethis.closure,closurefromandinformationpointhethetedwhicloBokntoumstachlikbbisyise?erk,
inNode 
requiredofslidingInNode 
pthe.oin.mosttersdobwnyinthegeneraltheit.standard-enpAsortioncasewellofitasconthe
thethetrybeingtains:staccodeusedk(ifof


Ifsavthised.
The
TheTheThestacpartial-applicationkcon
conconconten
tententents
tststsof
ofofonthe
thethethetoclosureABtheirstac
stacstack
kkrespisb
bbet
etetenectivw
wwtered,een 
eeneenestacthe
thethethetop
toptopksstandard-en(usingof
ofofstac
stacstack
kktheand
andandtrysizecoits
itsitsdestac
stacstacofk
kkPAP_Info 
base
basebasep
ppoin
oinointopushester. 
ter.ter.determine


howapplicationyordstoclosure.moveItswhichstacandthenroutinesenthethesizeinformation
informationinformationclosurevinin


partialmanwtogarbage-collectionk),tersusefunctionsaedstoredthe 
thethe

theSomclosureuchfortotheguidegeneraltheircase.work.Acoupleofoptimisationsarereadilyavailable.Firstly,acol


lectionpterofspecialisednon-pterords.ptersorcanbeproPAP_Info_1_0 
forarioususedbinationstherenbone


ofoinandPAP_Info 
oinwoinFexample,videdviscomwhenofumisers


pisoinnoterneedwordandstorenothenon-peldoinsizesters.inThetheadvclosure;antagesandofthesucenhsptryecialisedandgarbage-collectioninfopointersare:cotheredeis


fasterbecausedecideithasnoterpretivaecialloop.Thereapplies.ofcourse,asmallexecution-timecostin


UpdatePAP 
to
totowhetherinspecaseis,

Secondlyedated.,ifthenewclosureissmallenoughit67canbebuiltdirectlyontopoftheclosure


bupto 



10.3Constructors
Theotherwayinwhichanupdatecanbetriggerediswhenaconstructornds

constructorstestisink.k;arevItindeedain.losooksDatacommon.thisasthoughstructuresisjustFurthermore,thewhatcoaredeisoftenforimpliedabuiltconstructorreturnbyonceRulestacandapplication16.kthenisThisalmostreploeatedlyhasoksalwtoexpaystesttraensivnon-emptvforersed.e,an
ananbecauseempt
emptemptEacy,sohy 
yy

return
returnreturnreturnstac
stacstacstacitandmatcimmediatelyclosureiserformederhapstingdatastructure,vcontinistered.isustitalreadyerform


timeevaluated,patternk,returnsthehingprepresen(ponausingthe
thethedataectoredstructureareturn),enuationbutitSincempushedrstisp

the
thethereturn-stacktest.

SoBstacnowk,comesifareturnthetricaddresskypart.isSincenotonupdatetopofframesthestacandk,continthenuationsanupdateareframebothstoredmuston
ononbe.the 
thetheIf


wecouldmakejustthereturntopworwithoutdofeachmakingupdateanyfrtest.ameintoIna
aacocommondelabel,UpdateConstr 
casewherethere,theiscnoonstructorupdate


framethisthedoesstacjustsowhat\return"eant.Ifanlandupdatethe
thetheisrequiredtherecobeanwhicupdatecanperformon


topofBk,thewwwillinUpdateConstr 
willde,hframe


thecontinupuation.dateandthenreturnagain,perhapstoanotherupdateframe,orperhapstothe\real"


Beforewoneexamineinstructionthecomplications,evupisorthframeokingattheThecrudeenetcoststhebTheof


costiseextraforeryitdatewlopushed.bisandenets.omission


aIfcoupledatastructuresofinstructionsaretra(oneversedofthemrepeatedlyaconditional,constructorjump)evfromaluationseverywillconstructoroccursubstanevaluation.tially


moreoftenthanupdates.Thebenetslooksignicant.

Theconstructorstroubleworksisthatne.thisTheintriccase 
Sectionskinalternativteracts9.4.3aeswkw9.4.4.ardlyalwaWithyswiththe
thethevtedbyreturn
returnreturnasimplecon
conconcovven
enendetions,tionselforon


erythingdiscussedandarerepresensimplearious labev-


UpdateConstr 
stacandtovtheyNode 
eoindatedtoconstructorantoAll


theBk,needthedoresultisisoreturnederwritebmakingclosuretobpuptthewithindirectionclosure.this


constructorclosure,restorethestackbaseregisters,andreturnagain.

10.4Vectoredreturns
Lifegetsmorecomplicatedwhenweaddvectoredreturns.Thereisnoproblemwithproviding


athevectoredupdateformandofthenUpdateConstr 
returnsinits;eacturnhenintryainvectoreditsreturnfashion.vectorThepoindiculttstocoydeiswhicthathpwhenerforms


updateameisycreateolymorphic.d,theeturnconventionfornotknownthe.Thisisbecausefunction,typehoflooksthe 
thethe

expressionfrmabeprConsider,isexample,compose 
thewhic

likethiscompose 
inthe. 
STG{} 
\n 
language:{f,g,x} 
-. 
let 
in 
f 
gx 
{gx} 
. 
{g,x} 
\u 
{} 
-. 
g 
{x} 


Theitcannotcodeknoforthewwhetherclosureagx 
vectoreddoesnotreturnknowisits68totypbee.expHence,ectedwhenornot.itpushesInshort,theUpdateConstr 
updateframe 



Bstack-Returnvector

mustbeabletocopewitheitheraFigurevector7:edVorectoredanon-ve-
---upCo
CoCoCoCoctordatesde
dedededeefor
forforto
totodrup
upupeturnConsNildate
datedate.alternativ
alternativalternativwith
withwithNilConsee

Ifconwveenwtionerethatgeneratingthepoinmacterhinetoacovdeectorthistablewouldpoinpresentsjusttlittleafterproblem.theendofWtheejusttable,adoptsothatthe


theordinarytablecoisdeaccessedimmediatelybyindexingprecededbacbykwitsardsectorfromtable.theSadlypointer.,CdoNoeswnotUpdateConstr 
allowustosplabecifyels


thethatrelativnon-veectoredplacemenreturnstofdatabehaandvecojustdelikinethisv
vvectoredway,soreturnsinsteadthroughwehaveatovadoptectortabletheconwithventionone


entry(cfSection7.6).Thisimposesanextraindirectiononnon-vectoredreturns.

10.5Returningvaluesinregisters 
Unfortunatelyinregisters.No,wmattersUpdateConstr 
getworsehaswhennow
wwaeyconsidertoguretheoutideahowoftoreturningperformtheconstructorupdate,becausevalues


ithasdatenowytotellpushavreturnofUpdateConstr 
vtionisbeingappropriateused.Canthethedatatwhice?hAspushedjust


theupaframewhatersionconenforclosureyp

discussed,theanswerisno,becauseofpolymorphism.

Thislookslikearatherseriousproblem.Thereisawayroundit,butitisrathertricky.

Theideaisessionthis:theupcausedframeevaluationynotknothewtheypplacofcvaluedobes.returned,UpdateConstr 
the


case 
exprwhichdatethemainrstteetheertainlyeingSobut

doapesoinnotterptoerformtheclosureanupdatebeatupall;dateditmerelyinasprecordsecialregisterthatanUpdatePtr 
updateis.required,Itisuptobyplacing


anupdateiscontinpending?uationSimple:to
totoperformeachtheentryupdate.intheHocase 
w-expression'sdoesthecontinreturnuationvector\knoisw"expandedwhether


toapairofcodelabels(Figure7).Therstoftheseisjustasbefore(iethecodeforthe
thethecase 
casecase


andexpression
expressionexpressionthenjumpsalternativtothee);therst.otherWepcallerformstheseantheupdatenormalonreturnclosurecodepoinandteduptodatebyUpdatePtr 
returncode,


respectivco.ratherAllUpdateConstr 
thehastoreturntoprecipitatede,hthe
thetheupcandatemerelytoreturnbytotheupdateits


returnelydethannormaldocowhicitdoisincreasing


osetintothereturnvectorbyone. 69 


Thecostsaresurprisingslight.Thereisastaticspacecost,aseachvectortablenowdoubles


insize.ThepextratedcodefromperformthethevdatecanforbegenerateddatayponceThisonlyer-constructoreachconstructor,update


andthenointotoallreturnupectorsitste.pfor

coreturndecanvectorstillisndkeptitshandywaytointhearegister.appropriatecase 
alternativeprovidedthepointerto

Oneobhjectionbremains,thehcontinoksserious:suppisosehed?therecansevupinframesliktopthe 
thethe

ofeacothereforewhic\real"louationreacThisareeralarisedateprogramsone

following: x1 
x2 
... 
{x1} 
x1 


ondatetopofframein 
ininintheandstack,enterreectingx1 
.Whenthex1 
factreacthathesbheadoththenormalclosureformforitx2 
x2x2willandndthattwoforupdatex3 
mframesustbe


Whenup
upupclosuredatedx3 
whicwithlet 
letletlet...x3... 
isenhx1 
tered,max3 
'sy. 
===value.return{x2} 
itwillThis\u 
\u\uthepush{} 
{}{}lovalueoksan-. 
->->uplikofx2 
edateanotheraratherframeclosurespandecialthenhascase,enthebuttersameitdo,whicpropesarisehertwillyin.pushpractice:Forexample,anotherany


thedenitionx3 
. 
of{x2,z} 
x3 
could\u 
be:{} 
case 
... 
of 


Theoneclosure!problemFwithortunatelymultiplethereupdateisNil 
Cons 
anframeseasy{} 
{p,ps} 
-. 
solution.isx2 
that-. 
p 
RecallUpdatePtr 
thatallregisterreturncanvectorsonlyincludingpointto


thatreturnforcoUpdateConstr 
deratherthanconsistthenormalofpairedreturnentries,codeandofthatpair.UpdateConstr 
Theupdatereturnsreturntocothedeupofdatethe


UpdateConstr 
isalreadyinuse.vectorOnethereforepossibilitknoywwsouldthatbeittoiscnothainthe
thethethetogetherrstalltheframe,closuresandtosobUpdatePtr 
eupdated,


butclosurestherewithisaansimplerindirectionway:tothethesecondonepoin(andtedsubsequentobyUpdatePtr 
t)up
upupdate
datedate.Whenframesthejustlatterupdateisnallytheir


uptwodatedindirections;alltheupanddatingrememhasbbereenthatsuccessfullyindirectionscompleted.arealleliminatedThiscanresultbytheingarbagechainsofcollector.atmost


Finally,whatofnon-vectoredreturns?Westillneedpairofcodeaddressestoto,


asinthevisproblem:case.the
thetheupresultsreturnaredea
aapheap-allothecateddateclosurepjumpstedto
tototheby


Node 
thereectorednoIfdatecojusterformsupandoin

normaltoreturnerformde.IfanalysisresultsareRTag 
beingreturned
returnedreturnedgurein
ininhoregisters,toerformup
upupdateAsefore,code


needspcocaseontooutwpthenthe
thethedate.return
returnreturnb

thereneedbeonlyonecopyofthisupdatereturncode.

70 



10.6Updateinplace
Theupdatetechnologyjustdescribedhasanotherveryimportantbenet:itallowstheup


datedetobanoverwrittenetoerwith.r(ifitissmallenough),rthaneing


overwrittenclosurwitheindirctiondirctlytheesulttheesultatherb

Upbyindirections,tonow,ouruniformeventhoughreturnitisconoftenventionthehascasemeanthattitthatisinclosuresprinciplearepossibleonlyevtoero
oov
vverwriteerwrittenit


directlyeswithtoalotresult.extraNotonlydoesallointroduceKieburtzextraindirectionsAgapievspecicallymoreseriouslyidentify,


itgivrisetheofmemorythiscation.andbut,

andthequanthismecof(KieburtzpreviousAgapievishoevthenthisshortcoming


Ifdual-returntifyshortcominghanismthe&section[1988]).used,wer,

canlaideasilyoutso,ConsUpd() 
beifoitvercome.isUpdatePtr[0] 
UpdatePtr[1] 
UpdatePtr[2] 
small{ 
Theenough,codeit. 
===performingCons_Info; 
Head; 
Tail; 
candirectlytheovuperwritedateknothewsclosureexactlytohobweupthedated.closureForis


example,hereisthecodetoperformupdatesforalistCons 
cell:

Here.ware} 
assumingisJUMP( 
thatinfoReturnVector[2] 
Cons 
forCons 
); 
returnsitsheadTheinaofHead 
returntailector


Tail 
Cons_Info 
ethethetableconstructortheconstructor. addressregistertheandvin


isassumedpairfortobe.inaregisterReturnVector 
.Theosetof2pickstherstcodeaddressof


theCons 


Forlargerconstructors, newobjectcannotbebuiltdirectlyontopoftheoldone,soanew


obThejectupustroutinebecinkustustheapebcarefultheandoldsaoneedatedycollectionoinwithbanindirectionreturnediftospaceregistersTheto


heap-exhaustionmdatebuilthecmmthe
thethethenbemade,andtogarbagevupanpterstriggeredeingnoinit.remains.usualin


aplacewherethegarbagecollectorwillndthem.

HotwowmaindoWplausibleallothanthemesecatedcanptheanossibilities:allestablishinupguess.whoselargeteger,datingenoughtTheresoaypglobalcoitedeisdois(sa(bknoesscopconyy)notwpaddingvInt 
eenifneedfortionthe,thenanotherfortoclosureifitbthenecessary)ecannotpaddedsmallminimtobepoptimisationumossiblyupouttodatedsizeconcons-cellboftaineisup
upuplargehere:datableadatedlistsize.enough?ifconsbayclosures;closureancellythingThereseemsismakingbothereingarea


Update.
inThethemoreinplaceunconditionalupplaceoften.datingorisuseThisnotcoandeisalwscindirection,cananotherheme,ayslodesirable.okbutaspinthedephasectendingclosure'softheSuppthe71meritosedesignoninfothat
thatthatwhattablewhictheit
itithwillnds.vto
totoaluewndesucceedplanofThisitsthetosize,costsinthquanunkupandmoretifydatingturnedeither.timeinupoutplacethandateto 



beanalready-existingconstructorwhichreturnsitscomponentsinregisters.Thenupdate-in


placewilloverwrite thunkwithacopyoftheconstructor.Noworkisduplicatedthereb,


butthereisapotentiallossofspaceifbothcopiesstayliveforawhile.Atworst,agreatman


copiesprogram.ofthesameTheobpjectointcouldisthis:beoncebuiltcopied,inthisthereway,substanisnocheaptiallymecincreasinghanismforthe\commoningspaceusage


up"theoriginalwiththecopy.

Ourpreliminarymeasurementssuggestthatupto10%ofallupdatescopyanalready-existing


constructor,thoughthe
thethegurecanoccasionallybemuchhigher(forprogramreportedby 
yyy

Runciman&Wakeling[1992]itis47%).Weplantomakemorecarefulmeasurementsto


seehowimportantthiseectis.Ifitturnsouttobesignicantwewillimplementasimple


extension thedual-return-addressschemeoutlinedinSection10.5,wherebyeachelement


of
ofofthe
thethereturnvectorisatripleofreturnaddresses.Weomitthedetails,buttheschemehas


theeectof
ofofalwaysupdatingathunkwithanindirectionwheneverthe
thethevalueofthethunkis


analready-existingheapobject.

10.7Updateframesandgarbagecollection
Updateframes,whichincludeapointertoclosuretobeupdated,arekeptontheBstack.


Atrstthislooksratherawkward,becausethe
thethegarbagecollectorexpectsallpointerstobeon


thepointerstack,butitactuallyturnsouttobequiteconvenient,becauseofthefollowing


observation:ifonlypointertoaclosureisfromanupdateframe,thentheclosurecanbe


reclaimed,andthe
thetheupdateframediscarded.

Wecantakeadvantageofthisduringgarbagecollectioninthefollowingway.Firstperform


garbagecollectionasusual,butwithoutusingthepointersfromupdateframesasroots.Now,


lookateachupdateframeandseeifitpointstoaclosurewhichhasbeenmarkedaslive.If


so,andacopyingcollectorisbeingused,adjust pointertopointtothenewcopyofthe


closure.Ifnot,squeezetheupdateframeoutofBstackaltogether.

Itiseasytondalltheupdateframes,becausethe
thethethestackbaseregisterfortheBstackalways


pointstothetopmostwordofthetopmostupdateframe;andthesavedstackbaseregisterfor


theBstackpointstothenextupdateframe,andsoon.Thisgivesatop-to-bottomtraversal,


butitSinceturnstheoutsqueezethatabmottom-to-topustmovedatatratoversalwardsmaktheesbtheottom\squeezing-out"ofthestack(otherwiseprocessmucthehstacmorek


ecient,fortworeasons:

HappilywWhenabBould,stacoviteiskitcreepaniseasyneedupmoupdatevtotoedinmakbonlyframeememory!),adjusted.eonce.aistop-to-bremowThisorkingved,ottomistheeasyfromtrastactovbersal,k-baseottomdowhenrevtopoinersingtopwtersorkingmeansallforbthetheottomthatnextoineactoters,uphtop.wdateordandofframethenthe


makethebottom-to-toptraversaltodothework.

Theresultofallthisisthatthegarbagecollectorreclaimsredundantupdateframes.The


mainbenetisthesavinginupdatesperformed.72Thisoptimisationwasp
pperformed,butnot


documented,inFairbairnandWray'soriginalTIMimplementation. 


10.8Globalupdatable
Aspreviouslydiscussed(Section9.1),eachglobally-denedvariableisoundtoa

allo
alloallocated
catedcatedclosure.closures),Sincetheresucishnoclosures
closuresclosuresneedtohatreatvenothemfreevasariablesasource(exceptofrootsofcourseduringothergarbagestatically-
statically-statically-collec


tion.Butsomeoftheseglobalclosuresmayhavenoarguments,andhenceb
bbeupdatable:wecall


suchishints 
CAF{} 
{}{}t-less\u 
valuetop-lev{} 
{}{}isfrom 
elclosuresinnite{zero} 
{0#} 
coftegers:applicformsorCAFs.orexample,


ints 
sucazero 
argumenwhose. 
==\n 
MkInt 
thelistonstantinativeF

wherefrom 
isafunctionreturningtheinnitelistofintegersstartingfromitsargument.


Therearetwodiculties:

ThereThe1.1.2.ideaIfheap.needTheCAFsonWithisissucslotomoreistw
wwthehdierenthetoTheedwhicoathanarrangeCAFCAFaredoquestionhwntreadilyareoneislistgarbage-collection 
garbage-collectiongarbage-collectionbyupbthat:,weingawhicdated,ais:testdistinguishableytohoevhwhenaluated,solviswthereknoistecethethisthehniqueswnwillcoorgarbagevtoproblem,deast(bbwhoseeyfrompdescribmaaddress)oingarbagecollectorjorittersevbutthosealuationedyfromtheofinbutcollector.inuptoSectiononeitthe
thethedatesndisiswcomplete,
staticdynamically-alloeunfortunateall7.3arehaThissucvspaceeclosurestoadoptedhsolvdynamicpareoinesiniftolinkters?
theineveryisthecatedstaticedclosures.rstasdynamictogetherfolloupofheap.spacedatews.the


Wheape2.acabAlllem.hievovupeethesedateproblems.purpframesgoalsTheisbypoinreceivaddingttoclosuresathelittledoextrainthe
thethecotdynamicdetodate;thealloheap,startpushesofthusthesolvingstandard-enupktheclosuresecondtrycooindeprob-for


aCAFwhose(Figure8).osetoextracoedesubsequenesthefollowing:upititcatesaanblacdateholeframepintingthe


tothistingkhole;andkitoinerwritesheap,staticlinkonclosurethewithlist.aordcell,


poinblacblacholevthetheandCAFedtoCAFthree-wCAFlist 


Inlinktheedexampleonto
totothe
thetheshoCAFwnlistinFigure(weuse8,CL 
thetoCAFsabbreviate,q 
andther 
infohavepoinallterbeenforenatered,CAFList 
andcell).henceTheare


evpoinaluationterBH 
).ofThep 
isnotevaluationyetcomplete,ofq 
hassobiteenstillcompleted,p
ppointstoaandblacthekholeblacinktheholedynamichasbeenheapupdated(info


withinfopanoinindirectionter(S 
)only.(infopointerI 
)toitsvalue.s 
hasnotbeenentered,soitconsistsofa


AclosureCAFList 
towhiccellhloitokspoinlikts,eanbyehaothervingclosure.justlike73Ifanenindirection.tered,itsimplyTheengarbagetersthecollectorheap-alloknocatedws 



-----....--pqrsCLCLCafList ISSTATICSPACEDYNAMICHEAP CLBHFigureiterativappropriately8:Global,acuatingupdatesabouttheCAFhlist,andwalksittheelyevthe.heap-allocatedeaccellpoints,andupdatingcellThisisslightlypholdsonthetheretovalueofevveryCAFeventhoughtheprogrammavyernevbutisnoaoidingthisunlessthegarbagecollectortraersesthecode
-----....--pqrsCLCLCafList ISSTATICSPACEDYNAMICHEAP CLBHFigureiterativappropriately8:Global,acuatingupdatesabouttheCAFhlist,andwalksittheelyevthe.heap-allocatedeaccellpoints,andupdatingcellThisisslightlypholdsonthetheretovalueofevveryCAFeventhoughtheprogrammavyernevbutisnoaoidingthisunlessthegarbagecollectortraersesthecode11Statusandprolingresults essimistic,referenceclosureaswell.toitsinceagain,whicith


WehavebuiltacompilerforHaskellwhosebackendisbasedontheSTGmachine,just


asthatdescribitmaedybabeousedve.Theasawhole\motherbimplemenoard"tationintowhichashbeenotherconstructedimplementorsrathermacarefully\plugin"so


theirhaskell-request@dcs.glasgow.ac 
optimisationpasses.Allthesource.uk 
.codeisavailablebyanonymousFTPby
yycontacting


ApartthefromtheSTGare:hinehnologydescribedinthetpaper,majorv

ofcompilermacteccurreninnoations


.
TheAornewitssystematicrunapproactimesystem.husetoinput/outputofunboxedvaluesbasedtoonimplemenmonads,twhicbuilt-inhallodatawsthe
thethetypenes.tireI/Osystem
atoC.Theisandoftypgeneral-purpactuallyextensivbAseeapplication.Coresystemwrittenaresultlanguage,ebasedprogramisinosethemoreHaskThisonmecI/Othewhicexpressivtransformation,ellphanismsystemermitssecond-order(Hammond,hserveuswhiccanesthantoasbhmaineHaskthealloPasreadilylameytonwwstainmainbell's. elldaarbitraryascompleteJonesextendedcalculus,inaccommotermediate&callsWtwithoutcompleteypadlerdatingetoinformationdatab[1992]).emoothermadewithtypdifyingefrontThisinfromypinetthe
thethetheabstractionendsisHaskcompiler,donecompilerpresencewhoseellviato
74 



Theimplementationcoversalmostthewholelanguage,butvirtuallynooptimisationshav


yotheretbeencompilers.implemen(Thisted.omissionAsaresult,isanweimphaortanvenottshortcomingcompareditsofabsolutethispapper,erformancewhichwillwithbe 
ee

rectiedWehavebbyegunfollotow-upgatherpapsimpleer.)dynamicstatistics,however.Figure9showsoutput


takofHaskenfromellsourcea
aaruncoofdeasimple(aparttfromype-inferencefunctionsprogram.usedfromThisthePrelude),programtakandesthesome
somesomesample600linesrun


allocatedabout10megabytesofheap.Theprolehasthefollowingmainheadings:

Allocations,ofdata-valuesplitallointocationvariousseemscategories.surprisinglyMostlow,allobcationecauseismostforthdataunks.valuesThearepropbuiltortionby


Stackprogramuphigh-wdatingaterusesathmonadsunk,marksratherheaarevilyselfthan,explanatorysobquiteyperformingalot.offunction-vnewalloaluedcationclosuresinalet(rec) 
areallocated..This


Enters,loduewwithproptotheaortionclassicationveryofhigher-orderfunctionofwhatcallsnaturekind(34%)ofofthebclosureypassprogram.theisbargumeneingentered.tsatisfactionInthiscase,check,aratheragain


Returns,run,returnsInthealmostwhiccellwerehmogivallfromdel,ewinformationeretheenvteringectoredenter/returnanabandalready-evoutinsequencetheregisters.data-valuatedwouldalueTheconstructornotreturnsthirdbeclassicationperformedwhic(somehto50%okfortellsplace.theseinhothiswcases.Incase).manthisy


Up
UpUpdatedates.thisdirectlyalready-existingframescase.Theonfthtopclassieslineofvalueonecounvanother.warioustsasthecopiedformsnumThebbyeroflastanofupuplinetimesdatedatescounframe,tw(Sectiontsoorthemorewhicnum10.6).hupbiserdateratherofupframesdatesuninformativwinerewhicstachekanedin


Acknowledgements

ThisenoughpaphasbgiveenmealongtimeandininIouldvingeAndrewthankthoseelwhodetailedvb


kindertoehelpguidancegestation.improwlikit.toAppmadehaeeen


commentsaboutChrisrelationshipasaki,ofthisSeworktoandhis.GeotoBurn,ymousHall,DenisgaveHowerye,


RishiyurNikhil,theOkJulianward,thewanonCordyrefereesv


HallandPimplemenouc

usefulfeedbacWillk.artain.ThetationofthecompileritselfwesmhtotheworkofCordy


Sadly,myinfriend1991.andcolleagueJonSalkild,whoco-authoredtherstSTGpaper,diedmost


suddenly

75 



aAvL14gL459O#74146Cw02300Ao0036179Tr8I((((((7OsN16a1S0091o0d3:....f.m.70051:6i03%%%%%n%9))))),)d2bpftbdm0iauhlai(grnua6tntcnc4atg3itkk8uo1avis-9po2laoh1gldlnoa.oesulvp0oseesawpdslclolsoluri1,p7oedc.2sssa004ut.1t13ri5.o.3eo076snas130sl...l:700op00)..100.0 ASBTTossAttt4Caaa3KlccUsk6k1Stmm(AoaaGrxxEa50..:g..edd90-ee%%mpp))attnpdhhaaa::grte24tari-26aavllawwl-loooaurrcpeddapusstlpiidocanatste:iso4n09.u50p9d44a.(t52e3s050.5.05094w.o4rd0s.)0 EN23[61[T45t43o4E67h32f7R12e468Sw36648:rh(((1(ei(4sc1242th759537...i.2.3303n1147%%%d%6%,))))0)or4dtiffpeahn(uactuwd3nrtanhictekir.tidvsce6iavahc%olilt)n4aaui1vbpeoN9aypsnolplsduaieesc('ssa2set9dii.on4anf%rso)g-dpsitarrte]icstfatcotitohnecehnkt]rycode URPE[3244DTt5489AUh6492TRe2991EN06190SFr:((((Re(41As14990Mt009920E0.f..1.S.0r6820:0%o%%%%)3m))))5csfiev6otnren2naoctsrnmette(dorerg0airnuirenotcsddgmettfairoernttirrahtnsfemeegr[xedaratisfemhsnrseeteotsiwrmnuegctnscohvtonueinsncnstkttrsotru)rhuceectdtohorera]p] UP2[[D528452A75345T8i7489E088994S1:(((((3il75n111026250..2p...e046l241,%%a%%%))4c)))3ebdpui4,laapn1at6rd-caatapkalitlv-llaeaahlolsclooceafulcapoueeatplpsteflldedrioadancwtnmeaeeeewtdswsisicospmonpampsaceicedee]id,at1elwyithNode] Figure9:Exampleoutputof7d6ynamicprolinginformation

l,,ceonnpmRAlver\AsTomnhs,eteDTredrCaa 
alc.loamhapnu,teDrsCyustmemm,i"n gins,PBr 
K 
oIb 
lteenrzn,atAionpao 
rtCeornefeldren&c 
Bo 
SmSuit 
he[rJcuonmepu19ti9n0g] 


Bibliograph275{279.[1987],[1992],y\GarbageCompiling 
collectionwith 
con 
canuations 
befaster,CamthanbridgestacUnivkalloersitcation," yPress.Info 
Pro 
c 
Lett 
25,


A
AAAAW
WWWWApp
AppAppAppApp{ 
Conference 
el
elelelelPractice 
[F&ebT1989],Jimand 
[JanPrinciples 
\SimpleExp 
1989],erience 
generational\Conof 
19,Programming 
tin
tintin171{183.uation-passing,closure-passinggarbageLanguages 
collection,AandCM,fast293{302.allostyle,"cation," inPro 
Soft 
c 
A 
w 
CM 
are 


ZMAriolaSymp 
&osium 
Arvindon 
onon[JuneP 
artial 
1991],Ev 
aluation 
\Asynand 
tacticSeman 
approactics-Based 
htoprogramProgram 
transformations," Manipulation, 
Y 
ale 
in.


LSci,Chalmers[1987],\CompilingUniversity,lazySweden.functionallanguages,partII,"PhDthesis,DeptComp


LAugustsson
AugustssonAugustsson&TJohnsson[Sept1989],\Parallelgraphreductionwiththe<nu,G>-machine," 


HenryBakin294.c 
hitecture, 
Pro 
er[Aprc 
IFIP 
1978],London 
Conference 
\List,ACM.proon 
cessingF 
unctional 
inrealProgramming 
timeonaserialLanguages 
computer," and 
CA 
Computer 
CM 
21,280{Ar


JFBartlett[Jan1989],\SCHEMEtoC:aportableScheme-to-Ccompiler," DECWRLRR


ABloss,89/1.PHudak&JYoung[1988],\Codeoptimizationsforlazyevaluation," Lisp 
and 


GeoBurn,Sym 
A 
CM 
b 
SLolic 
Conference 
PeytonComputation 
Joneson 
Lisp 
&1,John147{164.and 
RobsonF 
unctional 
[JulyProgramming, 
1988],\TheSpinelessSno 
wbird 
G-mac,244{258.hine,"inPro 
c 


CConselProgramming 
523,&SpringerODanvyVLanguages 
[Septerlag,1991],496{519.and 
\ForComputer 
abettersuppArc 
hitecture, 
ortofstaticBoston 
data,oHughes,w,"ined.,F 
unctional 
LNCS


ECCoopDepter&CompJGMorrisettSci,Carnegie[Dec1990],Mellon\AddingUniv.threadstoStandardML,"CMU-CS-90-186,


AJTDaenvievironmen&DJMcNallyt,"inPro 
[1989],c 
IEEE 
\CASETENCON, 
-a77lazyBom 
versionba 
y 
.ofanSECDmachinewithaat 



JonFairbairnsupand 
ercomComputer 
&Stuartbinators," Arc 
Whitecture, 
rainy[SeptPro 
c 
1987],P 
IFIP 
ortland 
conference 
\TIM,GKahn,-asimpleon 
ed.,F 
unctional 
SpringerlazyabstractProgramming 
VerlagmacLNCShine274,Languages 
toexecute34{45.


AJFieldPGHarrison[1988],inF 
unctional 
programming 
,AddisonWesley.

KFHammond,radetformation," &
&&DLeSLMetaPA 
eytonCM 
yer[JanT 
Jonesransactions 
1991],&PL\Compilationon 
WadlerProgramming 
[Febof1992],functionalLanguages 
\Anewlanguagesand 
input/outputSystems 
bprogram13.modeltrans-for


P
PPRHendersonHieb,purely-functionallanguages," RK[1980],DybvigF 
&unctional 
CBruggemanprogramming: 
Dept[Juneof1990],Computingapplication 
\Represenand 
Science,tingimplemen 
Univcontrolersittation 
iny
yytheof,PrenGlasgopresenceticew.Hall.of


PHudak,rst-classImplemen 
SLPeytontation 
continJones,uations," (PLDI 
PL90) 
Winadler,.Pro 
c 
Arvind,Conference 
BBoutel,on 
Programming 
JFairbairn,Language 
JFasel,MDesign 
Guzman,and 


JohnHughes[MaKSIGPLAN 
Hammond,y[Apr1992],1989],Notices 
\RepJHughes,\Whort27.onyfunctionalTtheJohnsson,functionalprogramming
programmingprogrammingmatters,"RKieburtz,RSNikhil,languageThe 
WComputer 
HaskPartainell,&VersionJournal 
JPeterson1.2," 32,


PZIngerman98{107.[1961],\Thunks," Comm 
A 
CM 
4,55{58.

EIreland[Jan1992],\TheLazyFAbstractMachine," inPro 
c 
15th 
Australian 


ThomasComputer 
inJouannaud,UnivJohnssonPro 
ersitc 
IFIP 
y,[1987],Science 
[1985],Gotebed.,Conference 
LNCS\Compilingorg,\LamConference, 
Sw201,beden.daon 
Springerlifting:lazyF 
unctional 
unctionalunctionalHobart 
functionaltransformingV,
erlag,WProgramming 
orldlanguages," 190{205.Scienprogramsticand 
Publishing.PhDComputer 
tothesis,recursivPMG,eArc 
equations," hitecture 
Chalmers,


Thomas
ThomasThomasRBJonesKieburtzSymp 
UnivI 
[MarcI 
Johnsson
JohnssonJohnsson
.ersitosium 
[Octh1991],y[June1987],ofon 
Ken\TCompiler 
1984],ail\At.recursionRISC\EcienConstruction, 
arcwithouthitecturetcompilation
78
spaceMon 
forsymleaks," treal 
ofboliclazy.Departmencomputation," evaluation," tofComputerininPro 
Pro 
c 
c 
SIGPLAN 
ASPLOS 
Science,


R
RRKelseythesis,[MayDepartmen1989],\CompilationtofComputerbyprogramScience,transformation," YaleUniversity.YALEU/DCS/RR-702,PhD 



RBKieburtz&BAgapiev[Sept1988],\Optimisingtheevaluationofsuspensions," inPro 
c 


HKingdon,w 
reducerorkshop 
DforLesteron 
aimplemen 
transputer&GLBurntation 
netw[1991],ork," of 
lazy 
Computer 
\Thefunctional 
HDG-macJournal 
languages, 
hine:34,a290{302.Asp 
highlyenas 
distributed.graph


PWMAKranzKoversitopman[Mayyof1988],[1990],Nijmegen.\ORBIT\Functional-anoptimisingprogramsascompilerexecutableforScspheme,"ecications," PhDthesis,PhDDepartmenthesis,Uni-t


PJLandinofComm 
Computer[MarcA 
hCM 
1965],Science,8,158{165.\AcorrespYaleUnivondenceersity.betweenAlgol60andChurch'slambdacalculus," 


D
DDLesterThesis,[Apr1989],Programming\CombinatorResearcgraphhGroup,reduction:Oxford.acongruenceanditsapplications," PhD


ErikMeijertation 
[Septof 
lazy 
1988],functional 
\Generalisedlanguages, 
expressionAsp 
enas 
evaluation," .inPro 
c 
w 
orkshop 
on 
implemen


EMirandaputerHall.23.Jones
JonesJones[AprScience,1991],[1988],[1987],Queen\Ho\FLICThe 
wimplemen 
Maryto-doafunctionalandmactation 
hine-indepWesteldlanguageof 
functional 
College,endentintermediatefastLondon.programming 
threadedcode," colanguages 
de," SIGPLAN 
Dept,PrenofNotices 
Com-tice


SL
SLSLSLP
PPPeyton
eytoneytoneytontion," RemJones,&inJ-CPro 
CSyre,c 
ClacJP 
Launcarallel 
keds.,&hJburyLNCSArc 
Salkildhitectures 
[Sept365,[June1991],Springer1989],and 
\UnLanguages 
V\High-pberlag,oxed193{206.verformancealuesEurop 
ase 
(P 
rstparallelARLE) 
class,graphcitizens," EOdijk,reduc-Min


SL
SLSLP 
PPF 
ed.,unctional 
LNCS&
&&523,Programming 
DSpringer[MaVyLanguages 
erlag.1991],\Aand 
modularComputer 
fully-lazyArc 
lamhitecture, 
bdalifterBoston 
inHaskell 
,Hughes,," 


SL
SLSLPeyton
eytoneytonPPeytoneytonSoft 
Programming 
Hall.partmenJones
JonesJonesJonesJonesw 
are 
t{ 
&
&&ofPractice 
JonDRComputerLanguages 
SalkildLester
LesterLesterand 
[1992],[SeptScience,
Exp 
and 
erience 
1989],Implemen 
Computer 
Univ\The21.
ersit79
ting 
ySpinelessArc 
offunctional 
Yhitecture 
ork.Tagless,languages: 
DG-macMacQueen,hine," a 
tutorial 
ined.,F 
,unctional 
PrenAddisontice


CRuncimanWesley.&DWakeling[April1992],\Heapprolingoflazyfunctionalprograms," De



PSansomF 
Wourth 
orkshops[AugAnn 
1991],inual 
Computer\ComGlasgo 
biningw 
Science.W 
orkshop 
copyingon 
andF 
unctional 
compactingProgramming 
garbagecollection," ,SpringerinVerlagPro 
c 


MarkSSmetsers,Scon 
heevLisp 
EelNo[Augand 
cker,F 
1986],unctional 
Jvan\NORMAGroningenProgramming 
-&agraphRPlasmeijer.reduction[Septpro1991],cessor," \GeneratingPro 
c 
A 
CM 
ecienConference 
tcode


RMStallmanforArc 
lazyhitecture, 
[Febfunctional1992],Boston 
\Usinglanguages," ,Hughes,andportinged.,inF 
unctional 
LNCSGnuCC,523,Programming 
VSpringerersion2.0," Verlag.Languages 
FreeSoftwareand 
FComputer 
oundation


GLSteeleInc.ence.[1978],\Rabbit:acompilerforScheme," AI-TR-474,MITLabforComputerSci-


Williamrapidprogramming 
Stoye,comThomasbinator,159{166.Clarkreduction," e&ArthinurPro 
Normanc 
1984 
[AugustA 
CM 
symp 
1984],osium 
\Someon 
practicalLisp 
and 
methofunctional 
dsfor


APTarditi,olmactoing,"C," AhAcin&ScharyPro 
AhoWolc 
aAppA 
of&CM 
ComputerPelLee[JuneConference 
[Marc1990],Science,h1991],on 
\DebuggingLisp 
Carnegie\Noand 
assemF 
Standardunctional 
Mellonblyrequired:UnivMLProgramming, 
ersitwithoutcompilingy.revNice 
erseStandard,engineer-ACM.ML


D
DDAT
TTurnerPractice 
[1979],and 
\AExp 
newerience 
implemen9,31{49.tationtechniqueforapplicativelanguages," Soft 
w 
are 


PWadlertional 
[1987],programming 
\Ecientcompilationlanguages 
,ofSLpatternPeytonmatcJones,hing," ed.,inPrenThe 
ticeimplemen 
Hall,78{103.tation 
of 
func8
0 



PRWilson,garbageMScollection," Lam&TGDepartmenMoher[JantofComputer1992],\CacScience,hingconsiderationsUniversityofforTexas.generational


AThegorydetails

Thisappendixcontainsgoryimplementation-specicnotesfortheGlasgowHaskellcompiler.


ToDo:addsomestuaboutstackstubbing.

A.1Updateags

ThereUparedatable.reallythreeUpdatekindsmeofwithupdatemynormalag:form.

A.2.
Single-entry.blacRenapplicationsargBlaceteredentrkthingsholeant.k(andholestomaDon't
Don'tDon'tarere-evprevybalwealuated)enupreenauptysdate
datedateatranreenspacemoreme
memet.tranleak.with
withwitht.thanNoteIm
mmonce.promiseyythatnormal
normalnormalManifesttheIwilllatterform,
form,form,bfunctions,etbutorenwoteredwithhayouveconstructors,canaatzeroblacmostoargumenvkerwritehole.once.andts,meImasopartialwithzero-ybae


ThereTareoprevgivthreeeenatbreasonsetterspaceerrorleaks.foromessageverwritingwhenaththere'sunkwithaninniteablackloholeop.immediatelyitisentered:


Theprev.
rstT
TTo
ooendottedwothreadbcanybesyncdealthronisationwiththeinthingsaindierenaparallelonthetwaupsystem.ydatebythestacgarbagekatGCcollector.time.InniteSpaceloleaksopscan 
cancan

b
bbneede
eedetectedparallelism,byablac
blacblacpost-mortemk-holing
k-holingk-holingisonawtheasteupofdateinstructions.stack,followingastackoverow.Sountilwe


A.3Addingllers

Thekgreatorvytdating,isthis:lleraclosureiswrittenistobvmothedied,eitherofyclosure,eingsovthatthewitha


blachole,inarianbupaifoeer\tail"thebboerwritteninitial


segmentisexactlyFIXED_HDR_SIZE 
+MIN_UPD_SIZE 
81wordslong. 


MIN_UPD_SIZE 
isatleast2,toallowforconscellsandlinkedindirections.Anothertruth:


GEN 
obllerjectsarewingamin-sizebiggerthanFIXED_HDR_SIZE 
slot. +MIN_UPD_SIZE 
+2;thatvesroomfor


aGEN 
folloalwysaclosurelea

Thatmeansthattheblackholeandupdatecodehaveawell-denedxed-sizethingtomodify.


AllsuchclosuresSET_GEN_FILLER( 
arethunks,ofeitherSPEC 
) 
orGEN 
form.Ifthelatter,thellerissetwith

IfthethellerclosureissetiswithofSPEC 
form,andthere(exclaremorexedthanhdr,ofMIN_UPD_SIZE 
course)..MIN_UPD_SIZE 
wordsofptrs.+non-ptrs,


where
wherewhereslop 
slopslopSET_SPEC_FILLER( 
tothe
thetheesize
sizesizeinof
ofofthe
thetheclosure
closureclosuresoNode, 
Node,Node,bslop 
slopslopMIN_UPD_SIZE 
used) 
buildingInthelabSPEC 
(Rememtheer,slopargumenclosuresis


guaranteedis
isisbanteger,can-ein.ael.case,bSPEC 
t

havthisnoariableatheader,endsothesizebasicjustcjust+non-ptrs,eforewhicishthe(orassigned).cancalculate.)But


Allevdonetheofisbloptrsk,bNode 
discardedcompiler

ifNode 
is
isisbeingloadedfromthe
thetheclosureitselfwehavetogoviaatemporary,soweneed:

Iftheone-spaceLOAD_NODE 
SET_GEN_FILLER_AND_LOAD_NODE( 
SET_SPEC_FILLER_AND_LOAD_NODE 
collectionvariantsisn'tstillbloadeingNode 
done,).these( 
llerNode, 
Node,Node,macrosfinal_node, 
final_node,final_node,generatenothingsize 
sizesize) 
) 
(exceptofcourse


A.4Pupdates

TheupIfdate-performing
erformingerformingecodoAllocate 
deesnb'tehatvinesthe 
aasmin-sizenew 
follows:object 
closurfrom 
eslot:the 
heap 


IfInThebaspaceemin-sizethe
thethegenerationalanSET_UPD_FILLER 
thing,new
newnewinteger.
closur
closurclosurclosureandGCemaktsinUPD_IND( 
UPD_INPLACE( 
if 
Fill 
theesnew-space,llsinincompletely 
UPD_INPLACE 
Upain 
indPtrmin-sizeUpdPtr[0...] 
an
&Hp[-xxx], 
ypupremainingoinUpdPtr, 
datesclosurtcofilled, 
tode82it.thecehecslot:
slop.HeapCheck_xxxLive 
HeapCheck_xxxLiveHeapCheck_xxxLiveold-genksuse 
forTheaSET_UPD_FILLER( 
old-genthingslop 
withargumenupdate,
) 
a) 
pointandisterUpdPtr, 
guaraniftosothealloteedslop 
catesnew-to) 



A.5Lambda-forminfo

Nowwearereadytosummarisethe(remarkablysubtle)questionsofenandupdatecon


venNopCanrectointions.dettojumptocoitdemustdi-ReenitIfcostY9,12)y=0eshas(notetrancenfvs;andtrest8)orusing(notear-UpNodatable6) Single-enIfcenYeshastresfvs(notetry 
trytryorusing9)cost-

PushupY
YY(note
(note(noteNo

frame date es
eses5)

Black(noteonNo 
NoNo Optional(notes2,3)ihasfvs(notes4)

entryhole7)

Useller(if1sNo UPD_BH_UPDATABLE 
Yes,unlessstatic(noteUPD_BH_SINGLE_ENTRY 
Ihasfvs(note10)


Note
NoteNotegc)cally1.2.W
WW.Hoe
eenevNOweverLONGERer,blacwek-holedoassume
assumeassumeanupdatablethat
thatthat11)SET_xxx_FILLER 
(HASanystaticclosureFVSclosure.implieswithInstead,noNOTfreedittovSTitariableswillATIC).beisovalloerwrittencatedstati-with


Note
NoteNoteamortemleaks.thestacOneareA4.3.CAFListsingle-ensimilarupkABlaccouldanddatesingle-enThek-holingonblactryarguetocelltricstactheotherk-holingkclosuretrypk.upoinmencanthatdateclosuretingunationedbwithspaceestacanvtooidabledoneywhicak.noinpleaksnewlyendingNotebfvshyspacehastheisfromallo3*nevupfreedogarbageleaks,
cateddatees);omittingesn'ter*varsbutblacblacwcollectorisorkandk-holed;wkthe*alwehole.fordon't;inniteblacays*them(bk-holeitywblaccannotrunningloebecauseopsblack-holed,fork-holedetectedgivsingle-endotheyewntorisethem.don'tathebvtrytooidyaaupthingssitspace 
spacespacepdateost-on


leak,op.andenetrustthat'sthetrue,tryupwhicstacshouldpmeanitwrevformtheofop.)

lo(Evwifnotsingle-entheagdatehkost-mortemouldcan'tealpartloa

Note
NoteNoteNoticeblacno-fvtoblac5.6.indirectk-holed.FkIforhole.closure.athatupclosuredatableviathisReason:theismeansupstaticclosuredatable,thatitclosures,matostaticygetNohadethe
thethevesingle-enmbusteneenup83trydatebupetrycomadedateddeframeclosuresantowithywwillpaoiny(whicap(btoinCAFecausetohtit,tohaindirection.vevtheiteennomighnewly-alloiffvs)itthaisareWvae
eestaticcatednevbhaeenvere 



updated),soitisnobigdealtoloadNodetoo.Intheorywecouldhaveadierent

CAFtime.indirectioncodeforeachCAF,which"knows"theclosureaddress,butitsavesno

whic7.8.TheFhorisreentode-mbtraneblacust-ptthingsk-holed.oint-to-itwitharitconditionsy>0,thereensureisstillthataNochoicedealwasatoyswhetherpointstotoajumpclosureto

the9.fastWhenorcost-censlowentrytrepproling,oint,depNoendingdemonusthopoinwmanttoyanargsythingthewhicthinghisn'tisappliedaHNFto.(even

ifithasno
nonofvs),sothatthecostcentrecanbeextractedfromtheclosure.

condition.10.Single-en(NBtryfvsclosuresimpliesonlynotstatic.)needalleriftheyhavebeenk-holed.Hencethe

Note
NoteNoteNoteNoteNoteNotecatedButstatically:whic11.12.hthatStaticThisforneedscouldthemrulethisuptodatablecan'tsaisbknoeysalreadyawthatproblemresultwhereclosuresNotheindethebstandardaecausedon'tdospaceclosureesn'tneedleaksucsize.needhis.bathingsecauseWller,toepsolvoinhatheybvecauseteetothisanareno-fvargumenbtheHNFsyalloclosuresblac
blacblaccatingalreadyt-satisfactionkholewithsucandfreshlyharitclosureshacyvhecallo-e>nok,0.


Impwithortednofvs;freenorthingsvars.canwhicitresulthweinknolosswnothingoflaziness.aboutareenteredasiftheywereupdatablethings


A.6Stackstubbing

Blacwhickhholingisnotcaughclosuresttherebisawy,aynamelytoavoidpoinspacetersleaks,onthebutstactherekwhicishanotherhappenimptobortanedead.tsourceFor


examplef 
x 
. 
case 
x 
of 
...not 
involving 
x... 


Herex 
ispassedtof 
onthestack,butisdeadassoonasitisentered.

ThesimplestJustpitTheoinplugsterenbeforetrysolutiontoanyacoevspacespdeeryecialforis:tailleak.Stub 
StubStubcall,elicitsclosure.overwriteanStub 
erroranismessage,yastacstatick-heldbclosureecauseptrswiththewhicstachnoarekpoinslotnoterswisdeadsuppinsideosedwithit,sotoa


inthebedead.etinwv

Howdoconwknouation.whichslotsaredead?Becausetheyareboundtoariableswhicharen'tfree


Unfortunately,thisstactakinstructions84toperform.Wcanvematters


somewhat: k-stubbingeseimpro


Therebit-maskUsethisisonedeadmeanreturnwaystacthatof(vakvector)fewslotsoidingertoslotsaddressesthesavremainingneedevolatilepushedtobestacvstubbariablesonk-stubbingtheed,Binbutstacforinstructions,k,aalsocase 
whicreduceshexpression.idennamelytifystacthekgroNotbdeadywth.attaconlyA-stachingdoeska


poinstubbingThisisquiteabitwexecute.wsoedon'tdoit
ititatt|butetw


manters.yinstructionsmoreeork,wpresenwcounho


Weneedslots,to
totokeepatextratailwheninformationtovingintifyolatilethecodeariableswhicgeneratormabstate:expression),idendead


A.6.11.WwhicThiseImplemenneedhinfoandslotstoisareusedkaeeptationusedtraccalltoksaofstorewhicidenwhicvhA-stachslotsvariables.vkslotshare(atustusedcase 
estubbforwhated.purpose;toinparticular,tify
The2.scWenWhenconcanriedThisset-llerthehemeevironmentinf 
casecanbaroundiseuationx 
socompilingstubbeasydo
. 
stu.brfaranchescase 
let 
t.thistobed.is(ifyo:Theslighthey 
justanx 
justarather. 
y)dierenceof 
tailmonad,
tly... 
baddsoypcalladdingessimistic.thatthanin 
apieceandwisaneinthatneedtoanymakingofotherstheextraConsiderinheritedattoscrutineaknosurecase 
ocompccupwthewinformationewhiconenexpressionyinge.kexpresioneephtstactovitariables,ktheupthetoslotstocotheneeded-vdedatebifmonadelogeneratoranwwhenyartheareratherinfowtail-callusedestate,goalterlikesineincar-SpA 
thethe 
thetheto


ThecodeAllocate 
Save 
Push 
Enter 
generatedy 
the 
x 
on 
...y... 
fory 
continuation 
the 
thisstack 
is:

Nohacanvw,esptosinceotstubthisx 
theisasstillax 
spslotlivecialejustatcase,thebeforeppoinerhapsentwteringeincludingsavex 
.y 
,Itwwetheouldwillslighallobetlycatebettermoreatonewgeneralsastacvey 
kincaseslotx 
'sforwhereslot.y 
,andWthee


scrutineeisafunctionapplication. 

85 



Index

hA-stac;Gimac-mack,5,15 direct-entering,,ept,56

ABC51hine,
hine,hine,14,14 Enter33tryseclosures

Abstractaddress,C,frame,455231 Evalacuation,vironmen33pter,

activation32,8,15,en
enen,t47oin
oinoin10

algebraicallocation,t
ttdatastac58k,yp5029ck,58,ev
eveveval-applyaluationseemothk,15,1431

argumen
argumenargumensatisfactiont32,e,hec38,66forcing,stacdel,unks

arithmetic,blackholes,k,28,12,64 freeforwframe,frameardingvpoinp2244ter,48

B-stac5159 ariables,10ter,oin

built-incac15op7352 laziness,application,v9,14,31,34,55


CAFhe,list,eration,fullfunction
functionfunctionalues,2710

call/cc 
,G-maccollection,garbage

CAFs,expression,731516 garbagegenerationalhine,1447,collection,7215,49


case 
casecaseclosure,moexpressions,mo111219 globals,graphen29,14t,53,

cellclosuredel,9de,globalreduction,21,vironmen47,3373

closures,enstatic,tering,12,47,32,10,484545,55 Haskheadheap,ell,normal327forms,9

continde,p33tter,38eseCAFs indirection,indirections,oeroc70k,

co
cococonstandeuation,oinapplicativ10form,eheapvw1246,hec58

constructors,niladic,standard,3316,26,2452,53 initialinput/output,info
infoinfotable,poinstate,ter,45,34,4550,745352

CoreCPS,tin
tintinlanguage,21,uation,uation-passing608yle,einsmall,dalifting,21,

con
concon30stseCPS tegers4827

currying,structures,14,3116 lam
lamlamlaziness,calb
bbda-form,environmen1121t,33

debugging,alues,45 lo
loloyving,

data
datadatav9 86calitsa,1561 


lo
lolocally-denecals,,21,2134dfunctions,56 stateSTGtransitionag,118,system,1932

main 
statuslanguage,

manifestmonads,74functions,21 supsuspde,binator,analysis,927

non-updatable,24 strictnessT-coercomension,78

normal
normalnormalsemande,tagless,41

operationalforms,return9cotics,6932 tagthreads,targetbig,language,125115

paging,PAP_Info 
partial15execution,671324,67 thforcing,Instruction9,24ting,16Machine,e

parallelapplications,,40,Threeunks,represen11,11seTIM


primitiv
primitivprimitivpatternpointer,e
eematc45datavalues,hing,typ37e,16,2919,60 TIM,ununiformboxed10,represenv14alues,8,tation,2812

proling,\queue74mo13,14 datable,reensingle-enframe,trant,20,38,81,59,68

push-enterme", del,60 ag,21,try60236065,

reduction,registerreentranaddress,sat,8111es,4462 UpdatePAP 
up
upupupupupupdates,date
datedatedatedatestacreturn11,,k,6612,38,co23,de,503869

return
returnreturnreturnreturneturnConstacconvector,v
vvk,,en36,tion,63365017,63 alues,inplace,9,return,327163,68

R
RRscaeturnIntvmac,hine,33,
33,33,4836,37,64 v
vvvectored
ectoredectoredreturns,

SECDenging,14 17

self-upsecond-ordersequences,try81lammodel,da1174

single-endating32,bcalculus,

spacestac
stacstacstacstack
kkkks,obasestubbing,leak,v50eroregisters,10,wc59,hec6161k,6658

standardstandard-enconstructors,trycode,45,see58constructors 87 


